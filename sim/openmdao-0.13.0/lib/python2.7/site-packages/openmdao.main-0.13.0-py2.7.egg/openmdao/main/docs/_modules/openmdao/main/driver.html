<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>openmdao.main.driver &mdash; OpenMDAO Documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.13.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="OpenMDAO Documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../../index.html">OpenMDAO Documentation v0.13.0</a> &raquo;</li>

          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for openmdao.main.driver</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot; Driver class definition &quot;&quot;&quot;</span>

<span class="c">#public symbols</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;Driver&quot;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">isnan</span>

<span class="c"># pylint: disable=E0611,F0401</span>

<span class="kn">from</span> <span class="nn">networkx.algorithms.components</span> <span class="kn">import</span> <span class="n">strongly_connected_components</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="kn">as</span> <span class="nn">nx</span>

<span class="kn">from</span> <span class="nn">openmdao.main.mpiwrap</span> <span class="kn">import</span> <span class="n">PETSc</span>
<span class="kn">from</span> <span class="nn">openmdao.main.component</span> <span class="kn">import</span> <span class="n">Component</span>
<span class="kn">from</span> <span class="nn">openmdao.main.datatypes.api</span> <span class="kn">import</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">Slot</span><span class="p">,</span> \
                                        <span class="n">List</span><span class="p">,</span> <span class="n">VarTree</span>
<span class="kn">from</span> <span class="nn">openmdao.main.depgraph</span> <span class="kn">import</span> <span class="n">find_all_connecting</span><span class="p">,</span> \
                                   <span class="n">collapse_driver</span><span class="p">,</span> <span class="n">gsort</span>
<span class="kn">from</span> <span class="nn">openmdao.main.hasconstraints</span> <span class="kn">import</span> <span class="n">HasConstraints</span><span class="p">,</span> <span class="n">HasEqConstraints</span><span class="p">,</span> \
                                         <span class="n">HasIneqConstraints</span>
<span class="kn">from</span> <span class="nn">openmdao.main.hasevents</span> <span class="kn">import</span> <span class="n">HasEvents</span>
<span class="kn">from</span> <span class="nn">openmdao.main.hasobjective</span> <span class="kn">import</span> <span class="n">HasObjective</span><span class="p">,</span> <span class="n">HasObjectives</span>
<span class="kn">from</span> <span class="nn">openmdao.main.hasparameters</span> <span class="kn">import</span> <span class="n">HasParameters</span>
<span class="kn">from</span> <span class="nn">openmdao.main.hasresponses</span> <span class="kn">import</span> <span class="n">HasResponses</span>
<span class="kn">from</span> <span class="nn">openmdao.main.interfaces</span> <span class="kn">import</span> <span class="n">IDriver</span><span class="p">,</span> <span class="n">IHasEvents</span><span class="p">,</span> <span class="n">ISolver</span><span class="p">,</span> \
                                     <span class="n">implements</span>
<span class="kn">from</span> <span class="nn">openmdao.main.mp_support</span> <span class="kn">import</span> <span class="n">has_interface</span>
<span class="kn">from</span> <span class="nn">openmdao.main.rbac</span> <span class="kn">import</span> <span class="n">rbac</span>
<span class="kn">from</span> <span class="nn">openmdao.main.vartree</span> <span class="kn">import</span> <span class="n">VariableTree</span>
<span class="kn">from</span> <span class="nn">openmdao.main.workflow</span> <span class="kn">import</span> <span class="n">Workflow</span><span class="p">,</span> <span class="n">get_cycle_vars</span>
<span class="kn">from</span> <span class="nn">openmdao.main.case</span> <span class="kn">import</span> <span class="n">Case</span>

<span class="kn">from</span> <span class="nn">openmdao.util.decorators</span> <span class="kn">import</span> <span class="n">add_delegate</span>


<span class="k">class</span> <span class="nc">GradientOptions</span><span class="p">(</span><span class="n">VariableTree</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Options for calculation of the gradient by the driver&#39;s workflow. &#39;&#39;&#39;</span>

    <span class="c"># Finite Difference</span>
    <span class="n">fd_form</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span><span class="s">&#39;forward&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;forward&#39;</span><span class="p">,</span> <span class="s">&#39;backward&#39;</span><span class="p">,</span> <span class="s">&#39;central&#39;</span><span class="p">,</span> <span class="s">&#39;complex_step&#39;</span><span class="p">],</span>
                   <span class="n">desc</span><span class="o">=</span><span class="s">&quot;Finite difference mode. (forward, backward, central) &quot;</span>
                   <span class="s">&quot;You can also set to &#39;complex_step&#39; to peform the complex &quot;</span>
                   <span class="s">&quot;step method if your components support it.&quot;</span><span class="p">,</span>
                   <span class="n">framework_var</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">fd_step</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Default finite difference stepsize&#39;</span><span class="p">,</span>
                    <span class="n">framework_var</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">fd_step_type</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span><span class="s">&#39;absolute&#39;</span><span class="p">,</span>
                        <span class="p">[</span><span class="s">&#39;absolute&#39;</span><span class="p">,</span> <span class="s">&#39;relative&#39;</span><span class="p">,</span> <span class="s">&#39;bounds_scaled&#39;</span><span class="p">],</span>
                        <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Set to absolute, relative, &#39;</span>
                        <span class="s">&#39;or scaled to the bounds (high-low) step sizes&#39;</span><span class="p">,</span>
                        <span class="n">framework_var</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">force_fd</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;Set to True to force finite difference &quot;</span>
                                <span class="s">&quot;of this driver&#39;s entire workflow in a&quot;</span>
                                <span class="s">&quot;single block.&quot;</span><span class="p">,</span>
                           <span class="n">framework_var</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">directional_fd</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;Set to True to do a directional &quot;</span>
                                       <span class="s">&quot;finite difference for each GMRES &quot;</span>
                                       <span class="s">&quot;iteration instead of pre-computing &quot;</span>
                                       <span class="s">&quot;the full fd space.&quot;</span><span class="p">,</span>
                                       <span class="n">framework_var</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">derivative_direction</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span><span class="s">&#39;auto&#39;</span><span class="p">,</span>
                                <span class="p">[</span><span class="s">&#39;auto&#39;</span><span class="p">,</span> <span class="s">&#39;forward&#39;</span><span class="p">,</span> <span class="s">&#39;adjoint&#39;</span><span class="p">],</span>
                                <span class="n">desc</span><span class="o">=</span><span class="s">&quot;Direction for derivative calculation. &quot;</span>
                                <span class="s">&quot;Can be &#39;forward&#39;, &#39;adjoint&#39;, or &#39;auto&#39;. &quot;</span>
                                <span class="s">&quot;&#39;auto&#39; is the default setting. &quot;</span>
                                <span class="s">&quot;When set to auto, OpenMDAO automatically &quot;</span>
                                <span class="s">&quot;figures out the best direction based on the &quot;</span>
                                <span class="s">&quot;number of parameters and responses. &quot;</span>
                                <span class="s">&quot;When the number of parameters and responses &quot;</span>
                                <span class="s">&quot;are equal, then forward direction is used.&quot;</span><span class="p">,</span>
                                <span class="n">framework_var</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c">#fd_blocks = List([], desc=&#39;User can specify nondifferentiable blocks &#39;</span>
    <span class="c">#                          &#39;by adding sets of component names.&#39;,</span>
    <span class="c">#                          framework_var=True)</span>

    <span class="c"># Linear Solver settings</span>
    <span class="n">lin_solver</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span><span class="s">&#39;scipy_gmres&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;scipy_gmres&#39;</span><span class="p">,</span> <span class="s">&#39;petsc_ksp&#39;</span><span class="p">,</span> <span class="s">&#39;linear_gs&#39;</span><span class="p">],</span>
                      <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Method to use for gradient calculation&#39;</span><span class="p">,</span>
                      <span class="n">framework_var</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">atol</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">1.0e-9</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Absolute tolerance for the linear solver.&#39;</span><span class="p">,</span>
                 <span class="n">framework_var</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">rtol</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">1.0e-9</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Relative tolerance for the linear solver. &#39;</span>
                               <span class="s">&#39;(Not supported by scipy.gmres)&#39;</span><span class="p">,</span>
                               <span class="n">framework_var</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">maxiter</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Maximum number of iterations for the linear solver.&#39;</span><span class="p">,</span>
                  <span class="n">framework_var</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">iprint</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">desc</span><span class="o">=</span><span class="s">&quot;Set to 1 to print out residual of the linear solver&quot;</span><span class="p">,</span>
                  <span class="n">framework_var</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_lin_solver_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oldls</span><span class="p">,</span> <span class="n">newls</span><span class="p">):</span>
        <span class="c"># if PETSc has been imported prior to the creation of a remote object using</span>
        <span class="c"># the multiprocessing package, we get errors due to broken socket connections</span>
        <span class="c"># from PETSc, so use this flag to prevent PETSc from being imported unless it&#39;s</span>
        <span class="c"># actually used.</span>
        <span class="k">if</span> <span class="n">newls</span> <span class="o">==</span> <span class="s">&#39;petsc_ksp&#39;</span><span class="p">:</span>
            <span class="n">PETSc</span><span class="o">.</span><span class="n">needs_ksp</span> <span class="o">=</span> <span class="bp">True</span>


<span class="nd">@add_delegate</span><span class="p">(</span><span class="n">HasEvents</span><span class="p">)</span>
<div class="viewcode-block" id="Driver"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver">[docs]</a><span class="k">class</span> <span class="nc">Driver</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A Driver iterates over a workflow of Components until some condition</span>
<span class="sd">    is met. &quot;&quot;&quot;</span>

    <span class="n">implements</span><span class="p">(</span><span class="n">IDriver</span><span class="p">,</span> <span class="n">IHasEvents</span><span class="p">)</span>

    <span class="c"># set factory here so we see a default value in the docs, even</span>
    <span class="c"># though we replace it with a new Workflow in __init__</span>
    <span class="n">workflow</span> <span class="o">=</span> <span class="n">Slot</span><span class="p">(</span><span class="n">Workflow</span><span class="p">,</span> <span class="n">allow_none</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">factory</span><span class="o">=</span><span class="n">Workflow</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">gradient_options</span> <span class="o">=</span> <span class="n">VarTree</span><span class="p">(</span><span class="n">GradientOptions</span><span class="p">(),</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span>
                               <span class="n">framework_var</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># flag to determine partitioning of our workflow&#39;s System</span>
    <span class="n">system_type</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span><span class="s">&#39;auto&#39;</span><span class="p">,</span>
                       <span class="p">[</span><span class="s">&#39;auto&#39;</span><span class="p">,</span> <span class="s">&#39;serial&#39;</span><span class="p">,</span> <span class="s">&#39;parallel&#39;</span><span class="p">],</span>
                       <span class="n">desc</span><span class="o">=</span><span class="s">&quot;Determines the partitioning of this driver&#39;s &quot;</span>
                            <span class="s">&quot;workflow components into Systems. Default is &quot;</span>
                            <span class="s">&quot;&#39;auto&#39;, where a hierarchy of serial and parallel &quot;</span>
                            <span class="s">&quot;systems is automatically determined. &#39;serial&#39; &quot;</span>
                            <span class="s">&quot;and &#39;parallel&#39; may be specified to force the&quot;</span>
                            <span class="s">&quot;workflow components into a single serial or &quot;</span>
                            <span class="s">&quot;parallel System.  Note that when not running &quot;</span>
                            <span class="s">&quot;under MPI, this option is ignored and the &quot;</span>
                            <span class="s">&quot;resulting System will always be serial.&quot;</span><span class="p">,</span>
                       <span class="n">framework_var</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_required_compnames</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reduced_graph</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter_set</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_full_iter_set</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># clean up unwanted trait from Component</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_trait</span><span class="p">(</span><span class="s">&#39;missing_deriv_policy&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For some reason `missing_deriv_policy` gets resurrected.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__deepcopy__</span><span class="p">(</span><span class="n">memo</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">remove_trait</span><span class="p">(</span><span class="s">&#39;missing_deriv_policy&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_workflow_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oldwf</span><span class="p">,</span> <span class="n">newwf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;callback when new workflow is slotted&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">newwf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">newwf</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span>

<div class="viewcode-block" id="Driver.requires_derivs"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.requires_derivs">[docs]</a>    <span class="k">def</span> <span class="nf">requires_derivs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="Driver.get_expr_scope"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.get_expr_scope">[docs]</a>    <span class="k">def</span> <span class="nf">get_expr_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the scope to be used to evaluate ExprEvaluators.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>
</div>
    <span class="k">def</span> <span class="nf">_collapse_subdrivers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;collapse subdriver iteration sets into single nodes.&quot;&quot;&quot;</span>
        <span class="c"># collapse all subdrivers in our graph</span>
        <span class="n">itercomps</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">child_drv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdrivers</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
            <span class="n">itercomps</span><span class="p">[</span><span class="n">child_drv</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">child_drv</span><span class="o">.</span><span class="n">iteration_set</span><span class="p">()]</span>

        <span class="k">for</span> <span class="n">child_drv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdrivers</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
            <span class="n">excludes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter_set</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">comps</span> <span class="ow">in</span> <span class="n">itercomps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">child_drv</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">cname</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">cname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">itercomps</span><span class="p">[</span><span class="n">child_drv</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span>
                            <span class="n">excludes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cname</span><span class="p">)</span>

            <span class="n">collapse_driver</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">child_drv</span><span class="p">,</span> <span class="n">excludes</span><span class="p">)</span>

        <span class="c"># now remove any comps that are shared by subdrivers but are not found</span>
        <span class="c"># in our workflow</span>
        <span class="n">to_remove</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">comps</span> <span class="ow">in</span> <span class="n">itercomps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">comp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_set</span><span class="p">:</span>
                    <span class="n">to_remove</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

        <span class="n">g</span><span class="o">.</span><span class="n">remove_nodes_from</span><span class="p">(</span><span class="n">to_remove</span><span class="p">)</span>

<div class="viewcode-block" id="Driver.get_reduced_graph"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.get_reduced_graph">[docs]</a>    <span class="k">def</span> <span class="nf">get_reduced_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reduced_graph</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">parent_graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_reduced_graph</span>

            <span class="c"># copy parent graph</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">parent_graph</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">parent_graph</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">())</span>

            <span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">])</span>
            <span class="n">g</span><span class="o">.</span><span class="n">collapse_subdrivers</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">subdrivers</span><span class="p">())</span>

            <span class="n">nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="n">g</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">full_subgraph</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

            <span class="n">nodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="c"># create fake edges to/from the driver and each of its</span>
            <span class="c"># components so we can get everything that&#39;s relevant</span>
            <span class="c"># by getting all nodes that are strongly connected to the</span>
            <span class="c"># driver in the graph.</span>
            <span class="n">to_add</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                    <span class="n">to_add</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                    <span class="n">to_add</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">to_add</span><span class="p">)</span>
            <span class="n">comps</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">comps</span> <span class="ow">in</span> <span class="n">strongly_connected_components</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">g</span><span class="o">.</span><span class="n">remove_edges_from</span><span class="p">(</span><span class="n">to_add</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reduced_graph</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">comps</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reduced_graph</span>
</div>
<div class="viewcode-block" id="Driver.check_config"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.check_config">[docs]</a>    <span class="k">def</span> <span class="nf">check_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="c"># duplicate entries in the workflow are not allowed</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_explicit_names</span>
        <span class="n">dups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">names</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dups</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> workflow has duplicate entries: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pathname</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">dups</span><span class="p">)))</span>

        <span class="c"># workflow will raise an exception if it can&#39;t resolve a Component</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">check_config</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">check_config</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">)</span>
</div>
    <span class="nd">@rbac</span><span class="p">((</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="Driver.get_itername"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.get_itername">[docs]</a>    <span class="k">def</span> <span class="nf">get_itername</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return current &#39;iteration coordinates&#39;.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_top_driver</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_itername</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">itername</span>
</div>
<div class="viewcode-block" id="Driver.compute_itersets"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.compute_itersets">[docs]</a>    <span class="k">def</span> <span class="nf">compute_itersets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cgraph</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of all components required to run a full</span>
<span class="sd">        iteration of this driver.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_full_iter_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">comps</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_explicit_names</span><span class="p">]</span>
        <span class="n">subdrivers</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span> <span class="k">if</span> <span class="n">has_interface</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">IDriver</span><span class="p">)]</span>
        <span class="n">subnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">subdrivers</span><span class="p">]</span>

        <span class="n">allcomps</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cgraph</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="n">alldrivers</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">allcomps</span> <span class="k">if</span> <span class="n">has_interface</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">IDriver</span><span class="p">)]</span>

        <span class="c"># make our own copy of the graph to play with</span>
        <span class="n">cgraph</span> <span class="o">=</span> <span class="n">cgraph</span><span class="o">.</span><span class="n">subgraph</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cgraph</span>
                                <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">alldrivers</span> <span class="ow">or</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">subnames</span><span class="p">])</span>

        <span class="n">myset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_explicit_names</span> <span class="o">+</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">list_pseudocomps</span><span class="p">())</span>

        <span class="c"># First, have all of our subdrivers (recursively) determine</span>
        <span class="c"># their iteration sets, because we need those to determine</span>
        <span class="c"># our full set.</span>
        <span class="n">subcomps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">subdrivers</span><span class="p">:</span>
            <span class="n">cgcopy</span> <span class="o">=</span> <span class="n">cgraph</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">cgraph</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">())</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">compute_itersets</span><span class="p">(</span><span class="n">cgcopy</span><span class="p">)</span>
            <span class="n">subcomps</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">_full_iter_set</span><span class="p">)</span>

        <span class="c"># create fake edges to/from the driver and each of its</span>
        <span class="c"># components so we can get everything that&#39;s relevant</span>
        <span class="c"># by getting all nodes that are strongly connected to the</span>
        <span class="c"># driver in the graph.</span>
        <span class="k">for</span> <span class="n">drv</span> <span class="ow">in</span> <span class="n">subdrivers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">drv</span><span class="o">.</span><span class="n">_full_iter_set</span><span class="p">:</span>
                <span class="n">cgraph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">drv</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">cgraph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">drv</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c"># add predecessors to my pseudocomps if they aren&#39;t</span>
        <span class="c"># already in the itersets of my subdrivers</span>
        <span class="k">for</span> <span class="n">pcomp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_pseudocomps</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">cgraph</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">pcomp</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pred</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">subcomps</span><span class="p">:</span>
                    <span class="n">myset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>

        <span class="c"># now create fake edges from us to all of the comps</span>
        <span class="c"># that we know about in our iterset</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">myset</span><span class="p">:</span>
            <span class="n">cgraph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">cgraph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c"># collapse our explicit subdrivers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_explicit_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collapse_subdrivers</span><span class="p">(</span><span class="n">cgraph</span><span class="p">)</span>

        <span class="n">comps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">comps</span> <span class="ow">in</span> <span class="n">strongly_connected_components</span><span class="p">(</span><span class="n">cgraph</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_iter_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">comps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter_set</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c"># the following fixes a test failure when using DOEdriver with</span>
        <span class="c"># an empty workflow.  This adds any comps that own DOEdriver</span>
        <span class="c"># parameters to the DOEdriver&#39;s iteration set.</span>
        <span class="n">conns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_expr_depends</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter_set</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">conns</span> <span class="k">if</span> <span class="n">u</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">u</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">subcomps</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter_set</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">conns</span> <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">subcomps</span><span class="p">])</span>

        <span class="n">old_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_set</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c"># remove any drivers that were not explicitly specified in our worklow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_set</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">alldrivers</span>
                                <span class="ow">or</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">subnames</span><span class="p">])</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="n">old_iter</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_set</span>
        <span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Driver &#39;</span><span class="si">%s</span><span class="s">&#39; had the following subdrivers removed&quot;</span>
                                 <span class="s">&quot; from its workflow because they were not explicity&quot;</span>
                                 <span class="s">&quot; added: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">diff</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_full_iter_set</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter_set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_full_iter_set</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">subcomps</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Driver.compute_ordering"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.compute_ordering">[docs]</a>    <span class="k">def</span> <span class="nf">compute_ordering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cgraph</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given a component graph, each driver can determine its iteration</span>
<span class="sd">        set and the ordering of its workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cgraph</span> <span class="o">=</span> <span class="n">cgraph</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_full_iter_set</span><span class="p">)</span>

        <span class="c"># call compute_ordering on all subdrivers</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_set</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">has_interface</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">IDriver</span><span class="p">):</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">compute_ordering</span><span class="p">(</span><span class="n">cgraph</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_collapse_subdrivers</span><span class="p">(</span><span class="n">cgraph</span><span class="p">)</span>

        <span class="c"># now figure out the order of our iter_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ordering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_explicit_names</span> <span class="o">+</span> \
                         <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_set</span>
                           <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_explicit_names</span><span class="p">]</span>

        <span class="c"># remove any nodes that got collapsed into subdrivers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ordering</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ordering</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cgraph</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ordering</span> <span class="o">=</span> <span class="n">gsort</span><span class="p">(</span><span class="n">cgraph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ordering</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_ordering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ordering</span>
</div>
<div class="viewcode-block" id="Driver.iteration_set"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.iteration_set">[docs]</a>    <span class="k">def</span> <span class="nf">iteration_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a set of all Components in our workflow and</span>
<span class="sd">        recursively in any workflow in any Driver in our workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_full_iter_set</span><span class="p">])</span>
</div>
    <span class="nd">@rbac</span><span class="p">((</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="Driver.get_expr_depends"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.get_expr_depends">[docs]</a>    <span class="k">def</span> <span class="nf">get_expr_depends</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of tuples of the form (src_comp_name,</span>
<span class="sd">        dest_comp_name) for each dependency introduced by any ExprEvaluators</span>
<span class="sd">        in this Driver, ignoring any dependencies on components that are</span>
<span class="sd">        inside of this Driver&#39;s iteration set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iternames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_set</span><span class="p">()])</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_expr_depends</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">src</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">iternames</span> <span class="ow">and</span> <span class="n">dest</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">iternames</span><span class="p">:</span>
                <span class="n">deps</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>
</div>
    <span class="nd">@rbac</span><span class="p">((</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="Driver.get_expr_var_depends"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.get_expr_var_depends">[docs]</a>    <span class="k">def</span> <span class="nf">get_expr_var_depends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a tuple of sets of the form (src_set, dest_set)</span>
<span class="sd">        containing all dependencies introduced by any parameters,</span>
<span class="sd">        objectives, or constraints in this Driver.  If recurse is True,</span>
<span class="sd">        include any refs from subdrivers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">srcset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">destset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_delegates_&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegates_</span><span class="p">:</span>
                <span class="n">delegate</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dname</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">delegate</span><span class="p">,</span> <span class="n">HasParameters</span><span class="p">):</span>
                    <span class="n">destset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">delegate</span><span class="o">.</span><span class="n">get_referenced_varpaths</span><span class="p">(</span><span class="n">refs</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">delegate</span><span class="p">,</span> <span class="p">(</span><span class="n">HasConstraints</span><span class="p">,</span>
                                     <span class="n">HasEqConstraints</span><span class="p">,</span> <span class="n">HasIneqConstraints</span><span class="p">)):</span>
                    <span class="n">srcset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">delegate</span><span class="o">.</span><span class="n">list_constraint_targets</span><span class="p">())</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">delegate</span><span class="p">,</span>
                                 <span class="p">(</span><span class="n">HasObjective</span><span class="p">,</span> <span class="n">HasObjectives</span><span class="p">)):</span>
                    <span class="n">srcset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">delegate</span><span class="o">.</span><span class="n">list_objective_targets</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">recurse</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdrivers</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                    <span class="n">srcs</span><span class="p">,</span> <span class="n">dests</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">get_expr_var_depends</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">srcset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">srcs</span><span class="p">)</span>
                    <span class="n">destset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dests</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">srcset</span><span class="p">,</span> <span class="n">destset</span>
</div>
    <span class="nd">@rbac</span><span class="p">((</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="Driver.subdrivers"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.subdrivers">[docs]</a>    <span class="k">def</span> <span class="nf">subdrivers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a generator of all subdrivers</span>
<span class="sd">        contained in this driver&#39;s workflow.  If recurse is True,</span>
<span class="sd">        include all subdrivers in our entire iteration set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">recurse</span><span class="p">:</span>
            <span class="n">itercomps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_set</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">itercomps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_set</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">itercomps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">has_interface</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">IDriver</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">comp</span>
</div>
    <span class="k">def</span> <span class="nf">_get_required_compnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a set of names of components that are required by</span>
<span class="sd">        this Driver in order to evaluate parameters, objectives</span>
<span class="sd">        and constraints.  This list will include any intermediate</span>
<span class="sd">        components in the data flow between components referenced by</span>
<span class="sd">        parameters and those referenced by objectives and/or constraints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required_compnames</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># call base class version of get_expr_depends so we don&#39;t filter out</span>
            <span class="c"># comps in our iterset.  We want required names to be everything between</span>
            <span class="c"># and including comps that we reference in any parameter, objective, or</span>
            <span class="c"># constraint.</span>
            <span class="n">conns</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_expr_depends</span><span class="p">()</span>

            <span class="n">getcomps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">conns</span> <span class="k">if</span> <span class="n">u</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
            <span class="n">setcomps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">conns</span> <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>

            <span class="n">full</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">setcomps</span><span class="p">)</span>
            <span class="n">full</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">getcomps</span><span class="p">)</span>
            <span class="n">full</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_pseudocomps</span><span class="p">())</span>

            <span class="n">compgraph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_depgraph</span><span class="o">.</span><span class="n">component_graph</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">getcomps</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="n">setcomps</span><span class="p">:</span>
                    <span class="n">full</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">find_all_connecting</span><span class="p">(</span><span class="n">compgraph</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">full</span><span class="p">:</span>
                <span class="n">full</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_required_compnames</span> <span class="o">=</span> <span class="n">full</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required_compnames</span>

    <span class="nd">@rbac</span><span class="p">((</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="Driver.list_pseudocomps"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.list_pseudocomps">[docs]</a>    <span class="k">def</span> <span class="nf">list_pseudocomps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of names of pseudocomps resulting from</span>
<span class="sd">        our objectives, and constraints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pcomps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_delegates_&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegates_</span><span class="p">:</span>
                <span class="n">delegate</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">delegate</span><span class="p">,</span> <span class="s">&#39;list_pseudocomps&#39;</span><span class="p">):</span>
                    <span class="n">pcomps</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">delegate</span><span class="o">.</span><span class="n">list_pseudocomps</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">pcomps</span>
</div>
<div class="viewcode-block" id="Driver.name_changed"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.name_changed">[docs]</a>    <span class="k">def</span> <span class="nf">name_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change any workflows or delegates that reference the old</span>
<span class="sd">        name of an object that has now been changed to a new name.</span>

<span class="sd">        old: string</span>
<span class="sd">            Original name of the object</span>

<span class="sd">        new: string</span>
<span class="sd">            New name of the object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># alert any delegates of the name change</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_delegates_&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegates_</span><span class="p">:</span>
                <span class="n">inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dname</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="p">(</span><span class="n">HasParameters</span><span class="p">,</span> <span class="n">HasConstraints</span><span class="p">,</span>
                                     <span class="n">HasEqConstraints</span><span class="p">,</span> <span class="n">HasIneqConstraints</span><span class="p">,</span>
                                     <span class="n">HasObjective</span><span class="p">,</span> <span class="n">HasObjectives</span><span class="p">,</span> <span class="n">HasResponses</span><span class="p">)):</span>
                    <span class="n">inst</span><span class="o">.</span><span class="n">name_changed</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>

        <span class="c"># update our workflow</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_explicit_names</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">old</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_explicit_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>

        <span class="c"># force update of workflow full names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">config_changed</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Driver.get_references"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.get_references">[docs]</a>    <span class="k">def</span> <span class="nf">get_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a dict of parameter, constraint, and objective</span>
<span class="sd">        references to component `name` in preparation for</span>
<span class="sd">        subsequent :meth:`restore_references` call.</span>

<span class="sd">        name: string</span>
<span class="sd">            Name of component being referenced.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_delegates_&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegates_</span><span class="p">:</span>
                <span class="n">inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dname</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="p">(</span><span class="n">HasParameters</span><span class="p">,</span> <span class="n">HasConstraints</span><span class="p">,</span>
                                     <span class="n">HasEqConstraints</span><span class="p">,</span> <span class="n">HasIneqConstraints</span><span class="p">,</span>
                                     <span class="n">HasObjective</span><span class="p">,</span> <span class="n">HasObjectives</span><span class="p">,</span> <span class="n">HasResponses</span><span class="p">)):</span>
                    <span class="n">refs</span><span class="p">[</span><span class="n">inst</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">get_references</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">refs</span>
</div>
<div class="viewcode-block" id="Driver.remove_references"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.remove_references">[docs]</a>    <span class="k">def</span> <span class="nf">remove_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove parameter, constraint, objective  and workflow</span>
<span class="sd">        references to component `name`.</span>

<span class="sd">        name: string</span>
<span class="sd">            Name of component being removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_delegates_&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegates_</span><span class="p">:</span>
                <span class="n">inst</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dname</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="p">(</span><span class="n">HasParameters</span><span class="p">,</span> <span class="n">HasConstraints</span><span class="p">,</span>
                                     <span class="n">HasEqConstraints</span><span class="p">,</span> <span class="n">HasIneqConstraints</span><span class="p">,</span>
                                     <span class="n">HasObjective</span><span class="p">,</span> <span class="n">HasObjectives</span><span class="p">,</span> <span class="n">HasResponses</span><span class="p">)):</span>
                    <span class="n">inst</span><span class="o">.</span><span class="n">remove_references</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Driver.restore_references"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.restore_references">[docs]</a>    <span class="k">def</span> <span class="nf">restore_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restore parameter, constraint, and objective references to component</span>
<span class="sd">        `name` from `refs`.</span>

<span class="sd">        refs: object</span>
<span class="sd">            Value returned by :meth:`get_references`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">inst</span><span class="p">,</span> <span class="n">inst_refs</span> <span class="ow">in</span> <span class="n">refs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">inst</span><span class="o">.</span><span class="n">restore_references</span><span class="p">(</span><span class="n">inst_refs</span><span class="p">)</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="s">&#39;owner&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="Driver.run"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">case_uuid</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run this object. This should include fetching input variables if</span>
<span class="sd">        necessary, executing, and updating output variables. Do not override</span>
<span class="sd">        this function.</span>

<span class="sd">        force: bool</span>
<span class="sd">            If True, force component to execute even if inputs have not</span>
<span class="sd">            changed. (Default is False)</span>

<span class="sd">        case_uuid: str</span>
<span class="sd">            Identifier for the Case that is associated with this run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># (Re)configure parameters.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;config_parameters&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_parameters</span><span class="p">()</span>

        <span class="c"># force param pseudocomps to get updated values to start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">()</span>

        <span class="c"># Reset the workflow.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">case_uuid</span><span class="p">)</span>
</div>
    <span class="nd">@rbac</span><span class="p">((</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="Driver.configure_recording"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.configure_recording">[docs]</a>    <span class="k">def</span> <span class="nf">configure_recording</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recording_options</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called at start of top-level run to configure case recording.</span>
<span class="sd">        Returns set of paths for changing inputs.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">configure_recording</span><span class="p">(</span><span class="n">recording_options</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Driver.update_parameters"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.update_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">update_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;get_parameters&#39;</span><span class="p">):</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">param</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_expr_scope</span><span class="p">(),</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;u&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_system</span><span class="o">.</span><span class="n">vec</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_system</span><span class="o">.</span><span class="n">vec</span><span class="p">[</span><span class="s">&#39;u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_to_scope</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                                                            <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="Driver.execute"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate over a workflow of Components until some condition</span>
<span class="sd">        is met. If you don&#39;t want to structure your driver to use</span>
<span class="sd">        *pre_iteration*, *post_iteration*, etc., just override this function.</span>
<span class="sd">        As a result, none of the ``&lt;start/pre/post/continue&gt;_iteration()``</span>
<span class="sd">        functions will be called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_iteration</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">continue_iteration</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_iteration</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_iteration</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_iteration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_iteration</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Driver.stop"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop the workflow.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Driver.start_iteration"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.start_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">start_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called just prior to the beginning of an iteration loop. This can</span>
<span class="sd">        be overridden by inherited classes. It can be used to perform any</span>
<span class="sd">        necessary pre-iteration initialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_continue</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Driver.end_iteration"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.end_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">end_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called at the end of the iteraton loop.  Override this in</span>
<span class="sd">        inherited classes to perform some action after iteration is complete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Driver.continue_iteration"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.continue_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">continue_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return False to stop iterating.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_continue</span>
</div>
<div class="viewcode-block" id="Driver.pre_iteration"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.pre_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">pre_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called prior to each iteration.</span>
<span class="sd">        This is where iteration events are set.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_events</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Driver.run_iteration"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.run_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">run_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_uuid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs workflow.&quot;&quot;&quot;</span>
        <span class="n">wf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wf</span><span class="o">.</span><span class="n">_ordering</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39;: workflow is empty!&quot;</span>
                                 <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pathname</span><span class="p">())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">wf</span><span class="o">.</span><span class="n">_system</span><span class="o">.</span><span class="n">is_active</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_exec_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">iterbase</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">_iterbase</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">case_uuid</span><span class="p">:</span>
            <span class="c"># We record the case and are responsible for unique case ids.</span>
            <span class="n">record_case</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">case_uuid</span> <span class="o">=</span> <span class="n">Case</span><span class="o">.</span><span class="n">next_uuid</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">record_case</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">err</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">uvec</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">_system</span><span class="o">.</span><span class="n">vec</span><span class="p">[</span><span class="s">&#39;u&#39;</span><span class="p">]</span>
            <span class="n">fvec</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">_system</span><span class="o">.</span><span class="n">vec</span><span class="p">[</span><span class="s">&#39;f&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">wf</span><span class="o">.</span><span class="n">_need_prescatter</span><span class="p">:</span>
                <span class="n">wf</span><span class="o">.</span><span class="n">_system</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="s">&#39;u&#39;</span><span class="p">,</span> <span class="s">&#39;p&#39;</span><span class="p">)</span>

            <span class="c"># save old value of u to compute resids</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">wf</span><span class="o">.</span><span class="n">_cycle_vars</span><span class="p">:</span>
                <span class="n">fvec</span><span class="p">[</span><span class="n">node</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">uvec</span><span class="p">[</span><span class="n">node</span><span class="p">][:]</span>

            <span class="n">wf</span><span class="o">.</span><span class="n">_system</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">iterbase</span><span class="o">=</span><span class="n">iterbase</span><span class="p">,</span> <span class="n">case_uuid</span><span class="o">=</span><span class="n">case_uuid</span><span class="p">)</span>

            <span class="c"># update resid vector for cyclic vars</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">wf</span><span class="o">.</span><span class="n">_cycle_vars</span><span class="p">:</span>
                <span class="n">fvec</span><span class="p">[</span><span class="n">node</span><span class="p">][:]</span> <span class="o">-=</span> <span class="n">uvec</span><span class="p">[</span><span class="n">node</span><span class="p">][:]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RunStopped</span><span class="p">(</span><span class="s">&#39;Stop requested&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">record_case</span> <span class="ow">and</span> <span class="n">wf</span><span class="o">.</span><span class="n">_rec_required</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wf</span><span class="o">.</span><span class="n">_record_case</span><span class="p">(</span><span class="n">case_uuid</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Can&#39;t record case: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>

        <span class="c"># reraise exception with proper traceback if one occurred</span>
        <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># NOTE: cannot use &#39;raise err&#39; here for some reason.  Must separate</span>
            <span class="c"># the parts of the tuple.</span>
            <span class="k">raise</span> <span class="n">err</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">err</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">err</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Driver.calc_derivatives"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.calc_derivatives">[docs]</a>    <span class="k">def</span> <span class="nf">calc_derivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculate derivatives and save baseline states for all components</span>
<span class="sd">        in this workflow.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">calc_derivatives</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Driver.post_iteration"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.post_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">post_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called after each iteration.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_continue</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c"># by default, stop after one iteration</span>
</div>
<div class="viewcode-block" id="Driver.config_changed"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.config_changed">[docs]</a>    <span class="k">def</span> <span class="nf">config_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_parent</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call this whenever the configuration of this Component changes,</span>
<span class="sd">        for example, children are added or removed or dependencies may have</span>
<span class="sd">        changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">config_changed</span><span class="p">(</span><span class="n">update_parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_required_compnames</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_depgraph</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter_set</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_full_iter_set</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">config_changed</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_get_param_constraint_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of tuples of the form (param, constraint).&quot;&quot;&quot;</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;list_param_group_targets&#39;</span><span class="p">):</span>
            <span class="n">pgroups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_param_group_targets</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">cnst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eq_constraints</span><span class="p">()</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">pgroups</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">cnst</span><span class="o">.</span><span class="n">rhs</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                        <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cnst</span><span class="o">.</span><span class="n">pcomp_name</span><span class="o">+</span><span class="s">&#39;.out0&#39;</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">cnst</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                        <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cnst</span><span class="o">.</span><span class="n">pcomp_name</span><span class="o">+</span><span class="s">&#39;.out0&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pairs</span>

<div class="viewcode-block" id="Driver.setup_init"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.setup_init">[docs]</a>    <span class="k">def</span> <span class="nf">setup_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setup_init</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_required_compnames</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter_set</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_full_iter_set</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_depgraph</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reduced_graph</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">setup_init</span><span class="p">()</span>
</div>
    <span class="nd">@rbac</span><span class="p">((</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="Driver.setup_systems"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.setup_systems">[docs]</a>    <span class="k">def</span> <span class="nf">setup_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up system trees from here down to all of our</span>
<span class="sd">        child Components.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_reduced_graph</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_reduced_graph</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;system&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">setup_systems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_type</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Driver.print_norm"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.print_norm">[docs]</a>    <span class="k">def</span> <span class="nf">print_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver_string</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">res0</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s">&#39;NL&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Prints out the norm of the residual in a neat readable format.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Find indentation level</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">itername</span> <span class="o">==</span> <span class="s">&#39;-driver&#39;</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">indent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itername</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">indent</span>

        <span class="n">indent</span> <span class="o">=</span> <span class="s">&#39;   &#39;</span> <span class="o">*</span> <span class="n">level</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s">&#39;[</span><span class="si">%s</span><span class="s">] </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">   </span><span class="si">%d</span><span class="s"> | </span><span class="si">%s</span><span class="s">&#39;</span>
            <span class="k">print</span> <span class="n">form</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">driver_string</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s">&#39;[</span><span class="si">%s</span><span class="s">] </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">   </span><span class="si">%d</span><span class="s"> | </span><span class="si">%.9g</span><span class="s"> </span><span class="si">%.9g</span><span class="s">&#39;</span>
        <span class="k">print</span> <span class="n">form</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">driver_string</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">res</span><span class="o">/</span><span class="n">res0</span><span class="p">)</span>

    <span class="c">#### MPI related methods ####</span>
</div>
    <span class="nd">@rbac</span><span class="p">((</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="Driver.get_req_cpus"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.get_req_cpus">[docs]</a>    <span class="k">def</span> <span class="nf">get_req_cpus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return requested_cpus.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">get_req_cpus</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Driver.setup_communicators"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.setup_communicators">[docs]</a>    <span class="k">def</span> <span class="nf">setup_communicators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allocate communicators from here down to all of our</span>
<span class="sd">        child Components.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">setup_communicators</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Driver.setup_scatters"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.setup_scatters">[docs]</a>    <span class="k">def</span> <span class="nf">setup_scatters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">setup_scatters</span><span class="p">()</span>

        <span class="c"># FIXME: move this somewhere else...</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_system</span><span class="p">,</span> <span class="s">&#39;graph&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_cycle_vars</span> <span class="o">=</span> <span class="n">get_cycle_vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_system</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_var_meta</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_cycle_vars</span> <span class="o">=</span> <span class="p">[]</span>
</div>
    <span class="nd">@rbac</span><span class="p">((</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="Driver.get_full_nodeset"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.get_full_nodeset">[docs]</a>    <span class="k">def</span> <span class="nf">get_full_nodeset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the full set of nodes in the depgraph</span>
<span class="sd">        belonging to this driver (includes full iteration set).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Driver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_full_nodeset</span><span class="p">()</span>
        <span class="n">names</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_full_iter_set</span><span class="p">)</span>

        <span class="n">srcvars</span><span class="p">,</span> <span class="n">destvars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_expr_var_depends</span><span class="p">()</span>
        <span class="n">ours</span> <span class="o">=</span> <span class="n">srcvars</span>
        <span class="n">ours</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">destvars</span><span class="p">)</span>

        <span class="c"># check for any VarSystems that correspond to our params/constraints/obj</span>
        <span class="c"># because they should also &#39;belong&#39; to us</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_reduced_graph</span><span class="p">:</span>
            <span class="n">cgraph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_reduced_graph</span><span class="o">.</span><span class="n">component_graph</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">cgraph</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ours</span><span class="p">:</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">names</span>
</div>
<div class="viewcode-block" id="Driver.calc_gradient"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.calc_gradient">[docs]</a>    <span class="k">def</span> <span class="nf">calc_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span>
                      <span class="n">return_format</span><span class="o">=</span><span class="s">&#39;array&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the Jacobian of derivatives between inputs and outputs.</span>

<span class="sd">        inputs: list of strings</span>
<span class="sd">            List of OpenMDAO inputs to take derivatives with respect to.</span>

<span class="sd">        outputs: list of strings</span>
<span class="sd">            Lis of OpenMDAO outputs to take derivatives of.</span>

<span class="sd">        mode: string in [&#39;forward&#39;, &#39;adjoint&#39;, &#39;auto&#39;, &#39;fd&#39;]</span>
<span class="sd">            Mode for gradient calculation. Set to &#39;auto&#39; to let OpenMDAO choose</span>
<span class="sd">            forward or adjoint based on problem dimensions. Set to &#39;fd&#39; to</span>
<span class="sd">            finite difference the entire workflow.</span>

<span class="sd">        return_format: string in [&#39;array&#39;, &#39;dict&#39;]</span>
<span class="sd">            Format for return value. Default is array, but some optimizers may</span>
<span class="sd">            want a dictionary instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_gradient</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
                                   <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">return_format</span><span class="o">=</span><span class="n">return_format</span><span class="p">,</span>
                                   <span class="n">force_regen</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_calc_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span>
                       <span class="n">return_format</span><span class="o">=</span><span class="s">&#39;array&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">force_regen</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the Jacobian of derivatives between inputs and outputs.</span>

<span class="sd">        inputs: list of strings</span>
<span class="sd">            List of OpenMDAO inputs to take derivatives with respect to.</span>

<span class="sd">        outputs: list of strings</span>
<span class="sd">            Lis of OpenMDAO outputs to take derivatives of.</span>

<span class="sd">        mode: string in [&#39;forward&#39;, &#39;adjoint&#39;, &#39;auto&#39;, &#39;fd&#39;]</span>
<span class="sd">            Mode for gradient calculation. Set to &#39;auto&#39; to let OpenMDAO choose</span>
<span class="sd">            forward or adjoint based on problem dimensions. Set to &#39;fd&#39; to</span>
<span class="sd">            finite difference the entire workflow.</span>

<span class="sd">        return_format: string in [&#39;array&#39;, &#39;dict&#39;]</span>
<span class="sd">            Format for return value. Default is array, but some optimizers may</span>
<span class="sd">            want a dictionary instead.</span>

<span class="sd">        force_regen: boolean</span>
<span class="sd">            Set to True to force a regeneration of the system hierarchy.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># if inputs aren&#39;t specified, use parameters</span>
        <span class="k">if</span> <span class="n">inputs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;list_param_group_targets&#39;</span><span class="p">):</span>
                <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_param_group_targets</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">inputs</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;No inputs given for derivatives.&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raise_exception</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">)</span>

        <span class="c"># If outputs aren&#39;t specified, use the objectives and constraints</span>
        <span class="k">if</span> <span class="n">outputs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;list_objective_targets&#39;</span><span class="p">):</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_objective_targets</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;list_constraint_targets&#39;</span><span class="p">):</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_constraint_targets</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">outputs</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;No outputs given for derivatives.&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raise_exception</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">)</span>

        <span class="n">inputs</span>  <span class="o">=</span> <span class="p">[</span><span class="n">_fix_tups</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">]</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">_fix_tups</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_calc_gradient_inputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_calc_gradient_outputs</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[:]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">force_regen</span><span class="p">:</span>
                <span class="n">top</span> <span class="o">=</span> <span class="bp">self</span>
                <span class="k">while</span> <span class="n">top</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">top</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">parent</span>

                <span class="n">top</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span> <span class="n">drvname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_options</span>

            <span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">calc_gradient</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">return_format</span><span class="p">,</span>
                                            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

            <span class="c"># Finally, we need to untransform the jacobian if any parameters have</span>
            <span class="c"># scalers.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;get_parameters&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">J</span>

            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">J</span>

            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">pname</span> <span class="o">=</span> <span class="n">name</span> <span class="o">=</span> <span class="n">group</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pname</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c"># Note: &#39;dict&#39; is the only valid return_format for MPI runs.</span>
                <span class="k">if</span> <span class="n">return_format</span> <span class="o">==</span> <span class="s">&#39;dict&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pname</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                        <span class="n">scaler</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span><span class="o">.</span><span class="n">scaler</span>
                        <span class="k">if</span> <span class="n">scaler</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">okey</span> <span class="ow">in</span> <span class="n">J</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="n">J</span><span class="p">[</span><span class="n">okey</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">J</span><span class="p">[</span><span class="n">okey</span><span class="p">][</span><span class="n">name</span><span class="p">]</span><span class="o">*</span><span class="n">scaler</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_system</span><span class="o">.</span><span class="n">vec</span><span class="p">[</span><span class="s">&#39;u&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">pname</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                        <span class="n">scaler</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span><span class="o">.</span><span class="n">scaler</span>
                        <span class="k">if</span> <span class="n">scaler</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
                            <span class="n">J</span><span class="p">[:,</span> <span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">width</span><span class="p">]</span> <span class="o">=</span> <span class="n">J</span><span class="p">[:,</span> <span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">width</span><span class="p">]</span><span class="o">*</span><span class="n">scaler</span>

                    <span class="n">i</span> <span class="o">+=</span> <span class="n">width</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_calc_gradient_inputs</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_calc_gradient_outputs</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">J</span>

<div class="viewcode-block" id="Driver.check_gradient"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.check_gradient">[docs]</a>    <span class="k">def</span> <span class="nf">check_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare the OpenMDAO-calculated gradient with one calculated</span>
<span class="sd">        by straight finite-difference. This provides the user with a way</span>
<span class="sd">        to validate his derivative functions (apply_deriv and provideJ.)</span>

<span class="sd">        inputs: (optional) iter of str or None</span>
<span class="sd">            Names of input variables. The calculated gradient will be</span>
<span class="sd">            the matrix of values of the output variables with respect</span>
<span class="sd">            to these input variables. If no value is provided for inputs,</span>
<span class="sd">            they will be determined based on the parameters of</span>
<span class="sd">            this Driver.</span>

<span class="sd">        outputs: (optional) iter of str or None</span>
<span class="sd">            Names of output variables. The calculated gradient will be</span>
<span class="sd">            the matrix of values of these output variables with respect</span>
<span class="sd">            to the input variables. If no value is provided for outputs,</span>
<span class="sd">            they will be determined based on the objectives and constraints</span>
<span class="sd">            of this Driver.</span>

<span class="sd">        stream: (optional) file-like object or str</span>
<span class="sd">            Where to write to, default stdout. If a string is supplied,</span>
<span class="sd">            that is used as a filename. If None, no output is written.</span>

<span class="sd">        mode: (optional) str</span>
<span class="sd">            Set to &#39;forward&#39; for forward mode, &#39;adjoint&#39; for adjoint mode,</span>
<span class="sd">            or &#39;auto&#39; to let OpenMDAO determine the correct mode.</span>
<span class="sd">            Defaults to &#39;auto&#39;.</span>

<span class="sd">        Returns the finite difference gradient, the OpenMDAO-calculated</span>
<span class="sd">        gradient, and a list of suspect inputs/outputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># tuples cause problems</span>
        <span class="k">if</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">close_stream</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">close_stream</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">stream</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">stream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

        <span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_gradient</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">Jbase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_gradient</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;fd&#39;</span><span class="p">)</span>

        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stream</span><span class="p">,</span> <span class="mi">24</span><span class="o">*</span><span class="s">&#39;-&#39;</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stream</span><span class="p">,</span> <span class="s">&#39;Calculated Gradient&#39;</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stream</span><span class="p">,</span> <span class="mi">24</span><span class="o">*</span><span class="s">&#39;-&#39;</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stream</span><span class="p">,</span> <span class="n">J</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stream</span><span class="p">,</span> <span class="mi">24</span><span class="o">*</span><span class="s">&#39;-&#39;</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stream</span><span class="p">,</span> <span class="s">&#39;Finite Difference Comparison&#39;</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stream</span><span class="p">,</span> <span class="mi">24</span><span class="o">*</span><span class="s">&#39;-&#39;</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stream</span><span class="p">,</span> <span class="n">Jbase</span>

        <span class="c"># This code duplication is needed so that we print readable names for</span>
        <span class="c"># the constraints and objectives.</span>

        <span class="k">if</span> <span class="n">inputs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;list_param_group_targets&#39;</span><span class="p">):</span>
                <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_param_group_targets</span><span class="p">()</span>
                <span class="n">input_refs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">input_refs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">input_refs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="c"># Should be caught in calc_gradient()</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c"># pragma no cover</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;No inputs given for derivatives.&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raise_exception</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">input_refs</span> <span class="o">=</span> <span class="n">inputs</span>

        <span class="k">if</span> <span class="n">outputs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">output_refs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;get_objectives&#39;</span><span class="p">):</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">.out0&quot;</span> <span class="o">%</span> <span class="n">item</span><span class="o">.</span><span class="n">pcomp_name</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">get_objectives</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="n">output_refs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_objectives</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;get_constraints&#39;</span><span class="p">):</span>
                <span class="n">con</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">.out0&quot;</span> <span class="o">%</span> <span class="n">item</span><span class="o">.</span><span class="n">pcomp_name</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">get_constraints</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">con</span><span class="p">)</span>
                <span class="n">output_refs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_constraints</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c"># pragma no cover</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;No outputs given for derivatives.&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raise_exception</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_refs</span> <span class="o">=</span> <span class="n">outputs</span>

        <span class="n">out_width</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">output</span><span class="p">,</span> <span class="n">oref</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">output_refs</span><span class="p">):</span>
            <span class="n">out_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="n">out_names</span> <span class="o">=</span> <span class="n">_flattened_names</span><span class="p">(</span><span class="n">oref</span><span class="p">,</span> <span class="n">out_val</span><span class="p">)</span>
            <span class="n">out_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">out_width</span><span class="p">,</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">out_names</span><span class="p">]))</span>

        <span class="n">inp_width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">input_tup</span><span class="p">,</span> <span class="n">iref</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">input_refs</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_tup</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">input_tup</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_tup</span><span class="p">]</span>
            <span class="n">inp_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">input_tup</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">inp_names</span> <span class="o">=</span> <span class="n">_flattened_names</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">iref</span><span class="p">),</span> <span class="n">inp_val</span><span class="p">)</span>
            <span class="n">inp_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">inp_width</span><span class="p">,</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span> <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">inp_names</span><span class="p">]))</span>

        <span class="n">label_width</span> <span class="o">=</span> <span class="n">out_width</span> <span class="o">+</span> <span class="n">inp_width</span> <span class="o">+</span> <span class="mi">4</span>

        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stream</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stream</span><span class="p">,</span> <span class="n">label_width</span><span class="o">*</span><span class="s">&#39; &#39;</span><span class="p">,</span> \
              <span class="s">&#39;</span><span class="si">%-18s</span><span class="s"> </span><span class="si">%-18s</span><span class="s"> </span><span class="si">%-18s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Calculated&#39;</span><span class="p">,</span> <span class="s">&#39;FiniteDiff&#39;</span><span class="p">,</span> <span class="s">&#39;RelError&#39;</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stream</span><span class="p">,</span> <span class="p">(</span><span class="n">label_width</span><span class="o">+</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="mi">18</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="s">&#39;-&#39;</span>

        <span class="n">suspect_limit</span> <span class="o">=</span> <span class="mf">1e-5</span>
        <span class="n">error_n</span> <span class="o">=</span> <span class="n">error_sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">error_max</span> <span class="o">=</span> <span class="n">error_loc</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">suspects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">io_pairs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">output</span><span class="p">,</span> <span class="n">oref</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">output_refs</span><span class="p">):</span>
            <span class="n">out_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">out_name</span> <span class="ow">in</span> <span class="n">_flattened_names</span><span class="p">(</span><span class="n">oref</span><span class="p">,</span> <span class="n">out_val</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">input_tup</span><span class="p">,</span> <span class="n">iref</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">input_refs</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_tup</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                        <span class="n">input_tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_tup</span><span class="p">,)</span>

                    <span class="n">inp_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">input_tup</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">inp_name</span> <span class="ow">in</span> <span class="n">_flattened_names</span><span class="p">(</span><span class="n">iref</span><span class="p">,</span> <span class="n">inp_val</span><span class="p">):</span>
                        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">calc</span> <span class="o">=</span> <span class="n">J</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                        <span class="n">finite</span> <span class="o">=</span> <span class="n">Jbase</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">finite</span> <span class="ow">and</span> <span class="n">calc</span><span class="p">:</span>
                            <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">calc</span> <span class="o">-</span> <span class="n">finite</span><span class="p">)</span> <span class="o">/</span> <span class="n">finite</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">error</span> <span class="o">=</span> <span class="n">calc</span> <span class="o">-</span> <span class="n">finite</span>
                        <span class="n">error_n</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">error_sum</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">error_max</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">error_max</span><span class="p">):</span>
                            <span class="n">error_max</span> <span class="o">=</span> <span class="n">error</span>
                            <span class="n">error_loc</span> <span class="o">=</span> <span class="p">(</span><span class="n">out_name</span><span class="p">,</span> <span class="n">inp_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">suspect_limit</span> <span class="ow">or</span> <span class="n">isnan</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
                            <span class="n">suspects</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">out_name</span><span class="p">,</span> <span class="n">inp_name</span><span class="p">))</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stream</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%*s</span><span class="s"> / </span><span class="si">%*s</span><span class="s">: </span><span class="si">%-18s</span><span class="s"> </span><span class="si">%-18s</span><span class="s"> </span><span class="si">%-18s</span><span class="s">&#39;</span> \
                              <span class="o">%</span> <span class="p">(</span><span class="n">out_width</span><span class="p">,</span> <span class="n">out_name</span><span class="p">,</span> <span class="n">inp_width</span><span class="p">,</span> <span class="n">inp_name</span><span class="p">,</span>
                                 <span class="n">calc</span><span class="p">,</span> <span class="n">finite</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
                        <span class="n">io_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%*s</span><span class="s"> / </span><span class="si">%*s</span><span class="s">&quot;</span>
                                        <span class="o">%</span> <span class="p">(</span><span class="n">out_width</span><span class="p">,</span> <span class="n">out_name</span><span class="p">,</span>
                                           <span class="n">inp_width</span><span class="p">,</span> <span class="n">inp_name</span><span class="p">))</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stream</span>
        <span class="k">if</span> <span class="n">error_n</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stream</span><span class="p">,</span> <span class="s">&#39;Average RelError:&#39;</span><span class="p">,</span> <span class="n">error_sum</span> <span class="o">/</span> <span class="n">error_n</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stream</span><span class="p">,</span> <span class="s">&#39;Max RelError:&#39;</span><span class="p">,</span> <span class="n">error_max</span><span class="p">,</span> <span class="s">&#39;for </span><span class="si">%s</span><span class="s"> / </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">error_loc</span>
        <span class="k">if</span> <span class="n">suspects</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stream</span><span class="p">,</span> <span class="s">&#39;Suspect gradients (RelError &gt; </span><span class="si">%s</span><span class="s">):&#39;</span> <span class="o">%</span> <span class="n">suspect_limit</span>
            <span class="k">for</span> <span class="n">out_name</span><span class="p">,</span> <span class="n">inp_name</span> <span class="ow">in</span> <span class="n">suspects</span><span class="p">:</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stream</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%*s</span><span class="s"> / </span><span class="si">%*s</span><span class="s">&#39;</span> \
                      <span class="o">%</span> <span class="p">(</span><span class="n">out_width</span><span class="p">,</span> <span class="n">out_name</span><span class="p">,</span> <span class="n">inp_width</span><span class="p">,</span> <span class="n">inp_name</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stream</span>

        <span class="k">if</span> <span class="n">close_stream</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># return arrays and suspects to make it easier to check from a test</span>
        <span class="k">return</span> <span class="n">Jbase</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">J</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">io_pairs</span><span class="p">,</span> <span class="n">suspects</span>
</div>
    <span class="nd">@rbac</span><span class="p">((</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="Driver.setup_depgraph"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.setup_depgraph">[docs]</a>    <span class="k">def</span> <span class="nf">setup_depgraph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dgraph</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reduced_graph</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_calc_gradient_inputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_calc_gradient_inputs</span><span class="p">:</span>
                <span class="n">dgraph</span><span class="o">.</span><span class="n">add_param</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>

        <span class="c"># add connections for calc gradient outputs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_calc_gradient_outputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">vname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">_calc_gradient_outputs</span><span class="p">:</span>
                <span class="n">dgraph</span><span class="o">.</span><span class="n">add_driver_input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">vname</span><span class="p">)</span>
</div>
    <span class="nd">@rbac</span><span class="p">((</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="Driver.init_var_sizes"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.init_var_sizes">[docs]</a>    <span class="k">def</span> <span class="nf">init_var_sizes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ordering</span><span class="p">:</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">cname</span><span class="p">)</span><span class="o">.</span><span class="n">init_var_sizes</span><span class="p">()</span>
</div>
    <span class="nd">@rbac</span><span class="p">((</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="Driver.is_differentiable"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.driver.Driver.is_differentiable">[docs]</a>    <span class="k">def</span> <span class="nf">is_differentiable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if analytical derivatives can be</span>
<span class="sd">        computed for this Component.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_fd</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="n">ISolver</span><span class="o">.</span><span class="n">providedBy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">Driver</span>
</div></div>
<span class="k">def</span> <span class="nf">_flattened_names</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return list of names for values in `val`.</span>
<span class="sd">    Note that this expands arrays into an entry for each index!.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">ndarray</span>
    <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">_flattened_names</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">[</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">value</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">IVariableTree</span><span class="o">.</span><span class="n">providedBy</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">list_vars</span><span class="p">()):</span>  <span class="c"># Force repeatable order.</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">_flattened_names</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">)),</span> <span class="n">value</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Variable </span><span class="si">%s</span><span class="s"> is of type </span><span class="si">%s</span><span class="s"> which is not convertable&#39;</span>
                        <span class="s">&#39; to a 1D float array.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">names</span>


<span class="k">def</span> <span class="nf">_fix_tups</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return x[0] if x is a single element tuple, else return x.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<a href="http://openmdao.org">
 <img src="../../../_static/OpenMDAO_Logo_200w_padded.png"
border="0" alt="OpenMDAO Home"/>
</a>

<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../../index.html">OpenMDAO Documentation v0.13.0</a> &raquo;</li>

          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright none.
      Last updated on Apr 23, 2015.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>