<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>openmdao.main.resource &mdash; OpenMDAO Documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.13.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="OpenMDAO Documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../../index.html">OpenMDAO Documentation v0.13.0</a> &raquo;</li>

          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for openmdao.main.resource</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. _`resource.py`:</span>

<span class="sd">Support for allocation of servers from one or more resources</span>
<span class="sd">(i.e., the local host, a cluster of remote hosts, etc.).</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">ConfigParser</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>
<span class="kn">import</span> <span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">from</span> <span class="nn">openmdao.main</span> <span class="kn">import</span> <span class="n">mp_distributing</span>
<span class="kn">from</span> <span class="nn">openmdao.main.mp_support</span> <span class="kn">import</span> <span class="n">register</span>
<span class="kn">from</span> <span class="nn">openmdao.main.objserverfactory</span> <span class="kn">import</span> <span class="n">ObjServerFactory</span>
<span class="kn">from</span> <span class="nn">openmdao.main.rbac</span> <span class="kn">import</span> <span class="n">get_credentials</span><span class="p">,</span> <span class="n">set_credentials</span><span class="p">,</span> <span class="n">rbac</span>

<span class="kn">from</span> <span class="nn">openmdao.util.eggloader</span> <span class="kn">import</span> <span class="n">check_requirements</span>
<span class="kn">from</span> <span class="nn">openmdao.util.wrkpool</span> <span class="kn">import</span> <span class="n">WorkerPool</span>

<span class="c"># DRMAA JobTemplate derived keys.</span>
<span class="n">QUEUING_SYSTEM_KEYS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span>
    <span class="s">&#39;remote_command&#39;</span><span class="p">,</span>
    <span class="s">&#39;args&#39;</span><span class="p">,</span>
    <span class="s">&#39;submit_as_hold&#39;</span><span class="p">,</span>
    <span class="s">&#39;rerunnable&#39;</span><span class="p">,</span>
    <span class="s">&#39;job_environment&#39;</span><span class="p">,</span>
    <span class="s">&#39;working_directory&#39;</span><span class="p">,</span>
    <span class="s">&#39;job_category&#39;</span><span class="p">,</span>
    <span class="s">&#39;email&#39;</span><span class="p">,</span>
    <span class="s">&#39;email_on_started&#39;</span><span class="p">,</span>
    <span class="s">&#39;email_on_terminated&#39;</span><span class="p">,</span>
    <span class="s">&#39;job_name&#39;</span><span class="p">,</span>
    <span class="s">&#39;input_path&#39;</span><span class="p">,</span>
    <span class="s">&#39;output_path&#39;</span><span class="p">,</span>
    <span class="s">&#39;error_path&#39;</span><span class="p">,</span>
    <span class="s">&#39;join_files&#39;</span><span class="p">,</span>
    <span class="s">&#39;reservation_id&#39;</span><span class="p">,</span>
    <span class="s">&#39;queue_name&#39;</span><span class="p">,</span>
    <span class="s">&#39;priority&#39;</span><span class="p">,</span>
    <span class="s">&#39;start_time&#39;</span><span class="p">,</span>
    <span class="s">&#39;deadline_time&#39;</span><span class="p">,</span>
    <span class="s">&#39;resource_limits&#39;</span><span class="p">,</span>
    <span class="s">&#39;accounting_id&#39;</span><span class="p">,</span>

    <span class="c"># &#39;escape&#39; mechanism kept from earlier version.</span>
    <span class="s">&#39;native_specification&#39;</span><span class="p">,</span>
<span class="p">))</span>

<span class="c"># DRMAA derived job categories.</span>
<span class="n">JOB_CATEGORIES</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span>
    <span class="s">&#39;MPI&#39;</span><span class="p">,</span>
    <span class="s">&#39;GridMPI&#39;</span><span class="p">,</span>
    <span class="s">&#39;LAM-MPI&#39;</span><span class="p">,</span>
    <span class="s">&#39;MPICH1&#39;</span><span class="p">,</span>
    <span class="s">&#39;MPICH2&#39;</span><span class="p">,</span>
    <span class="s">&#39;OpenMPI&#39;</span><span class="p">,</span>
    <span class="s">&#39;PVM&#39;</span><span class="p">,</span>
    <span class="s">&#39;OpenMP&#39;</span><span class="p">,</span>
    <span class="s">&#39;OpenCL&#39;</span><span class="p">,</span>
    <span class="s">&#39;Java&#39;</span><span class="p">,</span>
<span class="p">))</span>

<span class="c"># DRMAA derived resource limits.</span>
<span class="n">RESOURCE_LIMITS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span>
    <span class="s">&#39;core_file_size&#39;</span><span class="p">,</span>
    <span class="s">&#39;data_seg_size&#39;</span><span class="p">,</span>
    <span class="s">&#39;file_size&#39;</span><span class="p">,</span>
    <span class="s">&#39;open_files&#39;</span><span class="p">,</span>
    <span class="s">&#39;stack_size&#39;</span><span class="p">,</span>
    <span class="s">&#39;virtual_memory&#39;</span><span class="p">,</span>
    <span class="s">&#39;cpu_time&#39;</span><span class="p">,</span>
    <span class="s">&#39;wallclock_time&#39;</span><span class="p">,</span>
<span class="p">))</span>

<span class="c"># DRMAA derived constants.</span>
<span class="n">HOME_DIRECTORY</span> <span class="o">=</span> <span class="s">&#39;$drmaa_hd_ph$&#39;</span>
<span class="n">WORKING_DIRECTORY</span> <span class="o">=</span> <span class="s">&#39;$drmaa_wd_ph$&#39;</span>

<span class="c"># Legal allocator name pattern.</span>
<span class="n">_LEGAL_NAME</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^[a-zA-Z][_a-zA-Z0-9]*$&#39;</span><span class="p">)</span>

<span class="c"># Checks for IPv4 address.</span>
<span class="n">_IPV4_HOST</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="ResourceAllocationManager"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocationManager">[docs]</a><span class="k">class</span> <span class="nc">ResourceAllocationManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The allocation manager maintains a list of :class:`ResourceAllocator`</span>
<span class="sd">    which are used to select the &quot;best fit&quot; for a particular resource request.</span>
<span class="sd">    The manager is initialized with a :class:`LocalAllocator` for the local</span>
<span class="sd">    host, using `authkey` of &#39;PublicKey&#39;, and allowing &#39;shell&#39; access.</span>

<span class="sd">    By default ``~/.openmdao/resources.cfg`` will be used for additional</span>
<span class="sd">    configuration information. To avoid this, call :meth:`configure` before</span>
<span class="sd">    any other allocation routines, or set the ``OPENMDAO_RAMFILE`` environment</span>
<span class="sd">    variable to the path to be used (a null path is legal and avoids any</span>
<span class="sd">    additional configuration).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
    <span class="n">_lock_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>  <span class="c"># For detecting copy from fork.</span>
    <span class="n">_RAM</span> <span class="o">=</span> <span class="bp">None</span>              <span class="c"># Singleton.</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;RAM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>  <span class="c"># For detecting copy from fork.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allocations</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allocators</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deployed_servers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allocators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LocalAllocator</span><span class="p">(</span><span class="s">&#39;LocalHost&#39;</span><span class="p">,</span>
                                               <span class="n">authkey</span><span class="o">=</span><span class="s">&#39;PublicKey&#39;</span><span class="p">,</span>
                                               <span class="n">allow_shell</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

        <span class="c"># If OPENMDAO_RAMFILE is specified, use that.</span>
        <span class="c"># Set to null during testing for better coverage analysis.</span>
        <span class="k">if</span> <span class="n">config_filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">config_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;OPENMDAO_RAMFILE&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">config_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">config_filename</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_filename</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;OPENMDAO_RAMFILE </span><span class="si">%r</span><span class="s"> not found&#39;</span><span class="p">,</span>
                                       <span class="n">config_filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config_filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">config_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">,</span> <span class="s">&#39;.openmdao&#39;</span><span class="p">,</span> <span class="s">&#39;resources.cfg&#39;</span><span class="p">)</span>
            <span class="n">config_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">config_filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_filename</span><span class="p">):</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="n">config_filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure</span><span class="p">(</span><span class="n">config_filename</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ResourceAllocationManager.configure"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocationManager.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">config_filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure allocators. This *must* be called before any other accesses</span>
<span class="sd">        if you want to avoid getting the default configuration as specified</span>
<span class="sd">        by ``~/.openmdao/resources.cfg``.</span>

<span class="sd">        config_filename: string</span>
<span class="sd">            Name of configuration file.</span>
<span class="sd">            If null, no additional configuration is performed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">orig</span> <span class="o">=</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_RAM</span>
        <span class="n">ram</span> <span class="o">=</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_get_instance</span><span class="p">(</span><span class="n">config_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ram</span> <span class="ow">is</span> <span class="n">orig</span><span class="p">:</span>  <span class="c"># Not configured.</span>
            <span class="k">with</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
                <span class="n">ram</span><span class="o">.</span><span class="n">_configure</span><span class="p">(</span><span class="n">config_filename</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Configure manager instance. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Configuring from </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">config_filename</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">inp</span><span class="p">:</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">readfp</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;  name: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">allocator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allocators</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">allocator</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;        existing allocator&#39;</span><span class="p">)</span>
                        <span class="n">allocator</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;classname&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;        skipping </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="n">classname</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;classname&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    classname: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">classname</span><span class="p">)</span>
                    <span class="n">mod_name</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">cls_name</span> <span class="o">=</span> <span class="n">classname</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">__import__</span><span class="p">(</span><span class="n">mod_name</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;RAM configure </span><span class="si">%s</span><span class="s">: can&#39;t import </span><span class="si">%r</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span>
                                           <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mod_name</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>
                    <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">mod_name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">cls_name</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;RAM configure </span><span class="si">%s</span><span class="s">: no class </span><span class="si">%r</span><span class="s"> in </span><span class="si">%s</span><span class="s">&#39;</span>
                                           <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cls_name</span><span class="p">,</span> <span class="n">mod_name</span><span class="p">))</span>
                    <span class="n">cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">cls_name</span><span class="p">)</span>
                    <span class="n">allocator</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">allocator</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_allocators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">allocator</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_instance</span><span class="p">(</span><span class="n">config_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return singleton instance. &quot;&quot;&quot;</span>
        <span class="c"># May need to release forked lock.</span>
        <span class="k">if</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_lock_pid</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">():</span> <span class="c"># pragma no cover</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">threading</span><span class="o">.</span><span class="n">ThreadError</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c"># Not locked.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;RAM: released forked lock.&#39;</span><span class="p">)</span>
            <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_lock_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">ram</span> <span class="o">=</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_RAM</span>
            <span class="k">if</span> <span class="n">ram</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">ram</span> <span class="o">=</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_RAM</span> <span class="o">=</span> \
                          <span class="n">ResourceAllocationManager</span><span class="p">(</span><span class="n">config_filename</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ram</span><span class="o">.</span><span class="n">_pid</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">():</span>  <span class="c"># pragma no cover</span>
                <span class="c"># We&#39;re a copy from a fork.</span>
                <span class="k">for</span> <span class="n">allocator</span> <span class="ow">in</span> <span class="n">ram</span><span class="o">.</span><span class="n">_allocators</span><span class="p">:</span>
                    <span class="n">allocator</span><span class="o">.</span><span class="n">invalidate</span><span class="p">()</span>
                <span class="n">ram</span> <span class="o">=</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_RAM</span> <span class="o">=</span> \
                          <span class="n">ResourceAllocationManager</span><span class="p">(</span><span class="n">config_filename</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ram</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ResourceAllocationManager.add_allocator"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocationManager.add_allocator">[docs]</a>    <span class="k">def</span> <span class="nf">add_allocator</span><span class="p">(</span><span class="n">allocator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an allocator to the list of resource allocators.</span>

<span class="sd">        allocator: ResourceAllocator</span>
<span class="sd">            The allocator to be added.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ram</span> <span class="o">=</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_get_instance</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">allocator</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">alloc</span> <span class="ow">in</span> <span class="n">ram</span><span class="o">.</span><span class="n">_allocators</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">alloc</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;allocator named </span><span class="si">%r</span><span class="s"> already exists&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">ram</span><span class="o">.</span><span class="n">_allocators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">allocator</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ResourceAllocationManager.insert_allocator"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocationManager.insert_allocator">[docs]</a>    <span class="k">def</span> <span class="nf">insert_allocator</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">allocator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert an allocator into the list of resource allocators.</span>

<span class="sd">        index: int</span>
<span class="sd">            List index for the insertion point.</span>

<span class="sd">        allocator: ResourceAllocator</span>
<span class="sd">            The allocator to be inserted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ram</span> <span class="o">=</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_get_instance</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">allocator</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">alloc</span> <span class="ow">in</span> <span class="n">ram</span><span class="o">.</span><span class="n">_allocators</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">alloc</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;allocator named </span><span class="si">%r</span><span class="s"> already exists&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">ram</span><span class="o">.</span><span class="n">_allocators</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">allocator</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ResourceAllocationManager.get_allocator"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocationManager.get_allocator">[docs]</a>    <span class="k">def</span> <span class="nf">get_allocator</span><span class="p">(</span><span class="n">selector</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return allocator at `selector` or whose name is `selector`.</span>

<span class="sd">        selector: int or string</span>
<span class="sd">            List index or name of allocator to be returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ram</span> <span class="o">=</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_get_instance</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selector</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">allocator</span> <span class="ow">in</span> <span class="n">ram</span><span class="o">.</span><span class="n">_allocators</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">allocator</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">selector</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">allocator</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;allocator </span><span class="si">%r</span><span class="s"> not found&#39;</span> <span class="o">%</span> <span class="n">selector</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ram</span><span class="o">.</span><span class="n">_allocators</span><span class="p">[</span><span class="n">selector</span><span class="p">]</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ResourceAllocationManager.remove_allocator"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocationManager.remove_allocator">[docs]</a>    <span class="k">def</span> <span class="nf">remove_allocator</span><span class="p">(</span><span class="n">selector</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove allocator at `selector` or whose name is `selector`.</span>

<span class="sd">        selector: int or string</span>
<span class="sd">            List index or name of allocator to be removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ram</span> <span class="o">=</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_get_instance</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selector</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">allocator</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ram</span><span class="o">.</span><span class="n">_allocators</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">allocator</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">selector</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">ram</span><span class="o">.</span><span class="n">_allocators</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;allocator </span><span class="si">%r</span><span class="s"> not found&#39;</span> <span class="o">%</span> <span class="n">selector</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ram</span><span class="o">.</span><span class="n">_allocators</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ResourceAllocationManager.list_allocators"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocationManager.list_allocators">[docs]</a>    <span class="k">def</span> <span class="nf">list_allocators</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot; Return list of allocators. &quot;&quot;&quot;</span>
        <span class="n">ram</span> <span class="o">=</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_get_instance</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ram</span><span class="o">.</span><span class="n">_allocators</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ResourceAllocationManager.max_servers"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocationManager.max_servers">[docs]</a>    <span class="k">def</span> <span class="nf">max_servers</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the maximum number of servers compatible with &#39;resource_desc`.</span>
<span class="sd">        This should be considered an upper limit on the number of concurrent</span>
<span class="sd">        allocations attempted.</span>

<span class="sd">        resource_desc: dict</span>
<span class="sd">            Description of required resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">validate_resources</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">)</span>
        <span class="n">ram</span> <span class="o">=</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_get_instance</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ram</span><span class="o">.</span><span class="n">_max_servers</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_max_servers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return total of each allocator&#39;s max servers. &quot;&quot;&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">allocator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allocators</span><span class="p">:</span>
            <span class="n">count</span><span class="p">,</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">allocator</span><span class="o">.</span><span class="n">max_servers</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="s">&#39;: key </span><span class="si">%r</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">criteria</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>  <span class="c"># Don&#39;t die on an empty dictionary.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s"> incompatible</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">allocator</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s"> returned </span><span class="si">%d</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">allocator</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="n">count</span>
        <span class="k">return</span> <span class="n">total</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ResourceAllocationManager.allocate"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocationManager.allocate">[docs]</a>    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine best resource for `resource_desc` and deploy.</span>
<span class="sd">        In the case of a tie, the first allocator in the allocators list wins.</span>
<span class="sd">        Returns ``(proxy-object, server-dict)``.</span>

<span class="sd">        resource_desc: dict</span>
<span class="sd">            Description of required resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">validate_resources</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">)</span>
        <span class="n">ram</span> <span class="o">=</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_get_instance</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ram</span><span class="o">.</span><span class="n">_allocate</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Do the allocation. &quot;&quot;&quot;</span>
        <span class="n">deployment_retries</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">best_estimate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">while</span> <span class="n">best_estimate</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">best_estimate</span><span class="p">,</span> <span class="n">best_criteria</span><span class="p">,</span> <span class="n">best_allocator</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_estimates</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">best_estimate</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_allocations</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;Sim-</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allocations</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;deploying on </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">best_allocator</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="n">server</span> <span class="o">=</span> <span class="n">best_allocator</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">,</span>
                                               <span class="n">best_criteria</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">server</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">server_info</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                        <span class="s">&#39;pid&#39;</span><span class="p">:</span>  <span class="n">server</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span>
                        <span class="s">&#39;host&#39;</span><span class="p">:</span> <span class="n">server</span><span class="o">.</span><span class="n">host</span>
                    <span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;allocated </span><span class="si">%r</span><span class="s"> pid </span><span class="si">%d</span><span class="s"> on </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                                      <span class="n">name</span><span class="p">,</span> <span class="n">server_info</span><span class="p">[</span><span class="s">&#39;pid&#39;</span><span class="p">],</span>
                                      <span class="n">server_info</span><span class="p">[</span><span class="s">&#39;host&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_deployed_servers</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">server</span><span class="p">)]</span> <span class="o">=</span> \
                        <span class="p">(</span><span class="n">best_allocator</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">server_info</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">server_info</span><span class="p">)</span>
                <span class="c"># Difficult to generate deployable request that won&#39;t deploy...</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                    <span class="n">deployment_retries</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">deployment_retries</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;deployment failed too many times.&#39;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;deployment failed, retrying.&#39;</span><span class="p">)</span>
                    <span class="n">best_estimate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">best_estimate</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="c"># Difficult to generate deployable request that won&#39;t deploy...</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># Wait a bit between retries.</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ResourceAllocationManager.get_hostnames"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocationManager.get_hostnames">[docs]</a>    <span class="k">def</span> <span class="nf">get_hostnames</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine best resource for `resource_desc` and return hostnames.</span>
<span class="sd">        In the case of a tie, the first allocator in the allocators list wins.</span>
<span class="sd">        Typically used by parallel code wrappers which have MPI or something</span>
<span class="sd">        similar for process deployment.</span>

<span class="sd">        resource_desc: dict</span>
<span class="sd">            Description of required resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">validate_resources</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">)</span>
        <span class="n">ram</span> <span class="o">=</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_get_instance</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ram</span><span class="o">.</span><span class="n">_get_hostnames</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_get_hostnames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the hostnames. &quot;&quot;&quot;</span>
        <span class="n">best_score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">while</span> <span class="n">best_score</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">best_score</span><span class="p">,</span> <span class="n">best_criteria</span><span class="p">,</span> <span class="n">best_allocator</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_estimates</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">,</span> <span class="n">need_hostnames</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">best_score</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;using </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">best_criteria</span><span class="p">[</span><span class="s">&#39;hostnames&#39;</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">best_criteria</span><span class="p">[</span><span class="s">&#39;hostnames&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">best_score</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="c"># Difficult to generate deployable request that won&#39;t deploy...</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># Wait a bit between retries.</span>

    <span class="k">def</span> <span class="nf">_get_estimates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">,</span> <span class="n">need_hostnames</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return best (estimate, criteria, allocator). &quot;&quot;&quot;</span>
        <span class="n">best_estimate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
        <span class="n">best_criteria</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">best_allocator</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">for</span> <span class="n">allocator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allocators</span><span class="p">:</span>
            <span class="n">estimate</span><span class="p">,</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">allocator</span><span class="o">.</span><span class="n">time_estimate</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">estimate</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">criteria</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s"> incompatible: key </span><span class="si">%r</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                                   <span class="n">allocator</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;OK&#39;</span> <span class="k">if</span> <span class="n">estimate</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s">&#39;returned </span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">estimate</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">allocator</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">best_estimate</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">estimate</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="p">(</span><span class="n">best_estimate</span> <span class="o">==</span> <span class="mi">0</span>  <span class="ow">and</span> <span class="n">estimate</span> <span class="o">&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="p">(</span><span class="n">best_estimate</span> <span class="o">&gt;</span>  <span class="mi">0</span>  <span class="ow">and</span> <span class="n">estimate</span> <span class="o">&lt;</span> <span class="n">best_estimate</span><span class="p">):</span>
                <span class="c"># All current allocators support &#39;hostnames&#39;.</span>
                <span class="k">if</span> <span class="n">estimate</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">need_hostnames</span> \
                   <span class="ow">and</span> <span class="ow">not</span> <span class="s">&#39;hostnames&#39;</span> <span class="ow">in</span> <span class="n">criteria</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%r</span><span class="s"> is missing &#39;hostnames&#39;&quot;</span><span class="p">,</span>
                                       <span class="n">allocator</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">best_estimate</span> <span class="o">=</span> <span class="n">estimate</span>
                    <span class="n">best_criteria</span> <span class="o">=</span> <span class="n">criteria</span>
                    <span class="n">best_allocator</span> <span class="o">=</span> <span class="n">allocator</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">best_estimate</span><span class="p">,</span> <span class="n">best_criteria</span><span class="p">,</span> <span class="n">best_allocator</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ResourceAllocationManager.release"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocationManager.release">[docs]</a>    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="n">server</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Release a server (proxy).</span>

<span class="sd">        server: :class:`OpenMDAO_Proxy`</span>
<span class="sd">            Server to be released.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ram</span> <span class="o">=</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_get_instance</span><span class="p">()</span>
        <span class="c"># Lock in _release() so we don&#39;t keep the lock unnecessarily.</span>
        <span class="k">return</span> <span class="n">ram</span><span class="o">.</span><span class="n">_release</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Release a server (proxy). &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">allocator</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">server_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deployed_servers</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">server</span><span class="p">)]</span>
            <span class="c"># Just being defensive.</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;server </span><span class="si">%r</span><span class="s"> not found&#39;</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deployed_servers</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">server</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;release </span><span class="si">%r</span><span class="s"> pid </span><span class="si">%d</span><span class="s"> on </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">server_info</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span>
                          <span class="n">server_info</span><span class="p">[</span><span class="s">&#39;pid&#39;</span><span class="p">],</span> <span class="n">server_info</span><span class="p">[</span><span class="s">&#39;host&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">allocator</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
        <span class="c"># Just being defensive.</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Can&#39;t release </span><span class="si">%r</span><span class="s">: </span><span class="si">%r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">server_info</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="n">exc</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">_close</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ResourceAllocationManager.add_remotes"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocationManager.add_remotes">[docs]</a>    <span class="k">def</span> <span class="nf">add_remotes</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add allocators from a remote server to the list of resource allocators.</span>

<span class="sd">        server: proxy for a remote server</span>
<span class="sd">            The server whose allocators are to be added.</span>
<span class="sd">            It must support :meth:`get_ram`, which should return the server&#39;s</span>
<span class="sd">            `ResourceAllocationManager` and a `host` attribute.</span>

<span class="sd">        prefix: string</span>
<span class="sd">            Prefix for the local names of the remote allocators.</span>
<span class="sd">            The default is the remote hostname.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">remote_ram</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">get_ram</span><span class="p">()</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">remote_ram</span><span class="o">.</span><span class="n">get_total_allocators</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_make_prefix</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
        <span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total</span><span class="p">):</span>
            <span class="n">allocator</span> <span class="o">=</span> <span class="n">remote_ram</span><span class="o">.</span><span class="n">get_allocator_proxy</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="n">RemoteAllocator</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">allocator</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                                    <span class="n">allocator</span><span class="p">)</span>
            <span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
        <span class="n">ram</span> <span class="o">=</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_get_instance</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">ram</span><span class="o">.</span><span class="n">_allocators</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">proxies</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_make_prefix</span><span class="p">(</span><span class="n">hostid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return legal prefix based on `hostid`. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">_IPV4_HOST</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">hostid</span><span class="p">):</span>  <span class="c"># Use all digits to be unique.</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">hostid</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c"># IP hostname (letters, digits, and hyphen are legal).</span>
            <span class="n">prefix</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">hostid</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prefix</span>

    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="ResourceAllocationManager.get_total_allocators"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocationManager.get_total_allocators">[docs]</a>    <span class="k">def</span> <span class="nf">get_total_allocators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return number of allocators for remote use. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_allocators</span><span class="p">)</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="n">proxy_types</span><span class="o">=</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span>
<div class="viewcode-block" id="ResourceAllocationManager.get_allocator_proxy"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocationManager.get_allocator_proxy">[docs]</a>    <span class="k">def</span> <span class="nf">get_allocator_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return allocator for remote use.</span>

<span class="sd">        index: int</span>
<span class="sd">            Index of the allocator to return.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allocators</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ResourceAllocationManager.max_request"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocationManager.max_request">[docs]</a>    <span class="k">def</span> <span class="nf">max_request</span><span class="p">(</span><span class="n">assembly</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the maximum resources requested by `assembly`.</span>

<span class="sd">        Resource descriptions are assumed to be attributes named `resources`.</span>
<span class="sd">        Scans the assembly&#39;s components for resources and determines a &#39;peak&#39;</span>
<span class="sd">        value of requested CPUs and resource limits. This can be used to</span>
<span class="sd">        ensure an allocated server can support the maximum of any resources</span>
<span class="sd">        requested by an assembly&#39;s components.</span>

<span class="sd">        Returns a resource description for the maximum.</span>

<span class="sd">        assembly: :class:`Assembly`</span>
<span class="sd">            Assembly containing components requesting resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">req</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">assembly</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">prefix</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;resources&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_max_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">req</span>
</div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_max_request</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Helper for :meth:`max_request`. &quot;&quot;&quot;</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;min_cpus&#39;</span><span class="p">,</span> <span class="s">&#39;max_cpus&#39;</span><span class="p">,</span> <span class="s">&#39;min_phys_memory&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">new</span><span class="p">:</span>
                <span class="n">req</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">new</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;min_cpus&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;max_cpus&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">req</span><span class="p">[</span><span class="s">&#39;max_cpus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="p">[</span><span class="s">&#39;min_cpus&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s">&#39;resource_limits&#39;</span> <span class="ow">in</span> <span class="n">new</span><span class="p">:</span>
            <span class="n">new_limits</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="s">&#39;resource_limits&#39;</span><span class="p">]</span>
            <span class="n">req_limits</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;resource_limits&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;core_file_size&#39;</span><span class="p">,</span> <span class="s">&#39;data_seg_size&#39;</span><span class="p">,</span> <span class="s">&#39;file_size&#39;</span><span class="p">,</span>
                         <span class="s">&#39;open_files&#39;</span><span class="p">,</span> <span class="s">&#39;stack_size&#39;</span><span class="p">,</span> <span class="s">&#39;virtual_memory&#39;</span><span class="p">,</span>
                         <span class="s">&#39;cpu_time&#39;</span><span class="p">,</span> <span class="s">&#39;wallclock_time&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">new_limits</span><span class="p">:</span>
                    <span class="n">req_limits</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">req_limits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                           <span class="n">new_limits</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
            <span class="n">req</span><span class="p">[</span><span class="s">&#39;resource_limits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">req_limits</span>
        <span class="k">return</span> <span class="n">req</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ResourceAllocationManager.total_request"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocationManager.total_request">[docs]</a>    <span class="k">def</span> <span class="nf">total_request</span><span class="p">(</span><span class="n">assembly</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the total resources requested by `assembly`.</span>

<span class="sd">        Resource descriptions are assumed to be attributes named ``resources``.</span>
<span class="sd">        Scans the assembly&#39;s components for resources and determines a total</span>
<span class="sd">        value of requested run time.  The descriptions are first processed by</span>
<span class="sd">        :meth:`max_request` to set peak values.  Then the descriptions are</span>
<span class="sd">        also checked for queuing compatibility (accounting id, job category,</span>
<span class="sd">        etc).  This can be used to obtain a resource description for running</span>
<span class="sd">        `assembly` as a batch job.</span>

<span class="sd">        Returns a resource description for the total.</span>

<span class="sd">        assembly: :class:`Assembly`</span>
<span class="sd">            Assembly containing components requesting resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">req</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">assembly</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">prefix</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;resources&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_total_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">req</span>
</div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_total_request</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Helper for :meth:`total_request`. &quot;&quot;&quot;</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">_max_request</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>

        <span class="c"># Rerunnable only if all are rerunnable.</span>
        <span class="k">if</span> <span class="s">&#39;rerunnable&#39;</span> <span class="ow">in</span> <span class="n">new</span><span class="p">:</span>
            <span class="n">req</span><span class="p">[</span><span class="s">&#39;rerunnable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;rerunnable&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">and</span> <span class="n">new</span><span class="p">[</span><span class="s">&#39;rerunnable&#39;</span><span class="p">]</span>

        <span class="c"># If specified, these should match.</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;accounting_id&#39;</span><span class="p">,</span> <span class="s">&#39;queue_name&#39;</span><span class="p">,</span> <span class="s">&#39;job_category&#39;</span><span class="p">,</span> <span class="s">&#39;localhost&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">new</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">new</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">!=</span> <span class="n">base</span><span class="p">[</span><span class="n">item</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Incompatible settings for </span><span class="si">%r</span><span class="s">: </span><span class="si">%r</span><span class="s"> vs. </span><span class="si">%r</span><span class="s">&#39;</span>
                                         <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">new</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">base</span><span class="p">[</span><span class="n">item</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">req</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

        <span class="c"># Total time requested.</span>
        <span class="k">if</span> <span class="s">&#39;resource_limits&#39;</span> <span class="ow">in</span> <span class="n">new</span><span class="p">:</span>
            <span class="n">req_limits</span> <span class="o">=</span> <span class="n">req</span><span class="p">[</span><span class="s">&#39;resource_limits&#39;</span><span class="p">]</span>
            <span class="n">new_limits</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="s">&#39;resource_limits&#39;</span><span class="p">]</span>
            <span class="n">base_limits</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;resource_limits&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;cpu_time&#39;</span><span class="p">,</span> <span class="s">&#39;wallclock_time&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">new_limits</span><span class="p">:</span>
                    <span class="n">req_limits</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_limits</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">new_limits</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
            <span class="n">req</span><span class="p">[</span><span class="s">&#39;resource_limits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">req_limits</span>

        <span class="k">return</span> <span class="n">req</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ResourceAllocationManager.validate_resources"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocationManager.validate_resources">[docs]</a>    <span class="k">def</span> <span class="nf">validate_resources</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate that `resource_desc` is legal.</span>

<span class="sd">        resource_desc: dict</span>
<span class="sd">            Description of required resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">resource_desc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_VALIDATORS</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">value</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Invalid resource value for </span><span class="si">%r</span><span class="s">: </span><span class="si">%r</span><span class="s">&#39;</span>
                                     <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;Invalid resource key </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="s">&#39;max_cpus&#39;</span> <span class="ow">in</span> <span class="n">resource_desc</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;min_cpus&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resource_desc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;min_cpus required if max_cpus specified&#39;</span><span class="p">)</span>
            <span class="n">min_cpus</span> <span class="o">=</span> <span class="n">resource_desc</span><span class="p">[</span><span class="s">&#39;min_cpus&#39;</span><span class="p">]</span>
            <span class="n">max_cpus</span> <span class="o">=</span> <span class="n">resource_desc</span><span class="p">[</span><span class="s">&#39;max_cpus&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">max_cpus</span> <span class="o">&lt;</span> <span class="n">min_cpus</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;max_cpus </span><span class="si">%d</span><span class="s"> &lt; min_cpus </span><span class="si">%d</span><span class="s">&#39;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="n">max_cpus</span><span class="p">,</span> <span class="n">min_cpus</span><span class="p">))</span>
</div></div>
<span class="k">def</span> <span class="nf">_true</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Just returns True -- these registered keys need more work. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">_bool</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Validate bool key value. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_datetime</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Validate datetime key value. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_int</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Validate int key value. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_positive</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Validate positive key value. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">_string</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Validate string key value. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_no_whitespace</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Validate no_whitespace key value. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; /t/n&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">_stringlist</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Validate sequence of strings value. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">_allocator</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Validate &#39;allocator&#39; key value. &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">allocator</span> <span class="ow">in</span> <span class="n">ResourceAllocationManager</span><span class="o">.</span><span class="n">list_allocators</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">allocator</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">_job_environment</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Validate &#39;job_environment&#39; key value. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">_job_category</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Validate &#39;job_category&#39; key value. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">JOB_CATEGORIES</span>

<span class="k">def</span> <span class="nf">_resource_limits</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Validate &#39;resource_limits&#39; key value. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">RESOURCE_LIMITS</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="c"># Registry of resource validators.</span>
<span class="n">_VALIDATORS</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;allocator&#39;</span><span class="p">:</span> <span class="n">_allocator</span><span class="p">,</span>
               <span class="s">&#39;localhost&#39;</span><span class="p">:</span> <span class="n">_bool</span><span class="p">,</span>
               <span class="s">&#39;exclude&#39;</span><span class="p">:</span> <span class="n">_stringlist</span><span class="p">,</span>
               <span class="s">&#39;required_distributions&#39;</span><span class="p">:</span> <span class="n">_true</span><span class="p">,</span>
               <span class="s">&#39;orphan_modules&#39;</span><span class="p">:</span> <span class="n">_stringlist</span><span class="p">,</span>
               <span class="s">&#39;python_version&#39;</span><span class="p">:</span> <span class="n">_true</span><span class="p">,</span>
               <span class="s">&#39;python_platform&#39;</span><span class="p">:</span> <span class="n">_true</span><span class="p">,</span>

               <span class="s">&#39;min_cpus&#39;</span><span class="p">:</span> <span class="n">_positive</span><span class="p">,</span>
               <span class="s">&#39;max_cpus&#39;</span><span class="p">:</span> <span class="n">_positive</span><span class="p">,</span>
               <span class="s">&#39;min_phys_memory&#39;</span><span class="p">:</span> <span class="n">_positive</span><span class="p">,</span>

               <span class="s">&#39;remote_command&#39;</span><span class="p">:</span> <span class="n">_no_whitespace</span><span class="p">,</span>
               <span class="s">&#39;args&#39;</span><span class="p">:</span> <span class="n">_stringlist</span><span class="p">,</span>
               <span class="s">&#39;submit_as_hold&#39;</span><span class="p">:</span> <span class="n">_bool</span><span class="p">,</span>
               <span class="s">&#39;rerunnable&#39;</span><span class="p">:</span> <span class="n">_bool</span><span class="p">,</span>
               <span class="s">&#39;job_environment&#39;</span><span class="p">:</span> <span class="n">_job_environment</span><span class="p">,</span>
               <span class="s">&#39;working_directory&#39;</span><span class="p">:</span> <span class="n">_string</span><span class="p">,</span>
               <span class="s">&#39;job_category&#39;</span><span class="p">:</span> <span class="n">_job_category</span><span class="p">,</span>
               <span class="s">&#39;email&#39;</span><span class="p">:</span> <span class="n">_stringlist</span><span class="p">,</span>
               <span class="s">&#39;email_on_started&#39;</span><span class="p">:</span> <span class="n">_bool</span><span class="p">,</span>
               <span class="s">&#39;email_on_terminated&#39;</span><span class="p">:</span> <span class="n">_bool</span><span class="p">,</span>
               <span class="s">&#39;job_name&#39;</span><span class="p">:</span> <span class="n">_string</span><span class="p">,</span>
               <span class="s">&#39;input_path&#39;</span><span class="p">:</span> <span class="n">_string</span><span class="p">,</span>
               <span class="s">&#39;output_path&#39;</span><span class="p">:</span> <span class="n">_string</span><span class="p">,</span>
               <span class="s">&#39;error_path&#39;</span><span class="p">:</span> <span class="n">_string</span><span class="p">,</span>
               <span class="s">&#39;join_files&#39;</span><span class="p">:</span> <span class="n">_bool</span><span class="p">,</span>
               <span class="s">&#39;reservation_id&#39;</span><span class="p">:</span> <span class="n">_no_whitespace</span><span class="p">,</span>
               <span class="s">&#39;queue_name&#39;</span><span class="p">:</span> <span class="n">_no_whitespace</span><span class="p">,</span>
               <span class="s">&#39;priority&#39;</span><span class="p">:</span> <span class="n">_int</span><span class="p">,</span>
               <span class="s">&#39;start_time&#39;</span><span class="p">:</span> <span class="n">_datetime</span><span class="p">,</span>
               <span class="s">&#39;deadline_time&#39;</span><span class="p">:</span> <span class="n">_datetime</span><span class="p">,</span>
               <span class="s">&#39;resource_limits&#39;</span><span class="p">:</span> <span class="n">_resource_limits</span><span class="p">,</span>
               <span class="s">&#39;accounting_id&#39;</span><span class="p">:</span> <span class="n">_no_whitespace</span><span class="p">,</span>
               <span class="s">&#39;native_specification&#39;</span><span class="p">:</span> <span class="n">_stringlist</span><span class="p">}</span>


<div class="viewcode-block" id="ResourceAllocator"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocator">[docs]</a><span class="k">class</span> <span class="nc">ResourceAllocator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for allocators. Allocators estimate the suitability of a</span>
<span class="sd">    resource and can deploy on that resource.</span>

<span class="sd">    name: string</span>
<span class="sd">        Name of allocator; used in log messages, etc.</span>
<span class="sd">        Must be alphanumeric (underscore also allowed).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">_LEGAL_NAME</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s">&#39;name </span><span class="si">%r</span><span class="s"> is not alphanumeric&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="ResourceAllocator.name"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocator.name">[docs]</a>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This allocator&#39;s name. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
</div>
<div class="viewcode-block" id="ResourceAllocator.invalidate"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocator.invalidate">[docs]</a>    <span class="k">def</span> <span class="nf">invalidate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invalidate this allocator. This will be called by the manager when</span>
<span class="sd">        it detects that its allocators are copies due to a process fork.</span>
<span class="sd">        The default implementation does nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span>

    <span class="c"># To be implemented by real allocator.</span></div>
<div class="viewcode-block" id="ResourceAllocator.configure"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocator.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">):</span>  <span class="c">#pragma no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure allocator from :class:`ConfigParser` instance.</span>
<span class="sd">        Normally only called during manager initialization.</span>

<span class="sd">        cfg: :class:`ConfigParser`</span>
<span class="sd">            Configuration data is located under the section matching</span>
<span class="sd">            this allocator&#39;s `name`.</span>

<span class="sd">        The default implementation does nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span>

    <span class="c"># To be implemented by real allocator.</span></div>
<div class="viewcode-block" id="ResourceAllocator.max_servers"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocator.max_servers">[docs]</a>    <span class="k">def</span> <span class="nf">max_servers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">):</span>  <span class="c">#pragma no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the maximum number of servers which could be deployed for</span>
<span class="sd">        `resource_desc`.  The value needn&#39;t be exact, but performance may</span>
<span class="sd">        suffer if it overestimates.  The value is used to limit the number</span>
<span class="sd">        of concurrent evaluations.</span>

<span class="sd">        resource_desc: dict</span>
<span class="sd">            Description of required resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;max_servers&#39;</span><span class="p">)</span>

    <span class="c"># To be implemented by real allocator.</span></div>
<div class="viewcode-block" id="ResourceAllocator.time_estimate"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocator.time_estimate">[docs]</a>    <span class="k">def</span> <span class="nf">time_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">):</span>  <span class="c">#pragma no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return ``(estimate, criteria)`` indicating how well this resource</span>
<span class="sd">        allocator can satisfy the `resource_desc` request.  The estimate will</span>
<span class="sd">        be:</span>

<span class="sd">        - &gt;0 for an estimate of walltime (seconds).</span>
<span class="sd">        -  0 for no estimate.</span>
<span class="sd">        - -1 for no resource at this time.</span>
<span class="sd">        - -2 for no support for `resource_desc`.</span>

<span class="sd">        The returned criteria is a dictionary containing information related</span>
<span class="sd">        to the estimate, such as hostnames, load averages, unsupported</span>
<span class="sd">        resources, etc.</span>

<span class="sd">        resource_desc: dict</span>
<span class="sd">            Description of required resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;time_estimate&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ResourceAllocator.check_compatibility"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocator.check_compatibility">[docs]</a>    <span class="k">def</span> <span class="nf">check_compatibility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check compatibility with common resource attributes.</span>

<span class="sd">        resource_desc: dict</span>
<span class="sd">            Description of required resources.</span>

<span class="sd">        Returns ``(retcode, info)``.  If `retcode` is zero, then `info`</span>
<span class="sd">        is a list of keys in `recource_desc` that have not been processed.</span>
<span class="sd">        Otherwise, `retcode` will be -2 and `info` will be a single-entry</span>
<span class="sd">        dictionary whose key is the incompatible key in `resource_desc`</span>
<span class="sd">        and whose value provides data regarding the incompatibility.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">resource_desc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">QUEUING_SYSTEM_KEYS</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;required_distributions&#39;</span><span class="p">:</span>
                <span class="n">missing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_required_distributions</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="s">&#39;missing </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">missing</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;orphan_modules&#39;</span><span class="p">:</span>
                <span class="n">missing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_orphan_modules</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="s">&#39;missing </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">missing</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;python_version&#39;</span><span class="p">:</span>
                <span class="c"># Require major match, minor request &lt;= system.</span>
                <span class="n">req_ver</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">sys_ver</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys_ver</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">req_ver</span><span class="p">)</span> <span class="ow">or</span> \
                   <span class="n">sys_ver</span> <span class="o">&lt;</span> <span class="n">req_ver</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="n">key</span> <span class="p">:</span> <span class="s">&#39;want </span><span class="si">%s</span><span class="s">, have </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">req_ver</span><span class="p">,</span> <span class="n">sys_ver</span><span class="p">)})</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;exclude&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="n">key</span> <span class="p">:</span> <span class="s">&#39;excluded host </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()})</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;allocator&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="n">key</span> <span class="p">:</span> <span class="s">&#39;wrong allocator&#39;</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ResourceAllocator.check_required_distributions"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocator.check_required_distributions">[docs]</a>    <span class="k">def</span> <span class="nf">check_required_distributions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of distributions that are not available.</span>

<span class="sd">        resource_value: list</span>
<span class="sd">            List of Distributions or Requirements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">required</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">resource_value</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">Distribution</span><span class="p">):</span>
                <span class="n">required</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">as_requirement</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">required</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">check_requirements</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">required</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ResourceAllocator.check_orphan_modules"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocator.check_orphan_modules">[docs]</a>    <span class="k">def</span> <span class="nf">check_orphan_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of &#39;orphan&#39; modules that are not available.</span>

<span class="sd">        resource_value: list</span>
<span class="sd">            List of &#39;orphan&#39; module names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="c">#FIXME: shouldn&#39;t pollute the environment like this does.</span>
        <span class="n">not_found</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">resource_value</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">module</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">__import__</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="n">not_found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">not_found</span>

    <span class="c"># To be implemented by real allocator.</span></div>
<div class="viewcode-block" id="ResourceAllocator.deploy"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocator.deploy">[docs]</a>    <span class="k">def</span> <span class="nf">deploy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">,</span> <span class="n">criteria</span><span class="p">):</span>  <span class="c">#pragma no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deploy a server suitable for `resource_desc`.</span>
<span class="sd">        Returns a proxy to the deployed server.</span>

<span class="sd">        name: string</span>
<span class="sd">            Name for server.</span>

<span class="sd">        resource_desc: dict</span>
<span class="sd">            Description of required resources.</span>

<span class="sd">        criteria: dict</span>
<span class="sd">            The dictionary returned by :meth:`time_estimate`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;deploy&#39;</span><span class="p">)</span>

    <span class="c"># To be implemented by real allocator.</span></div>
<div class="viewcode-block" id="ResourceAllocator.release"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ResourceAllocator.release">[docs]</a>    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">):</span>  <span class="c">#pragma no cover</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shut-down `server`.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Unlike other methods which are protected from multithreaded</span>
<span class="sd">            access by the manager, :meth:`release` must be multithread-safe.</span>

<span class="sd">        server: :class:`ObjServer`</span>
<span class="sd">            Server to be shut down.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;release&#39;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="FactoryAllocator"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.FactoryAllocator">[docs]</a><span class="k">class</span> <span class="nc">FactoryAllocator</span><span class="p">(</span><span class="n">ResourceAllocator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for allocators using :class:`ObjServerFactory`.</span>

<span class="sd">    name: string</span>
<span class="sd">        Name of allocator; used in log messages, etc.</span>

<span class="sd">    authkey: string</span>
<span class="sd">        Authorization key for this allocator and any deployed servers.</span>

<span class="sd">    allow_shell: bool</span>
<span class="sd">        If True, :meth:`execute_command` and :meth:`load_model` are allowed</span>
<span class="sd">        in created servers. Use with caution!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">authkey</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allow_shell</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FactoryAllocator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deployed_servers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">authkey</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">authkey</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">authkey</span>
            <span class="k">if</span> <span class="n">authkey</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">authkey</span> <span class="o">=</span> <span class="s">&#39;PublicKey&#39;</span>
                <span class="n">multiprocessing</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">authkey</span> <span class="o">=</span> <span class="n">authkey</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factory</span> <span class="o">=</span> <span class="n">ObjServerFactory</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">authkey</span><span class="p">,</span> <span class="n">allow_shell</span><span class="p">)</span>

<div class="viewcode-block" id="FactoryAllocator.configure"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.FactoryAllocator.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure allocator from :class:`ConfigParser` instance.</span>
<span class="sd">        Normally only called during manager initialization.</span>

<span class="sd">        cfg: :class:`ConfigParser`</span>
<span class="sd">            Configuration data is located under the section matching</span>
<span class="sd">            this allocator&#39;s `name`.</span>

<span class="sd">        Allows modifying `auth_key` and `allow_shell`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;authkey&#39;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;authkey&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    authkey: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_authkey</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;allow_shell&#39;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;allow_shell&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    allow_shell: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">_allow_shell</span> <span class="o">=</span> <span class="n">value</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="FactoryAllocator.deploy"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.FactoryAllocator.deploy">[docs]</a>    <span class="k">def</span> <span class="nf">deploy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">,</span> <span class="n">criteria</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deploy a server suitable for `resource_desc`.</span>
<span class="sd">        Returns a proxy to the deployed server.</span>

<span class="sd">        name: string</span>
<span class="sd">            Name for server.</span>

<span class="sd">        resource_desc: dict</span>
<span class="sd">            Description of required resources.</span>

<span class="sd">        criteria: dict</span>
<span class="sd">            The dictionary returned by :meth:`time_estimate`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">credentials</span> <span class="o">=</span> <span class="n">get_credentials</span><span class="p">()</span>
        <span class="n">allowed_users</span> <span class="o">=</span> <span class="p">{</span><span class="n">credentials</span><span class="o">.</span><span class="n">user</span><span class="p">:</span> <span class="n">credentials</span><span class="o">.</span><span class="n">public_key</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">typname</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                         <span class="n">res_desc</span><span class="o">=</span><span class="n">resource_desc</span><span class="p">,</span>
                                         <span class="n">allowed_users</span><span class="o">=</span><span class="n">allowed_users</span><span class="p">)</span>
        <span class="c"># Shouldn&#39;t happen...</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;create failed:&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_deployed_servers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">server</span>
</div>
    <span class="nd">@rbac</span><span class="p">((</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="FactoryAllocator.release"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.FactoryAllocator.release">[docs]</a>    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Release `server`.</span>

<span class="sd">        server: typically :class:`ObjServer`</span>
<span class="sd">            Previously deployed server to be shut down.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deployed_servers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="LocalAllocator"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.LocalAllocator">[docs]</a><span class="k">class</span> <span class="nc">LocalAllocator</span><span class="p">(</span><span class="n">FactoryAllocator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Purely local resource allocator.</span>

<span class="sd">    name: string</span>
<span class="sd">        Name of allocator; used in log messages, etc.</span>

<span class="sd">    total_cpus: int</span>
<span class="sd">        If &gt;0, then that is taken as the number of cpus/cores available.</span>
<span class="sd">        Otherwise, the number is taken from :meth:`multiprocessing.cpu_count`.</span>

<span class="sd">    max_load: float</span>
<span class="sd">        Specifies the maximum cpu-adjusted load (obtained from</span>
<span class="sd">        :meth:`os.getloadavg`) allowed when reporting :meth:`max_servers` and</span>
<span class="sd">        when determining if another server may be started in</span>
<span class="sd">        :meth:`time_estimate`.</span>

<span class="sd">    authkey: string</span>
<span class="sd">        Authorization key for this allocator and any deployed servers.</span>

<span class="sd">    allow_shell: bool</span>
<span class="sd">        If True, :meth:`execute_command` and :meth:`load_model` are allowed</span>
<span class="sd">        in created servers. Use with caution!</span>

<span class="sd">    server_limit: int</span>
<span class="sd">        If 0, limit :meth:`max_servers` result to `total_cpus`.</span>
<span class="sd">        If &gt;0, limit to `server_limit`, if &lt;0, no limit to normal calculation.</span>

<span class="sd">    The `max_load` argument is typically used to work around limitations</span>
<span class="sd">    on the number of servers based on system load.  The `server_limit`</span>
<span class="sd">    argument can be used to avoid overcommiting memory, especially if</span>
<span class="sd">    `max_load` has been used to reduce the effect of system load on server</span>
<span class="sd">    count.</span>

<span class="sd">    Resource configuration file entry equivalent to the default</span>
<span class="sd">    `LocalHost` allocator::</span>

<span class="sd">        [LocalHost]</span>
<span class="sd">        classname: openmdao.main.resource.LocalAllocator</span>
<span class="sd">        total_cpus: 1</span>
<span class="sd">        max_load: 1.0</span>
<span class="sd">        server_limit: 0</span>
<span class="sd">        authkey: PublicKey</span>
<span class="sd">        allow_shell: True</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;LocalAllocator&#39;</span><span class="p">,</span> <span class="n">total_cpus</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_load</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">authkey</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allow_shell</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">server_limit</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LocalAllocator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">authkey</span><span class="p">,</span> <span class="n">allow_shell</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_cpus</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total_cpus</span> <span class="o">=</span> <span class="n">total_cpus</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">total_cpus</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
            <span class="c"># Just being defensive (according to docs this could happen).</span>
            <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>  <span class="c"># pragma no cover</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">total_cpus</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">max_load</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_load</span> <span class="o">=</span> <span class="n">max_load</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: max_load must be &gt; 0, got </span><span class="si">%g</span><span class="s">&#39;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">max_load</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_limit</span> <span class="o">=</span> <span class="n">server_limit</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="LocalAllocator.host"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.LocalAllocator.host">[docs]</a>    <span class="k">def</span> <span class="nf">host</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Allocator hostname. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">host</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="LocalAllocator.pid"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.LocalAllocator.pid">[docs]</a>    <span class="k">def</span> <span class="nf">pid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Allocator process ID. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">pid</span>
</div>
<div class="viewcode-block" id="LocalAllocator.configure"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.LocalAllocator.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure allocator from :class:`ConfigParser` instance.</span>
<span class="sd">        Normally only called during manager initialization.</span>

<span class="sd">        cfg: :class:`ConfigParser`</span>
<span class="sd">            Configuration data is located under the section matching</span>
<span class="sd">            this allocator&#39;s `name`.</span>

<span class="sd">        Allows modifying factory options, `total_cpus`, and `max_load`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LocalAllocator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;total_cpus&#39;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;total_cpus&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    total_cpus: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">total_cpus</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: total_cpus must be &gt; 0, got </span><span class="si">%d</span><span class="s">&#39;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;max_load&#39;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;max_load&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    max_load: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_load</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: max_load must be &gt; 0, got </span><span class="si">%g</span><span class="s">&#39;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;server_limit&#39;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;server_limit&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    server_limit: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server_limit</span> <span class="o">=</span> <span class="n">value</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="LocalAllocator.max_servers"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.LocalAllocator.max_servers">[docs]</a>    <span class="k">def</span> <span class="nf">max_servers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">,</span> <span class="n">load_adjusted</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns `total_cpus` * `max_load` if `resource_desc` is supported;</span>
<span class="sd">        otherwise, zero. The return value may be limited by `server_limit`.</span>

<span class="sd">        resource_desc: dict</span>
<span class="sd">            Description of required resources.</span>

<span class="sd">        load_adjusted: bool</span>
<span class="sd">            If True, then the returned number of servers is adjusted for</span>
<span class="sd">            current host loading.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">retcode</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_compatibility</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">retcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

        <span class="n">avail_cpus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_cpus</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_load</span>
        <span class="k">if</span> <span class="n">load_adjusted</span><span class="p">:</span>  <span class="c"># Check system load.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">loadavgs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getloadavg</span><span class="p">()</span>
            <span class="c"># Not available on Windows.</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;loadavgs </span><span class="si">%.2f</span><span class="s">, </span><span class="si">%.2f</span><span class="s">, </span><span class="si">%.2f</span><span class="s">, max_load </span><span class="si">%.2f</span><span class="s">&#39;</span><span class="p">,</span>
                                   <span class="n">loadavgs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">loadavgs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">loadavgs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">max_load</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_cpus</span><span class="p">)</span>
                <span class="n">avail_cpus</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span><span class="n">loadavgs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">avail_cpus</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">avail_cpus</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_limit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">avail_cpus</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">avail_cpus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_cpus</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">avail_cpus</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">avail_cpus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_limit</span><span class="p">)</span>
        <span class="c"># else no special limiting.</span>

        <span class="k">if</span> <span class="s">&#39;min_cpus&#39;</span> <span class="ow">in</span> <span class="n">resource_desc</span><span class="p">:</span>
            <span class="n">req_cpus</span> <span class="o">=</span> <span class="n">resource_desc</span><span class="p">[</span><span class="s">&#39;min_cpus&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">req_cpus</span> <span class="o">&gt;</span> <span class="n">avail_cpus</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;min_cpus&#39;</span><span class="p">:</span> <span class="s">&#39;want </span><span class="si">%s</span><span class="s">, available </span><span class="si">%s</span><span class="s">&#39;</span>
                                        <span class="o">%</span> <span class="p">(</span><span class="n">req_cpus</span><span class="p">,</span> <span class="n">avail_cpus</span><span class="p">)})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">avail_cpus</span> <span class="o">/</span> <span class="n">req_cpus</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">avail_cpus</span><span class="p">,</span> <span class="p">{})</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="LocalAllocator.time_estimate"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.LocalAllocator.time_estimate">[docs]</a>    <span class="k">def</span> <span class="nf">time_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns ``(estimate, criteria)`` indicating how well this allocator can</span>
<span class="sd">        satisfy the `resource_desc` request.  The estimate will be:</span>

<span class="sd">        - &gt;0 for an estimate of walltime (seconds).</span>
<span class="sd">        -  0 for no estimate.</span>
<span class="sd">        - -1 for no resource at this time.</span>
<span class="sd">        - -2 for no support for `resource_desc`.</span>

<span class="sd">        The returned criteria is a dictionary containing information related</span>
<span class="sd">        to the estimate, such as hostnames, load averages, unsupported</span>
<span class="sd">        resources, etc.</span>

<span class="sd">        resource_desc: dict</span>
<span class="sd">            Description of required resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">retcode</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_compatibility</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">retcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">retcode</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

        <span class="c"># Check system load.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">loadavgs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getloadavg</span><span class="p">()</span>
        <span class="c"># Not available on Windows.</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;hostnames&#39;</span>  <span class="p">:</span> <span class="p">[</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()],</span>
                <span class="s">&#39;total_cpus&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_cpus</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">criteria</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;loadavgs </span><span class="si">%.2f</span><span class="s">, </span><span class="si">%.2f</span><span class="s">, </span><span class="si">%.2f</span><span class="s">, max_load </span><span class="si">%.2f</span><span class="s">&#39;</span><span class="p">,</span>
                           <span class="n">loadavgs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">loadavgs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">loadavgs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">max_load</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_cpus</span><span class="p">)</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;hostnames&#39;</span>  <span class="p">:</span> <span class="p">[</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()],</span>
            <span class="s">&#39;loadavgs&#39;</span>   <span class="p">:</span> <span class="n">loadavgs</span><span class="p">,</span>
            <span class="s">&#39;total_cpus&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_cpus</span><span class="p">,</span>
            <span class="s">&#39;max_load&#39;</span>   <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_load</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">loadavgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_cpus</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_load</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">criteria</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deployed_servers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># Ensure progress by always allowing 1 server.</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">criteria</span><span class="p">)</span>
        <span class="c"># Tests force max_load high to avoid other issues.</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c">#pragma no cover</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">criteria</span><span class="p">)</span>  <span class="c"># Try again later.</span>
</div>
<div class="viewcode-block" id="LocalAllocator.check_compatibility"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.LocalAllocator.check_compatibility">[docs]</a>    <span class="k">def</span> <span class="nf">check_compatibility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check compatibility with resource attributes.</span>

<span class="sd">        resource_desc: dict</span>
<span class="sd">            Description of required resources.</span>

<span class="sd">        Returns ``(retcode, info)``. If Compatible, then `retcode` is zero</span>
<span class="sd">        and `info` is empty. Otherwise, `retcode` will be -2 and `info` will</span>
<span class="sd">        be a single-entry dictionary whose key is the incompatible key in</span>
<span class="sd">        `resource_desc` and whose value provides data regarding the incompatibility.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">retcode</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> \
            <span class="nb">super</span><span class="p">(</span><span class="n">LocalAllocator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">check_compatibility</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">retcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">retcode</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">resource_desc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;localhost&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="s">&#39;requested remote host&#39;</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;min_cpus&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_cpus</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="s">&#39;want </span><span class="si">%s</span><span class="s">, have </span><span class="si">%s</span><span class="s">&#39;</span>
                                      <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_cpus</span><span class="p">)})</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{})</span>
</div></div>
<span class="n">register</span><span class="p">(</span><span class="n">LocalAllocator</span><span class="p">,</span> <span class="n">mp_distributing</span><span class="o">.</span><span class="n">Cluster</span><span class="p">)</span>
<span class="n">register</span><span class="p">(</span><span class="n">LocalAllocator</span><span class="p">,</span> <span class="n">mp_distributing</span><span class="o">.</span><span class="n">HostManager</span><span class="p">)</span>


<div class="viewcode-block" id="RemoteAllocator"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.RemoteAllocator">[docs]</a><span class="k">class</span> <span class="nc">RemoteAllocator</span><span class="p">(</span><span class="n">ResourceAllocator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allocator which delegates to a remote allocator.</span>
<span class="sd">    Configuration of remote allocators is not allowed.</span>

<span class="sd">    name: string</span>
<span class="sd">        Local name for allocator.</span>

<span class="sd">    remote: proxy</span>
<span class="sd">        Proxy for remote allocator.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">remote</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RemoteAllocator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remote</span> <span class="o">=</span> <span class="n">remote</span>

    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="RemoteAllocator.max_servers"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.RemoteAllocator.max_servers">[docs]</a>    <span class="k">def</span> <span class="nf">max_servers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return maximum number of servers for remote allocator. &quot;&quot;&quot;</span>
        <span class="n">rdesc</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_local</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rdesc</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote</span><span class="o">.</span><span class="n">max_servers</span><span class="p">(</span><span class="n">rdesc</span><span class="p">)</span>
</div>
    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="RemoteAllocator.time_estimate"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.RemoteAllocator.time_estimate">[docs]</a>    <span class="k">def</span> <span class="nf">time_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the time estimate from the remote allocator. &quot;&quot;&quot;</span>
        <span class="n">rdesc</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_local</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rdesc</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">info</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote</span><span class="o">.</span><span class="n">time_estimate</span><span class="p">(</span><span class="n">rdesc</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_check_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check locally-relevant resources. &quot;&quot;&quot;</span>
        <span class="n">rdesc</span> <span class="o">=</span> <span class="n">resource_desc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="s">&#39;allocator&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rdesc</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">rdesc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;localhost&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="s">&#39;requested local host&#39;</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;allocator&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="s">&#39;wrong allocator&#39;</span><span class="p">})</span>
            <span class="k">del</span> <span class="n">rdesc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">rdesc</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="nd">@rbac</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="RemoteAllocator.deploy"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.RemoteAllocator.deploy">[docs]</a>    <span class="k">def</span> <span class="nf">deploy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">,</span> <span class="n">criteria</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Deploy on the remote allocator. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">,</span> <span class="n">criteria</span><span class="p">)</span>
</div>
    <span class="nd">@rbac</span><span class="p">((</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="RemoteAllocator.release"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.RemoteAllocator.release">[docs]</a>    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Release a remotely allocated server. &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>  <span class="c"># Proxies are not thread-safe.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_remote</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>


<span class="c"># Cluster allocation requires ssh configuration and multiple hosts.</span></div></div>
<div class="viewcode-block" id="ClusterAllocator"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ClusterAllocator">[docs]</a><span class="k">class</span> <span class="nc">ClusterAllocator</span><span class="p">(</span><span class="n">ResourceAllocator</span><span class="p">):</span>  <span class="c">#pragma no cover</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cluster-based resource allocator.  This allocator manages a collection</span>
<span class="sd">    of :class:`LocalAllocator`, one for each machine in the cluster.</span>

<span class="sd">    name: string</span>
<span class="sd">        Name of allocator; used in log messages, etc.</span>

<span class="sd">    machines: list(:class:`ClusterHost`)</span>
<span class="sd">        Hosts to allocate from.</span>

<span class="sd">    authkey: string</span>
<span class="sd">        Authorization key to be passed-on to remote servers.</span>

<span class="sd">    allow_shell: bool</span>
<span class="sd">        If True, :meth:`execute_command` and :meth:`load_model` are allowed</span>
<span class="sd">        in created servers. Use with caution!</span>

<span class="sd">    method: string</span>
<span class="sd">        Must be one of ``load-average``, ``greedy``, or ``round-robin``.</span>

<span class="sd">    ``load-average`` uses the load averages reported by each machine&#39;s</span>
<span class="sd">    local allocator to determine the least-loaded machine(s) and allocates</span>
<span class="sd">    on those. We assume that machines in the cluster are similar enough that</span>
<span class="sd">    ranking by load average is reasonable.</span>

<span class="sd">    ``greedy`` allocates N1 servers from the first machine, then</span>
<span class="sd">    N2 from the second machine, etc. where N is the number of cpus on</span>
<span class="sd">    a machine.</span>

<span class="sd">    ``round-robin`` allocates one server from the first machine,</span>
<span class="sd">    then 1 server from the second machine, etc. Note that this can result in</span>
<span class="sd">    an unbalanced load if the machines have different numbers of cpus.</span>

<span class="sd">    The ``greedy`` and ``round-robin`` methods have lower overhead but may</span>
<span class="sd">    allocate a server on a mchine that is already overloaded based on other</span>
<span class="sd">    user&#39;s activity. They do however avoid problems where load averages don&#39;t</span>
<span class="sd">    reflect loads added by previous allocations quickly enough.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_methods</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c"># Selection methods.</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">machines</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">authkey</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allow_shell</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">method</span><span class="o">=</span><span class="s">&#39;load-average&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;method argument </span><span class="si">%r</span><span class="s"> not one of </span><span class="si">%s</span><span class="s">&#39;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">ClusterAllocator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">authkey</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">authkey</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">authkey</span>
            <span class="k">if</span> <span class="n">authkey</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">authkey</span> <span class="o">=</span> <span class="s">&#39;PublicKey&#39;</span>
                <span class="n">multiprocessing</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">authkey</span> <span class="o">=</span> <span class="n">authkey</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span> <span class="o">=</span> <span class="n">authkey</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_shell</span> <span class="o">=</span> <span class="n">allow_shell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_deployed</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deployed_servers</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">machines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span><span class="p">(</span><span class="n">machines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machines</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Setup allocators on the given machines. &quot;&quot;&quot;</span>
        <span class="n">hostnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">hosts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">host</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">machines</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ClusterHost</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Expecting ClusterHost for machine </span><span class="si">%s</span><span class="s">, got </span><span class="si">%r</span><span class="s">&#39;</span>
                                <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">host</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">host</span><span class="o">.</span><span class="n">hostname</span> <span class="ow">in</span> <span class="n">hostnames</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Ignoring duplicate hostname </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span>
                                     <span class="n">host</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">hostnames</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span>
            <span class="n">host</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">LocalAllocator</span><span class="p">)</span>
            <span class="n">hosts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span> <span class="o">=</span> <span class="n">mp_distributing</span><span class="o">.</span><span class="n">Cluster</span><span class="p">(</span><span class="n">hosts</span><span class="p">,</span> <span class="n">authkey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span><span class="p">,</span>
                                               <span class="n">allow_shell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_allow_shell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;server listening on </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">address</span><span class="p">,))</span>

        <span class="n">la_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">:</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">manager</span>
            <span class="n">la_name</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">netname</span>
            <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;.&#39;</span><span class="p">):</span>
                <span class="n">la_name</span> <span class="o">=</span> <span class="n">la_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">la_name</span> <span class="ow">in</span> <span class="n">la_names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;skipping duplicate </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">la_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">allocator</span> <span class="o">=</span> \
                    <span class="n">manager</span><span class="o">.</span><span class="n">openmdao_main_resource_LocalAllocator</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">la_name</span><span class="p">,</span>
                                                  <span class="n">allow_shell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_allow_shell</span><span class="p">)</span>
                <span class="n">host</span><span class="o">.</span><span class="n">allocator</span> <span class="o">=</span> <span class="n">allocator</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;allocator </span><span class="si">%r</span><span class="s"> pid </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">la_name</span><span class="p">,</span> <span class="n">allocator</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">)</span>

<div class="viewcode-block" id="ClusterAllocator.configure"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ClusterAllocator.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure a cluster consisting of hosts with node-numbered hostnames</span>
<span class="sd">        all using the same Python executable. Hostnames are generated from</span>
<span class="sd">        `origin` to `nhosts`+`origin` from `format` (`origin` defaults to 0).</span>
<span class="sd">        The Python executable is specified by the `python` option. It defaults</span>
<span class="sd">        to the currently executing Python.</span>

<span class="sd">        Resource configuration file entry for a cluster named `HX` consisting</span>
<span class="sd">        of 19 hosts with the first host named `hx00` and using the current</span>
<span class="sd">        OpenMDAO Python::</span>

<span class="sd">            [HX]</span>
<span class="sd">            classname: openmdao.main.resource.ClusterAllocator</span>
<span class="sd">            nhosts: 19</span>
<span class="sd">            origin: 0</span>
<span class="sd">            format: hx%02d</span>
<span class="sd">            authkey: PublicKey</span>
<span class="sd">            allow_shell: True</span>
<span class="sd">            method: load-average</span>
<span class="sd">            tunnel_incoming: False</span>
<span class="sd">            tunnel_outgoing: False</span>
<span class="sd">            identity_filename: ~/.ssh/example.pem</span>

<span class="sd">        An example entry for an &#39;ad-hoc&#39; cluster where the names don&#39;t have a</span>
<span class="sd">        particular pattern or the configuration of hosts is not uniform::</span>

<span class="sd">            [Ad_hoc_cluster]</span>
<span class="sd">            classname: openmdao.main.resource.ClusterAllocator</span>
<span class="sd">            authkey: PublicKey</span>
<span class="sd">            allow_shell: True</span>
<span class="sd">            method: load-average</span>
<span class="sd">            hosts: havoc.grc.nasa.gov viper.grc.nasa.gov</span>

<span class="sd">            [havoc.grc.nasa.gov]</span>
<span class="sd">            python: /OpenMDAO/dev/setowns1/OpenMDAO-Framework/devenv/bin/python</span>

<span class="sd">            [viper.grc.nasa.gov]</span>
<span class="sd">            python: OpenMDAO-Framework/devenv/bin/python</span>
<span class="sd">            tunnel_incoming: True</span>
<span class="sd">            tunnel_outgoing: True</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;authkey&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;authkey&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    authkey: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authkey</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;allow_shell&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_allow_shell</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;allow_shell&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    allow_shell: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_shell</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;method&#39;</span><span class="p">):</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;method&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;method specification </span><span class="si">%r</span><span class="s"> not one of </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                                   <span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">=</span> <span class="n">method</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    method: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span><span class="p">)</span>

        <span class="c"># ClusterHost arguments.</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;python&#39;</span><span class="p">):</span>
            <span class="n">python</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;python&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">python</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    python: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">python</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;tunnel_incoming&#39;</span><span class="p">):</span>
            <span class="n">tunnel_incoming</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;tunnel_incoming&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    tunnel_incoming: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">tunnel_incoming</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tunnel_incoming</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;tunnel_outgoing&#39;</span><span class="p">):</span>
            <span class="n">tunnel_outgoing</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;tunnel_outgoing&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    tunnel_outgoing: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">tunnel_outgoing</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tunnel_outgoing</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;identity_filename&#39;</span><span class="p">):</span>
            <span class="n">identity_filename</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;identity_filename&#39;</span><span class="p">)</span>
            <span class="n">identity_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">identity_filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">identity_filename</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    identity_filename: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                                   <span class="n">identity_filename</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;identity_filename </span><span class="si">%r</span><span class="s"> not found&#39;</span><span class="p">,</span>
                                   <span class="n">identity_filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">identity_filename</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">machines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;hosts&#39;</span><span class="p">):</span>
            <span class="n">hostnames</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;hosts&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">hostname</span> <span class="ow">in</span> <span class="n">hostnames</span><span class="p">:</span>
                <span class="n">_python</span> <span class="o">=</span> <span class="n">python</span>
                <span class="n">_incoming</span> <span class="o">=</span> <span class="n">tunnel_incoming</span>
                <span class="n">_outgoing</span> <span class="o">=</span> <span class="n">tunnel_outgoing</span>
                <span class="n">_identity</span> <span class="o">=</span> <span class="n">identity_filename</span>

                <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">hostname</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;hostname </span><span class="si">%s</span><span class="s">:&#39;</span><span class="p">,</span> <span class="n">hostname</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="s">&#39;python&#39;</span><span class="p">):</span>
                        <span class="n">_python</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="s">&#39;python&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    python: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">_python</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="s">&#39;tunnel_incoming&#39;</span><span class="p">):</span>
                        <span class="n">_incoming</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="s">&#39;tunnel_incoming&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    tunnel_incoming: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">_incoming</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="s">&#39;tunnel_outgoing&#39;</span><span class="p">):</span>
                        <span class="n">_outgoing</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="s">&#39;tunnel_outgoing&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    tunnel_outgoing: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">_outgoing</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="s">&#39;identity_filename&#39;</span><span class="p">):</span>
                        <span class="n">_identity</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="s">&#39;identity_filename&#39;</span><span class="p">)</span>
                        <span class="n">_identity</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">_identity</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_identity</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    identity_filename: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                                               <span class="n">_identity</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;identity_filename </span><span class="si">%r</span><span class="s"> not found&#39;</span><span class="p">,</span>
                                               <span class="n">_identity</span><span class="p">)</span>

                <span class="n">machines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ClusterHost</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span> <span class="n">python</span><span class="o">=</span><span class="n">_python</span><span class="p">,</span>
                                            <span class="n">tunnel_incoming</span><span class="o">=</span><span class="n">_incoming</span><span class="p">,</span>
                                            <span class="n">tunnel_outgoing</span><span class="o">=</span><span class="n">_outgoing</span><span class="p">,</span>
                                            <span class="n">identity_filename</span><span class="o">=</span><span class="n">_identity</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nhosts</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;nhosts&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    nhosts: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">nhosts</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;origin&#39;</span><span class="p">):</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;origin&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    origin: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>

            <span class="n">pattern</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;format&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;    format: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">nhosts</span><span class="o">+</span><span class="n">origin</span><span class="p">):</span>
                <span class="n">hostname</span> <span class="o">=</span> <span class="n">pattern</span> <span class="o">%</span> <span class="n">i</span>
                <span class="n">machines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ClusterHost</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span> <span class="n">python</span><span class="o">=</span><span class="n">python</span><span class="p">,</span>
                                            <span class="n">tunnel_incoming</span><span class="o">=</span><span class="n">tunnel_incoming</span><span class="p">,</span>
                                            <span class="n">tunnel_outgoing</span><span class="o">=</span><span class="n">tunnel_outgoing</span><span class="p">,</span>
                                            <span class="n">identity_filename</span><span class="o">=</span><span class="n">identity_filename</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span><span class="p">(</span><span class="n">machines</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ClusterAllocator.max_servers"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ClusterAllocator.max_servers">[docs]</a>    <span class="k">def</span> <span class="nf">max_servers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the total of :meth:`max_servers` across all</span>
<span class="sd">        :class:`LocalAllocator` in the cluster.</span>

<span class="sd">        resource_desc: dict</span>
<span class="sd">            Description of required resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">credentials</span> <span class="o">=</span> <span class="n">get_credentials</span><span class="p">()</span>

        <span class="n">rdesc</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_local</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rdesc</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="c"># Drain _reply_q.</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="c"># Get counts via worker threads.</span>
            <span class="n">todo</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">max_workers</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">host</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">):</span>
                <span class="n">allocator</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">allocator</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_workers</span><span class="p">:</span>
                    <span class="n">worker_q</span> <span class="o">=</span> <span class="n">WorkerPool</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="n">worker_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_count</span><span class="p">,</span>
                                  <span class="p">(</span><span class="n">allocator</span><span class="p">,</span> <span class="n">rdesc</span><span class="p">,</span> <span class="n">credentials</span><span class="p">),</span>
                                  <span class="p">{},</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">todo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">allocator</span><span class="p">)</span>

            <span class="c"># Process counts.</span>
            <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">)):</span>
                <span class="n">worker_q</span><span class="p">,</span> <span class="n">retval</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">exc</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">next_allocator</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="n">WorkerPool</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">worker_q</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">worker_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_count</span><span class="p">,</span>
                                  <span class="p">(</span><span class="n">next_allocator</span><span class="p">,</span> <span class="n">rdesc</span><span class="p">,</span> <span class="n">credentials</span><span class="p">),</span>
                                  <span class="p">{},</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q</span><span class="p">))</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">retval</span>
                <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
                    <span class="n">total</span> <span class="o">+=</span> <span class="n">count</span>

            <span class="k">if</span> <span class="s">&#39;min_cpus&#39;</span> <span class="ow">in</span> <span class="n">resource_desc</span><span class="p">:</span>
                <span class="n">req_cpus</span> <span class="o">=</span> <span class="n">resource_desc</span><span class="p">[</span><span class="s">&#39;min_cpus&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">req_cpus</span> <span class="o">&gt;</span> <span class="n">total</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;min_cpus&#39;</span><span class="p">:</span> <span class="s">&#39;want </span><span class="si">%s</span><span class="s">, total </span><span class="si">%s</span><span class="s">&#39;</span>
                                            <span class="o">%</span> <span class="p">(</span><span class="n">req_cpus</span><span class="p">,</span> <span class="n">total</span><span class="p">)})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">total</span> <span class="o">/</span> <span class="n">req_cpus</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="p">{})</span>
</div>
    <span class="k">def</span> <span class="nf">_get_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allocator</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">,</span> <span class="n">credentials</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get `max_servers` from an allocator. &quot;&quot;&quot;</span>
        <span class="n">set_credentials</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">adjusted</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">==</span> <span class="s">&#39;load-average&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">count</span><span class="p">,</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">allocator</span><span class="o">.</span><span class="n">max_servers</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">,</span>
                                                    <span class="n">load_adjusted</span><span class="o">=</span><span class="n">adjusted</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s"> max_servers() caught exception </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                               <span class="n">allocator</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> incompatible: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                                   <span class="n">allocator</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">criteria</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="ClusterAllocator.time_estimate"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ClusterAllocator.time_estimate">[docs]</a>    <span class="k">def</span> <span class="nf">time_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns ``(estimate, criteria)`` indicating how well this allocator</span>
<span class="sd">        can satisfy the `resource_desc` request.  The estimate will be:</span>

<span class="sd">        - &gt;0 for an estimate of walltime (seconds).</span>
<span class="sd">        -  0 for no estimate.</span>
<span class="sd">        - -1 for no resource at this time.</span>
<span class="sd">        - -2 for no support for `resource_desc`.</span>

<span class="sd">        The returned criteria is a dictionary containing information related</span>
<span class="sd">        to the estimate, such as hostnames, load averages, unsupported</span>
<span class="sd">        resources, etc.</span>

<span class="sd">        This allocator polls each :class:`LocalAllocator` in the cluster</span>
<span class="sd">        to find the best match and returns that.  The best allocator is saved</span>
<span class="sd">        in the returned criteria for a subsequent :meth:`deploy`.</span>

<span class="sd">        resource_desc: dict</span>
<span class="sd">            Description of required resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rdesc</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_local</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rdesc</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">info</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_method</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdesc</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_check_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check locally-relevant resources. &quot;&quot;&quot;</span>
        <span class="n">rdesc</span> <span class="o">=</span> <span class="n">resource_desc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="s">&#39;allocator&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rdesc</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">rdesc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;localhost&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="s">&#39;requested local host&#39;</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;allocator&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="s">&#39;wrong allocator&#39;</span><span class="p">})</span>
            <span class="k">del</span> <span class="n">rdesc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">rdesc</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_average</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdesc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Time estimate using load averages. &quot;&quot;&quot;</span>
        <span class="n">credentials</span> <span class="o">=</span> <span class="n">get_credentials</span><span class="p">()</span>

        <span class="n">min_cpus</span> <span class="o">=</span> <span class="n">rdesc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;min_cpus&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">min_cpus</span><span class="p">:</span>
            <span class="c"># Spread across LocalAllocators.</span>
            <span class="n">rdesc</span><span class="p">[</span><span class="s">&#39;min_cpus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">avail_cpus</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">best_host</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">best_estimate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
            <span class="n">best_criteria</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;&#39;</span><span class="p">:</span> <span class="s">&#39;No LocalAllocator results&#39;</span><span class="p">}</span>

            <span class="c"># Prefer not to repeat use of just-used allocator.</span>
            <span class="n">prev_host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_deployed</span>
            <span class="n">prev_estimate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
            <span class="n">prev_criteria</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_deployed</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="c"># Drain _reply_q.</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="c"># Get estimates via worker threads.</span>
            <span class="n">todo</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">max_workers</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">host</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_workers</span><span class="p">:</span>
                    <span class="n">worker_q</span> <span class="o">=</span> <span class="n">WorkerPool</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="n">worker_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_estimate</span><span class="p">,</span>
                                  <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">rdesc</span><span class="p">,</span> <span class="n">credentials</span><span class="p">),</span>
                                  <span class="p">{},</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">todo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>

            <span class="c"># Process estimates.</span>
            <span class="n">host_loads</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c"># Sorted list of (load, criteria)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">)):</span>
                <span class="n">worker_q</span><span class="p">,</span> <span class="n">retval</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                    <span class="n">retval</span> <span class="o">=</span> <span class="bp">None</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">next_host</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="n">WorkerPool</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">worker_q</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">worker_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_estimate</span><span class="p">,</span>
                                  <span class="p">(</span><span class="n">next_host</span><span class="p">,</span> <span class="n">rdesc</span><span class="p">,</span> <span class="n">credentials</span><span class="p">),</span>
                                  <span class="p">{},</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reply_q</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">host</span><span class="p">,</span> <span class="n">estimate</span><span class="p">,</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">retval</span>
                <span class="k">if</span> <span class="n">estimate</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">estimate</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c"># Accumulate available cpus in cluster.</span>
                <span class="n">avail_cpus</span> <span class="o">+=</span> <span class="n">criteria</span><span class="p">[</span><span class="s">&#39;total_cpus&#39;</span><span class="p">]</span>

                <span class="c"># CPU-adjusted load (if available).</span>
                <span class="k">if</span> <span class="s">&#39;loadavgs&#39;</span> <span class="ow">in</span> <span class="n">criteria</span><span class="p">:</span>
                    <span class="n">load</span> <span class="o">=</span> <span class="n">criteria</span><span class="p">[</span><span class="s">&#39;loadavgs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">criteria</span><span class="p">[</span><span class="s">&#39;total_cpus&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c"># Windows</span>
                    <span class="n">load</span> <span class="o">=</span> <span class="mf">0.</span>

                <span class="c"># Insertion sort of host_loads.</span>
                <span class="k">if</span> <span class="n">estimate</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">min_cpus</span><span class="p">:</span>
                    <span class="n">new_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">load</span><span class="p">,</span> <span class="n">criteria</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">host_loads</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">host_loads</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">load</span> <span class="o">&lt;</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="n">host_loads</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">new_info</span><span class="p">)</span>
                                <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">host_loads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_info</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">host_loads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_info</span><span class="p">)</span>

                <span class="c"># Update best estimate.</span>
                <span class="k">if</span> <span class="n">host</span> <span class="ow">is</span> <span class="n">prev_host</span><span class="p">:</span>
                    <span class="n">prev_estimate</span> <span class="o">=</span> <span class="n">estimate</span>
                    <span class="n">prev_criteria</span> <span class="o">=</span> <span class="n">criteria</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">best_estimate</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">estimate</span> <span class="o">&gt;</span> <span class="n">best_estimate</span><span class="p">)</span> <span class="ow">or</span> \
                     <span class="p">(</span><span class="n">best_estimate</span> <span class="o">&gt;</span>  <span class="mi">0</span> <span class="ow">and</span> <span class="n">estimate</span> <span class="o">&lt;</span> <span class="n">best_estimate</span><span class="p">):</span>
                    <span class="n">best_host</span> <span class="o">=</span> <span class="n">host</span>
                    <span class="n">best_estimate</span> <span class="o">=</span> <span class="n">estimate</span>
                    <span class="n">best_criteria</span> <span class="o">=</span> <span class="n">criteria</span>
                <span class="k">elif</span> <span class="n">best_estimate</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">estimate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">&#39;loadavgs&#39;</span> <span class="ow">in</span> <span class="n">best_criteria</span><span class="p">:</span>
                        <span class="n">best_load</span> <span class="o">=</span> <span class="n">best_criteria</span><span class="p">[</span><span class="s">&#39;loadavgs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">load</span> <span class="o">&lt;</span> <span class="n">best_load</span><span class="p">:</span>
                            <span class="n">best_host</span> <span class="o">=</span> <span class="n">host</span>
                            <span class="n">best_estimate</span> <span class="o">=</span> <span class="n">estimate</span>
                            <span class="n">best_criteria</span> <span class="o">=</span> <span class="n">criteria</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s">&#39;loadavgs&#39;</span> <span class="ow">in</span> <span class="n">criteria</span><span class="p">:</span>  <span class="c"># Prefer non-Windows.</span>
                            <span class="n">best_host</span> <span class="o">=</span> <span class="n">host</span>
                            <span class="n">best_estimate</span> <span class="o">=</span> <span class="n">estimate</span>
                            <span class="n">best_criteria</span> <span class="o">=</span> <span class="n">criteria</span>

            <span class="c"># If no alternative, repeat use of previous host.</span>
            <span class="k">if</span> <span class="n">best_estimate</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">prev_estimate</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">best_host</span> <span class="o">=</span> <span class="n">prev_host</span>
                <span class="n">best_estimate</span> <span class="o">=</span> <span class="n">prev_estimate</span>
                <span class="n">best_criteria</span> <span class="o">=</span> <span class="n">prev_criteria</span>

            <span class="k">if</span> <span class="n">avail_cpus</span> <span class="o">&lt;</span> <span class="n">min_cpus</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;min_cpus&#39;</span><span class="p">:</span> <span class="s">&#39;want </span><span class="si">%d</span><span class="s">, available </span><span class="si">%d</span><span class="s">&#39;</span> \
                                         <span class="o">%</span> <span class="p">(</span><span class="n">min_cpus</span><span class="p">,</span> <span class="n">avail_cpus</span><span class="p">)})</span>

            <span class="c"># Save best host in criteria in case we&#39;re asked to deploy.</span>
            <span class="k">if</span> <span class="n">best_host</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">best_criteria</span><span class="p">[</span><span class="s">&#39;host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_host</span>
                <span class="k">if</span> <span class="n">min_cpus</span><span class="p">:</span>
                    <span class="c"># Save min_cpus hostnames in criteria.</span>
                    <span class="n">hostnames</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">load</span><span class="p">,</span> <span class="n">criteria</span> <span class="ow">in</span> <span class="n">host_loads</span><span class="p">:</span>
                        <span class="n">hostname</span> <span class="o">=</span> <span class="n">criteria</span><span class="p">[</span><span class="s">&#39;hostnames&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">hostnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hostnames</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_cpus</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">total_cpus</span> <span class="o">=</span> <span class="n">criteria</span><span class="p">[</span><span class="s">&#39;total_cpus&#39;</span><span class="p">]</span>
                        <span class="n">max_load</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;max_load&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">load</span> <span class="o">*=</span> <span class="n">total_cpus</span>  <span class="c"># Restore from cpu-adjusted value.</span>
                        <span class="n">max_load</span> <span class="o">*=</span> <span class="n">total_cpus</span>
                        <span class="n">load</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">while</span> <span class="n">load</span> <span class="o">&lt;</span> <span class="n">max_load</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">hostnames</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_cpus</span><span class="p">:</span>
                            <span class="n">hostnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
                            <span class="n">load</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hostnames</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_cpus</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hostnames</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_cpus</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;min_cpus&#39;</span><span class="p">:</span> <span class="s">&#39;want </span><span class="si">%d</span><span class="s">, idle </span><span class="si">%d</span><span class="s">&#39;</span> \
                                                 <span class="o">%</span> <span class="p">(</span><span class="n">min_cpus</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hostnames</span><span class="p">))})</span>
                    <span class="n">best_criteria</span><span class="p">[</span><span class="s">&#39;hostnames&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hostnames</span>

            <span class="k">return</span> <span class="p">(</span><span class="n">best_estimate</span><span class="p">,</span> <span class="n">best_criteria</span><span class="p">)</span>

    <span class="n">_methods</span><span class="p">[</span><span class="s">&#39;load-average&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_load_average</span>

    <span class="k">def</span> <span class="nf">_get_estimate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">,</span> <span class="n">credentials</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get (estimate, criteria) from an allocator. &quot;&quot;&quot;</span>
        <span class="n">set_credentials</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">estimate</span><span class="p">,</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">allocator</span><span class="o">.</span><span class="n">time_estimate</span><span class="p">(</span><span class="n">resource_desc</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s"> time_estimate() caught exception </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                               <span class="n">host</span><span class="o">.</span><span class="n">allocator</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="n">estimate</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">estimate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;loadavgs&#39;</span> <span class="ow">in</span> <span class="n">criteria</span><span class="p">:</span>
                    <span class="n">load</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">criteria</span><span class="p">[</span><span class="s">&#39;loadavgs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">load</span> <span class="o">=</span> <span class="s">&#39;None&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s"> returned </span><span class="si">%g</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">.</span><span class="n">allocator</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                   <span class="n">estimate</span><span class="p">,</span> <span class="n">load</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s"> returned </span><span class="si">%g</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">.</span><span class="n">allocator</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">estimate</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">estimate</span><span class="p">,</span> <span class="n">criteria</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_greedy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdesc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; &#39;time estimate&#39; using greedy selection. &quot;&quot;&quot;</span>
        <span class="c"># Get total_cpus from each allocator.</span>
        <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">host</span><span class="o">.</span><span class="n">total_cpus</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">count</span><span class="p">,</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">allocator</span><span class="o">.</span><span class="n">max_servers</span><span class="p">({})</span>
                <span class="n">host</span><span class="o">.</span><span class="n">total_cpus</span> <span class="o">=</span> <span class="n">count</span>

        <span class="c"># Select first machine found with an (assumed) idle cpu.</span>
        <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">host</span><span class="o">.</span><span class="n">allocated_cpus</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">.</span><span class="n">total_cpus</span><span class="p">:</span>
                <span class="n">allocation_host</span> <span class="o">=</span> <span class="n">host</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c"># No idle cpus.</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;min_cpus&#39;</span><span class="p">:</span> <span class="s">&#39;no idle cpus&#39;</span><span class="p">})</span>

        <span class="c"># Generate hostnames starting at selected machine.</span>
        <span class="n">hostnames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">min_cpus</span> <span class="o">=</span> <span class="n">rdesc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;min_cpus&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">required</span> <span class="o">=</span> <span class="n">min_cpus</span>
        <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">host</span><span class="o">.</span><span class="n">allocated_cpus</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">.</span><span class="n">total_cpus</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">total_cpus</span> <span class="o">-</span> <span class="n">host</span><span class="o">.</span><span class="n">allocated_cpus</span>
                <span class="n">count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">required</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
                    <span class="n">hostnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">netname</span><span class="p">)</span>
                <span class="n">required</span> <span class="o">-=</span> <span class="n">count</span>
                <span class="k">if</span> <span class="n">required</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c"># Insufficient idle cpus.</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;min_cpus&#39;</span><span class="p">:</span> <span class="s">&#39;want </span><span class="si">%d</span><span class="s">, idle </span><span class="si">%d</span><span class="s">&#39;</span> \
                                     <span class="o">%</span> <span class="p">(</span><span class="n">min_cpus</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hostnames</span><span class="p">))})</span>

        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;host&#39;</span><span class="p">:</span> <span class="n">allocation_host</span><span class="p">,</span> <span class="s">&#39;hostnames&#39;</span><span class="p">:</span> <span class="n">hostnames</span><span class="p">})</span>

    <span class="n">_methods</span><span class="p">[</span><span class="s">&#39;greedy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_greedy</span>

    <span class="k">def</span> <span class="nf">_round_robin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdesc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; &#39;time estimate&#39; using round-robin selection. &quot;&quot;&quot;</span>
        <span class="c"># Get total_cpus from each allocator.</span>
        <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">host</span><span class="o">.</span><span class="n">total_cpus</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">count</span><span class="p">,</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">allocator</span><span class="o">.</span><span class="n">max_servers</span><span class="p">({})</span>
                <span class="n">host</span><span class="o">.</span><span class="n">total_cpus</span> <span class="o">=</span> <span class="n">count</span>

        <span class="c"># Select next machine in sequence.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_deployed</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">host</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">host</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_deployed</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">)):</span>
            <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">host</span><span class="o">.</span><span class="n">allocated_cpus</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">.</span><span class="n">total_cpus</span><span class="p">:</span>
                <span class="n">allocation_host</span> <span class="o">=</span> <span class="n">host</span>
                <span class="k">break</span>
            <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c"># No idle cpus.</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;min_cpus&#39;</span><span class="p">:</span> <span class="s">&#39;no idle cpus&#39;</span><span class="p">})</span>

        <span class="c"># Generate hostnames starting at selected machine.</span>
        <span class="n">hostnames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">min_cpus</span> <span class="o">=</span> <span class="n">rdesc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;min_cpus&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">required</span> <span class="o">=</span> <span class="n">min_cpus</span>
        <span class="n">host_added</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">while</span> <span class="n">host_added</span> <span class="ow">and</span> <span class="n">required</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">host_added</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">host</span><span class="o">.</span><span class="n">allocated_cpus</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">.</span><span class="n">total_cpus</span><span class="p">:</span>
                    <span class="n">hostnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">netname</span><span class="p">)</span>
                    <span class="n">host_added</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">required</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">required</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">)</span>
                <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">required</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c"># Insufficient idle cpus.</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;min_cpus&#39;</span><span class="p">:</span> <span class="s">&#39;want </span><span class="si">%d</span><span class="s">, idle </span><span class="si">%d</span><span class="s">&#39;</span> \
                                     <span class="o">%</span> <span class="p">(</span><span class="n">min_cpus</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hostnames</span><span class="p">))})</span>

        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;host&#39;</span><span class="p">:</span> <span class="n">allocation_host</span><span class="p">,</span> <span class="s">&#39;hostnames&#39;</span><span class="p">:</span> <span class="n">hostnames</span><span class="p">})</span>

    <span class="n">_methods</span><span class="p">[</span><span class="s">&#39;round-robin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_round_robin</span>

<div class="viewcode-block" id="ClusterAllocator.deploy"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ClusterAllocator.deploy">[docs]</a>    <span class="k">def</span> <span class="nf">deploy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">,</span> <span class="n">criteria</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deploy a server suitable for `resource_desc`.</span>
<span class="sd">        Uses the host saved in `criteria`.</span>
<span class="sd">        Returns a proxy to the deployed server.</span>

<span class="sd">        name: string</span>
<span class="sd">            Name for server.</span>

<span class="sd">        resource_desc: dict</span>
<span class="sd">            Description of required resources.</span>

<span class="sd">        criteria: dict</span>
<span class="sd">            The dictionary returned by :meth:`time_estimate`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">criteria</span><span class="p">[</span><span class="s">&#39;host&#39;</span><span class="p">]</span>
            <span class="n">host</span><span class="o">.</span><span class="n">allocated_cpus</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_deployed</span> <span class="o">=</span> <span class="n">host</span>
            <span class="k">del</span> <span class="n">criteria</span><span class="p">[</span><span class="s">&#39;host&#39;</span><span class="p">]</span>  <span class="c"># Don&#39;t pass a proxy without a server!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;deploying on </span><span class="si">%r</span><span class="s"> as </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">.</span><span class="n">allocator</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">server</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">allocator</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">resource_desc</span><span class="p">,</span> <span class="n">criteria</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s"> deploy() failed for </span><span class="si">%s</span><span class="s">: </span><span class="si">%r</span><span class="s">&#39;</span><span class="p">,</span>
                               <span class="n">host</span><span class="o">.</span><span class="n">allocator</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">server</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s"> deployment failed for </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                               <span class="n">host</span><span class="o">.</span><span class="n">allocator</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deployed_servers</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">server</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">server</span>
</div>
<div class="viewcode-block" id="ClusterAllocator.release"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ClusterAllocator.release">[docs]</a>    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Release a server (proxy).</span>

<span class="sd">        server: :class:`OpenMDAO_Proxy`</span>
<span class="sd">            Server to be released.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deployed_servers</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">server</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;server </span><span class="si">%r</span><span class="s"> not found&#39;</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deployed_servers</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">server</span><span class="p">)]</span>

        <span class="n">host</span><span class="o">.</span><span class="n">allocated_cpus</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">host</span><span class="o">.</span><span class="n">allocator</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Can&#39;t release </span><span class="si">%r</span><span class="s">: </span><span class="si">%r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">_close</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ClusterAllocator.shutdown"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ClusterAllocator.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Shutdown, releasing resources. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span> <span class="o">=</span> <span class="bp">None</span>


<span class="c"># Cluster allocation requires ssh configuration and multiple hosts.</span></div></div>
<div class="viewcode-block" id="ClusterHost"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.resource.ClusterHost">[docs]</a><span class="k">class</span> <span class="nc">ClusterHost</span><span class="p">(</span><span class="n">mp_distributing</span><span class="o">.</span><span class="n">Host</span><span class="p">):</span>  <span class="c">#pragma no cover</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a host to use as a node in a cluster.</span>

<span class="sd">    hostname: string</span>
<span class="sd">        Name of the host. `ssh` is used to log into the host. To log in as a</span>
<span class="sd">        different user, use a host name of the form: &quot;username@somewhere.org&quot;.</span>

<span class="sd">    python: string</span>
<span class="sd">        Path to the Python command to be used on `hostname`.</span>

<span class="sd">    tunnel_incoming: bool</span>
<span class="sd">        True if we need to set up a tunnel for `hostname` to connect to us.</span>
<span class="sd">        This is the case when a local firewall blocks connections.</span>

<span class="sd">    tunnel_outgoing: bool</span>
<span class="sd">        True if we need to set up a tunnel to connect to `hostname`.</span>
<span class="sd">        This is the case when a remote firewall blocks connections.</span>

<span class="sd">    identity_filename: string</span>
<span class="sd">        Path to optional identity file to pass to ssh.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">python</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tunnel_incoming</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">tunnel_outgoing</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">identity_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ClusterHost</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">python</span><span class="p">,</span> <span class="n">tunnel_incoming</span><span class="p">,</span>
                                          <span class="n">tunnel_outgoing</span><span class="p">,</span> <span class="n">identity_filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">netname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocator</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_cpus</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocated_cpus</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<a href="http://openmdao.org">
 <img src="../../../_static/OpenMDAO_Logo_200w_padded.png"
border="0" alt="OpenMDAO Home"/>
</a>

<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../../index.html">OpenMDAO Documentation v0.13.0</a> &raquo;</li>

          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright none.
      Last updated on Apr 23, 2015.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>