<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Collaborative Optimization (CO) &mdash; OpenMDAO Documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.13.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="OpenMDAO Documentation" href="../../index.html" />
    <link rel="up" title="MDAO Architectures" href="index.html" />
    <link rel="next" title="Setting Up Problems for Automatic Architectures" href="optproblem.html" />
    <link rel="prev" title="Individual Design Feasible (IDF)" href="idf.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="optproblem.html" title="Setting Up Problems for Automatic Architectures"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="idf.html" title="Individual Design Feasible (IDF)"
             accesskey="P">previous</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../index.html">OpenMDAO Documentation v0.13.0</a> &raquo;</li>

          <li><a href="../index.html" >OpenMDAO Tutorials</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">MDAO Architectures</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="collaborative-optimization-co">
<span id="index-0"></span><span id="id1"></span><h1>Collaborative Optimization (CO)<a class="headerlink" href="#collaborative-optimization-co" title="Permalink to this headline">Â¶</a></h1>
<p>Next, we will set up a model that solves the Sellar problem by Collaborative
Optimization (CO). CO is a two-level architecture with three optimizer loops,
one at each discipline, and one acting globally. The global optimizer drives
the design and coupling variables towards an optimal solution that minimizes
the objective while constraining to zero the sum of the squares of the
residuals between the values commanded by the global optimizer and those set
by the local optimizers. Each local optimizer operates on its own
discipline, driving its design variables while minimizing the residual between
the actual value of the design variables and the values commanded by the global
optimizer.</p>
<p>Unlike IDF and MDF, for CO the global optimizer does not work directly with any of the inputs in any of the
disciplines. Instead, the global optimizer works on a set of copies of the global design variables. These
copies are sometimes called <em>targets</em>, and we create a few arrays to hold these target variables. Each discipline
has its own  local optimization which works with the local input associated with the global target. This is all
represented in the figure below, and it&#8217;s a bit of a mess. You can see that it&#8217;s important to separate data
flow and workflow to help keep things manageable.</p>
<div class="figure align-center">
<img alt="Arrows and boxes showing data flow for collaborative optimization" src="../../_images/Arch-CO.png" />
<p class="caption">Data Flow for CO</p>
</div>
<p>The CO model has three optimizers, so there are three workflows. The top level
workflow includes just the two lower level optimizers, and each of those optimizers has a
workflow with just the discipline component. This can be seen in the next figure.</p>
<div class="figure align-center">
<img alt="Rounded and straight-sided rectangles showing the iteration hierarchy of the three workflows for CO" src="../../_images/Arch-CO-OpenMDAO.png" />
<p class="caption">Iteration Hierarchy for CO</p>
</div>
<p>First, we define the global target variables, create the component instances,
and set up this iteration hierarchy. Pay special attention to how we define the
variables. Notice that the <cite>iotype</cite> metadata is not set at all. Normally
you would set <tt class="docutils literal"><span class="pre">iotype=&quot;in&quot;</span></tt> or <tt class="docutils literal"><span class="pre">iotype=&quot;out&quot;</span></tt> when you create a variable. In this
case, the variables are neither inputs nor outputs to the assembly. Instead, they are
meant only to be internal variables, varied by the top level driver and used
in the lower level optimization objectives. Hence, no iotype is set.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">openmdao.lib.datatypes.api</span> <span class="kn">import</span> <span class="n">Array</span>
<span class="kn">from</span> <span class="nn">openmdao.main.api</span> <span class="kn">import</span> <span class="n">Assembly</span><span class="p">,</span> <span class="n">set_as_top</span>
<span class="kn">from</span> <span class="nn">openmdao.lib.drivers.api</span> <span class="kn">import</span> <span class="n">SLSQPdriver</span>
<span class="kn">from</span> <span class="nn">openmdao.lib.optproblems</span> <span class="kn">import</span> <span class="n">sellar</span>


<span class="k">class</span> <span class="nc">SellarCO</span><span class="p">(</span><span class="n">Assembly</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Solution of the sellar analytical problem using CO.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">global_des_var_targets</span> <span class="o">=</span> <span class="n">Array</span><span class="p">([</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">2.0</span><span class="p">],</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">)</span>
    <span class="n">local_des_var_targets</span> <span class="o">=</span> <span class="n">Array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,],</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">)</span>
    <span class="n">coupling_var_targets</span> <span class="o">=</span> <span class="n">Array</span><span class="p">([</span><span class="mf">3.16</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># Global Optimization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;driver&#39;</span><span class="p">,</span> <span class="n">SLSQPdriver</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;localopt1&#39;</span><span class="p">,</span> <span class="n">SLSQPdriver</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;localopt2&#39;</span><span class="p">,</span> <span class="n">SLSQPdriver</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="s">&#39;localopt1&#39;</span><span class="p">,</span> <span class="s">&#39;localopt2&#39;</span><span class="p">])</span>

        <span class="c"># Local Optimization 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;dis1&#39;</span><span class="p">,</span> <span class="n">sellar</span><span class="o">.</span><span class="n">Discipline1</span><span class="p">())</span>

        <span class="c"># Local Optimization 2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;dis2&#39;</span><span class="p">,</span> <span class="n">sellar</span><span class="o">.</span><span class="n">Discipline2</span><span class="p">())</span>
</pre></div>
</div>
<p>Since there are no data connections, we never need to call <tt class="docutils literal"><span class="pre">self.connect</span></tt>.</p>
<p>Now we need to set up the parameters for the outer optimization loop.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#Parameters - Global Optimization</span>
<span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="s">&#39;(local_des_var_targets[0])**2 + global_des_var_targets[1] + coupling_var_targets[0] + math.exp(-coupling_var_targets[1])&#39;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s">&#39;global_des_var_targets[0]&#39;</span><span class="p">,</span> <span class="n">low</span><span class="o">=-</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s">&#39;global_des_var_targets[1]&#39;</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>   <span class="n">high</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>

<span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s">&#39;coupling_var_targets[0]&#39;</span><span class="p">,</span> <span class="n">low</span><span class="o">=-</span><span class="mf">1e99</span><span class="p">,</span>  <span class="n">high</span><span class="o">=</span><span class="mf">1e99</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s">&#39;coupling_var_targets[1]&#39;</span><span class="p">,</span> <span class="n">low</span><span class="o">=-</span><span class="mf">1e99</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">1e99</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s">&#39;local_des_var_targets[0]&#39;</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>   <span class="n">high</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>

<span class="n">con1</span> <span class="o">=</span> <span class="s">&#39;(local_des_var_targets[0]-dis1.x1)**2 + &#39;</span> \
       <span class="s">&#39;(global_des_var_targets[0]-dis1.z1)**2 + &#39;</span> \
       <span class="s">&#39;(global_des_var_targets[1]-dis1.z2)**2 + &#39;</span> \
       <span class="s">&#39;(coupling_var_targets[1]-dis1.y2)**2 + &#39;</span> \
       <span class="s">&#39;(coupling_var_targets[0]-dis1.y1)**2 &lt;= .001&#39;</span>

<span class="n">con2</span> <span class="o">=</span> <span class="s">&#39;(global_des_var_targets[0]-dis2.z1)**2 + &#39;</span> \
       <span class="s">&#39;(global_des_var_targets[1]-dis2.z2)**2 + &#39;</span> \
       <span class="s">&#39;(coupling_var_targets[0]-dis2.y1)**2 + &#39;</span> \
       <span class="s">&#39;(coupling_var_targets[1]-dis2.y2)**2 &lt;= .001&#39;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">con1</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">con2</span><span class="p">)</span>

<span class="bp">self</span><span class="o">.</span><span class="n">printvars</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;dis1.y1&#39;</span><span class="p">,</span> <span class="s">&#39;dis2.y2&#39;</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">iprint</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Here we are able to build a complicated expression for the sum of the squares
of all of the residuals and use it as our constraint. This is another
example of a constraint that could be better served as an equality constraint,
but there is some research which indicates the performance of CO can be
improved by switching to an inequality constraint with a small, but non-zero
tolerance. We created two constraints, one for each discipline.</p>
<p>Finally, we set up our local optimization loops.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#Parameters - Local Optimization 1</span>
<span class="sd">&quot;&quot;&quot;self.localopt1.add_objective(&#39;(global_des_var_targets[0]-dis1.z1)**2 + &#39;</span>
<span class="sd">                           &#39;(global_des_var_targets[1]-dis1.z2)**2 + &#39;</span>
<span class="sd">                           &#39;(local_des_var_targets[0]-dis1.x1)**2 + &#39;</span>
<span class="sd">                           &#39;(coupling_var_targets[0]-dis1.y1)**2 + &#39;</span>
<span class="sd">                           &#39;(coupling_var_targets[1]-dis1.y2)**2&#39;)&quot;&quot;&quot;</span>

<span class="bp">self</span><span class="o">.</span><span class="n">localopt1</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="s">&#39;(local_des_var_targets[0]-dis1.x1)**2 + &#39;</span>
                             <span class="s">&#39;(global_des_var_targets[0]-dis1.z1)**2 + &#39;</span>
                             <span class="s">&#39;(global_des_var_targets[1]-dis1.z2)**2 + &#39;</span>
                             <span class="s">&#39;(coupling_var_targets[1]-dis1.y2)**2 + &#39;</span>
                             <span class="s">&#39;(coupling_var_targets[0]-dis1.y1)**2&#39;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">localopt1</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s">&#39;dis1.x1&#39;</span><span class="p">,</span> <span class="n">low</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>   <span class="n">high</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">localopt1</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s">&#39;dis1.z1&#39;</span><span class="p">,</span> <span class="n">low</span> <span class="o">=</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">localopt1</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s">&#39;dis1.z2&#39;</span><span class="p">,</span> <span class="n">low</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>   <span class="n">high</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">localopt1</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s">&#39;dis1.y2&#39;</span><span class="p">,</span> <span class="n">low</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e99</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mf">1e99</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">localopt1</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="s">&#39;3.16 &lt; dis1.y1&#39;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">localopt1</span><span class="o">.</span><span class="n">iprint</span> <span class="o">=</span> <span class="mi">0</span>


<span class="c">#Parameters - Local Optimization 2</span>
<span class="bp">self</span><span class="o">.</span><span class="n">localopt2</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="s">&#39;(global_des_var_targets[0]-dis2.z1)**2 + &#39;</span>
                           <span class="s">&#39;(global_des_var_targets[1]-dis2.z2)**2 + &#39;</span>
                           <span class="s">&#39;(coupling_var_targets[0]-dis2.y1)**2 + &#39;</span>
                           <span class="s">&#39;(coupling_var_targets[1]-dis2.y2)**2&#39;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">localopt2</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s">&#39;dis2.z1&#39;</span><span class="p">,</span> <span class="n">low</span> <span class="o">=</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">localopt2</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s">&#39;dis2.z2&#39;</span><span class="p">,</span> <span class="n">low</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>   <span class="n">high</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">localopt2</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s">&#39;dis2.y1&#39;</span><span class="p">,</span> <span class="n">low</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e99</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="mf">1e99</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">localopt2</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="s">&#39;dis2.y2 &lt; 24.0&#39;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">localopt2</span><span class="o">.</span><span class="n">iprint</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>This problem is contained in
<a class="reference download internal" href="../../_downloads/sellar_CO.py"><tt class="xref download docutils literal"><span class="pre">sellar_CO.py</span></tt></a>.</p>
<p>Executing it at the command line should produce
output that resembles this:</p>
<div class="highlight-python"><div class="highlight"><pre>$ python sellar_CO.py
Minimum found at (1.977769, 0.000000, 0.000000)
Minimum target was at (1.978398, -0.000000, 0.000006)
Couping vars: 3.160216, 3.756415
Couping var targets: 3.160000, 3.756708
Minimum objective:  3.18336051509
Elapsed time:  1.83842110634 seconds
</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<a href="http://openmdao.org">
 <img src="../../_static/OpenMDAO_Logo_200w_padded.png"
border="0" alt="OpenMDAO Home"/>
</a>

  <h4>Previous topic</h4>
  <p class="topless"><a href="idf.html"
                        title="previous chapter">Individual Design Feasible (IDF)</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="optproblem.html"
                        title="next chapter">Setting Up Problems for Automatic Architectures</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/tutorials/mdao/co.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="optproblem.html" title="Setting Up Problems for Automatic Architectures"
             >next</a> |</li>
        <li class="right" >
          <a href="idf.html" title="Individual Design Feasible (IDF)"
             >previous</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../index.html">OpenMDAO Documentation v0.13.0</a> &raquo;</li>

          <li><a href="../index.html" >OpenMDAO Tutorials</a> &raquo;</li>
          <li><a href="index.html" >MDAO Architectures</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright none.
      Last updated on Apr 23, 2015.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>