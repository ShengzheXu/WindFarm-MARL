<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Using a MetaModel Component &mdash; OpenMDAO Documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.13.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="OpenMDAO Documentation" href="../../index.html" />
    <link rel="up" title="MetaModel" href="index.html" />
    <link rel="next" title="Modeling Multiple Outputs" href="mult_outputs.html" />
    <link rel="prev" title="MetaModel" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="mult_outputs.html" title="Modeling Multiple Outputs"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="MetaModel"
             accesskey="P">previous</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../index.html">OpenMDAO Documentation v0.13.0</a> &raquo;</li>

          <li><a href="../index.html" >OpenMDAO Tutorials</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">MetaModel</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="using-a-metamodel-component">
<span id="index-0"></span><span id="id1"></span><h1>Using a MetaModel Component<a class="headerlink" href="#using-a-metamodel-component" title="Permalink to this headline">Â¶</a></h1>
<p>This tutorial is a demonstration of how to construct a MetaModel of a component using a
Kriging surrogate. Generally, MetaModel capabilities are used to construct a
low computational cost replacement for an expensive component. (A more detailed description of
this class can be found under the source documentation for <a class="reference internal" href="../../srcdocs/packages/openmdao.lib.html#metamodel"><em>MetaModel</em></a>.)</p>
<p>For this example, a component was written for the <tt class="docutils literal"><span class="pre">sine</span></tt> function. This component
has only one input and one output, which will be mimicked by the MetaModel. Had
there been additional variables, access to those would also be available
through the MetaModel.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sin</span>

<span class="kn">from</span> <span class="nn">openmdao.lib.casehandlers.api</span> <span class="kn">import</span> <span class="n">DBCaseRecorder</span>
<span class="kn">from</span> <span class="nn">openmdao.lib.components.api</span> <span class="kn">import</span> <span class="n">MetaModel</span>
<span class="kn">from</span> <span class="nn">openmdao.lib.doegenerators.api</span> <span class="kn">import</span> <span class="n">FullFactorial</span><span class="p">,</span> <span class="n">Uniform</span>
<span class="kn">from</span> <span class="nn">openmdao.lib.drivers.api</span> <span class="kn">import</span> <span class="n">DOEdriver</span>
<span class="kn">from</span> <span class="nn">openmdao.lib.surrogatemodels.api</span> <span class="kn">import</span> <span class="n">FloatKrigingSurrogate</span>
<span class="kn">from</span> <span class="nn">openmdao.main.api</span> <span class="kn">import</span> <span class="n">Assembly</span><span class="p">,</span> <span class="n">Component</span><span class="p">,</span> <span class="n">set_as_top</span>
<span class="kn">from</span> <span class="nn">openmdao.main.datatypes.api</span> <span class="kn">import</span> <span class="n">Float</span>


<span class="k">class</span> <span class="nc">Sin</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Simple sine calculation. &#39;&#39;&#39;</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&quot;in&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s">&quot;rad&quot;</span><span class="p">)</span>

    <span class="n">f_x</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&quot;out&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_x</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>To create a MetaModel, we first define an assembly to work in. After we have
created an assembly, the MetaModel component needs to be instantiated. In
this example, the MetaModel was instantiated as <tt class="docutils literal"><span class="pre">sin_meta_model</span></tt>, making it
easy to identify. The inputs to a metamodel are called params, and the
outputs are called responses. When you instantiate a metamodel, you give it a
tuple of params and a tuple of responses that you want it to model.</p>
<p>The next step is to fill the <tt class="docutils literal"><span class="pre">default_surrogate</span></tt> Slot. In this case we set
it to KrigingSurrogate, meaning that all outputs will be modeled with Kriging
surrogate models, unless otherwise specified. Specific surrogate models can
be specified for specific output variables. We cover that in the next
tutorial.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Simulation</span><span class="p">(</span><span class="n">Assembly</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Top level assembly for MetaModel of a sine component using a</span>
<span class="sd">    Kriging surrogate.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># Our component to be meta-modeled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;sin_calc&quot;</span><span class="p">,</span> <span class="n">Sin</span><span class="p">())</span>

        <span class="c"># Create meta_model for f_x as the response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;sin_meta_model&quot;</span><span class="p">,</span> <span class="n">MetaModel</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="p">),</span>
                                             <span class="n">responses</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;f_x&#39;</span><span class="p">,</span> <span class="p">)))</span>

        <span class="c"># Use Kriging for the f_x output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sin_meta_model</span><span class="o">.</span><span class="n">default_surrogate</span> <span class="o">=</span> <span class="n">FloatKrigingSurrogate</span><span class="p">()</span>
</pre></div>
</div>
<p>Once the <cite>model</cite> and <tt class="docutils literal"><span class="pre">default_surrogate</span></tt> Slots of the MetaModel have been
filled, the MetaModel is ready for training. To do so, we need to feed it
training data. When you create a MetaModel instance, a selection of input and
output variables are created based on the names you gave it in the params and
responses tuples. These variables allow you to operate the metamodel in
<em>training</em> and <em>prediction</em>. So, for sin_calc, the metamodel created the
inputs``params.sin_calc.x`` and <tt class="docutils literal"><span class="pre">responses.sin_calc.f_x</span></tt> which we need to
connect to a source of the training data.</p>
<blockquote>
<div></div></blockquote>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Training the MetaModel</span>
<span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;DOE_Trainer&quot;</span><span class="p">,</span> <span class="n">DOEdriver</span><span class="p">())</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Trainer</span><span class="o">.</span><span class="n">DOEgenerator</span> <span class="o">=</span> <span class="n">FullFactorial</span><span class="p">()</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Trainer</span><span class="o">.</span><span class="n">DOEgenerator</span><span class="o">.</span><span class="n">num_levels</span> <span class="o">=</span> <span class="mi">25</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Trainer</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s">&quot;sin_calc.x&quot;</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Trainer</span><span class="o">.</span><span class="n">add_response</span><span class="p">(</span><span class="s">&#39;sin_calc.f_x&#39;</span><span class="p">)</span>

<span class="c"># Pass training data to the meta model.</span>
<span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;DOE_Trainer.case_inputs.sin_calc.x&#39;</span><span class="p">,</span> <span class="s">&#39;sin_meta_model.params.x&#39;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;DOE_Trainer.case_outputs.sin_calc.f_x&#39;</span><span class="p">,</span> <span class="s">&#39;sin_meta_model.responses.f_x&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case, we&#8217;re going to train with a DOEdriver, called <tt class="docutils literal"><span class="pre">DOE_Trainer</span></tt>.
We specify a FullFactorial DOEgenerator, which creates a set of evenly spaced
points across an interval. We (somewhat arbitrarily) selected 25 points for our training
set, specified by <tt class="docutils literal"><span class="pre">num_levels</span></tt> under the DOEgenerator. The proper training set, is of course,
highly problem dependent. The training interval is based on the low and high values
specified in the <tt class="docutils literal"><span class="pre">add_parameter</span></tt> call.</p>
<p>The first time a MetaModel runs, it trains using the data in the params and
responses variable trees, and then predicts a new response. Thereafter, it
always predicts. The outputs generated by the training run are stored in the
DOE generator in it&#8217;s <tt class="docutils literal"><span class="pre">case_inputs</span></tt> and <tt class="docutils literal"><span class="pre">case_outputs</span></tt> trees..</p>
<p>After you train a MetaModel, you want to do something with it. Here, we just run a simple validation
with another DOEDriver called <tt class="docutils literal"><span class="pre">DOE_Validate</span></tt>. This time, the Uniform DOEGenerator was used. This
provides a random sampling of points from within the range of input variables.  Twenty
validation points are being used in this particular case.</p>
<p>Here, we add a new instance of the sine component called <tt class="docutils literal"><span class="pre">sin_calc</span></tt>,
so we can calculate an actual and a predicted value simultaneously.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Cross-validate the metamodel using random data</span>
<span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;DOE_Validate&quot;</span><span class="p">,</span> <span class="n">DOEdriver</span><span class="p">())</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Validate</span><span class="o">.</span><span class="n">DOEgenerator</span> <span class="o">=</span> <span class="n">Uniform</span><span class="p">()</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Validate</span><span class="o">.</span><span class="n">DOEgenerator</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="mi">100</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Validate</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">((</span><span class="s">&quot;sin_meta_model.x&quot;</span><span class="p">,</span> <span class="s">&quot;sin_calc.x&quot;</span><span class="p">),</span>
                                <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Validate</span><span class="o">.</span><span class="n">add_response</span><span class="p">(</span><span class="s">&quot;sin_calc.f_x&quot;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Validate</span><span class="o">.</span><span class="n">add_response</span><span class="p">(</span><span class="s">&quot;sin_meta_model.f_x&quot;</span><span class="p">)</span>

<span class="c">#Iteration Hierarchy</span>
<span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="s">&#39;DOE_Trainer&#39;</span><span class="p">,</span> <span class="s">&#39;DOE_Validate&#39;</span><span class="p">])</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Trainer</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;sin_calc&#39;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">DOE_Validate</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="s">&#39;sin_calc&#39;</span><span class="p">,</span> <span class="s">&#39;sin_meta_model&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Now, the outputs of the MetaModel will be the predicted values as determined by the surrogate
model.</p>
<p>The last thing we do is specify the workflows which control the
execution order of this example. Remember that the top driver in any assembly must be called
<cite>driver</cite>.  The type of workflow being executed is a sequential workflow,
meaning that is a simple sequence of components.</p>
<p>The following figure visually shows the iteration hierarchy for this
MetaModel. Note that <tt class="docutils literal"><span class="pre">sin_calc</span></tt> appears in two workflows. This is necessary
since in the training workflow it is executed to generate the data that the
metamodel needs for training, and within the prediction workflow, it is run
again for validation with the prediction inputs. Thus it must be added to
each workflow separately.</p>
<div class="figure align-center" id="nn-metamodel-iteration-hierarchy">
<img alt="Figure shows workflows for each of 3 drivers; the workflows contain a total of 2 components" src="../../_images/metamodel_workflow.png" />
<p class="caption">View of the Iteration Hierarchy</p>
</div>
<p>Finally, the first two lines of the following code are required to actually
run the MetaModel. The remaining code is for accessing and printing the data.
Using the data stored in the DOE generators, we can access and print the run
data.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">sim</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">()</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c">#This is how you can access any of the data</span>
    <span class="n">train_inputs</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">DOE_Trainer</span><span class="o">.</span><span class="n">case_inputs</span><span class="o">.</span><span class="n">sin_calc</span><span class="o">.</span><span class="n">x</span>
    <span class="n">train_actual</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">DOE_Trainer</span><span class="o">.</span><span class="n">case_outputs</span><span class="o">.</span><span class="n">sin_calc</span><span class="o">.</span><span class="n">f_x</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">DOE_Validate</span><span class="o">.</span><span class="n">case_inputs</span><span class="o">.</span><span class="n">sin_meta_model</span><span class="o">.</span><span class="n">x</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">DOE_Validate</span><span class="o">.</span><span class="n">case_outputs</span><span class="o">.</span><span class="n">sin_calc</span><span class="o">.</span><span class="n">f_x</span>
    <span class="n">predicted</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">DOE_Validate</span><span class="o">.</span><span class="n">case_outputs</span><span class="o">.</span><span class="n">sin_meta_model</span><span class="o">.</span><span class="n">f_x</span>

    <span class="k">if</span> <span class="s">&#39;--noplot&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">p</span>

        <span class="n">p</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">train_inputs</span><span class="p">,</span> <span class="n">train_actual</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&quot;training data&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">predicted</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&quot;predicted result&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">predicted</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%1.3f</span><span class="s">, </span><span class="si">%1.3f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
<p>To view this example, and try running and modifying the code for yourself, you can download it here:
<a class="reference download internal" href="../../_downloads/krig_sin.py"><tt class="xref download docutils literal"><span class="pre">krig_sin.py</span></tt></a>.</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<a href="http://openmdao.org">
 <img src="../../_static/OpenMDAO_Logo_200w_padded.png"
border="0" alt="OpenMDAO Home"/>
</a>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">MetaModel</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="mult_outputs.html"
                        title="next chapter">Modeling Multiple Outputs</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/tutorials/surrogate/single_output.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="mult_outputs.html" title="Modeling Multiple Outputs"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="MetaModel"
             >previous</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../index.html">OpenMDAO Documentation v0.13.0</a> &raquo;</li>

          <li><a href="../index.html" >OpenMDAO Tutorials</a> &raquo;</li>
          <li><a href="index.html" >MetaModel</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright none.
      Last updated on Apr 23, 2015.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>