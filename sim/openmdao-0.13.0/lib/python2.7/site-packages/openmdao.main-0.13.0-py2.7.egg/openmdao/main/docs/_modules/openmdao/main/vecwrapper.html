<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>openmdao.main.vecwrapper &mdash; OpenMDAO Documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.13.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="OpenMDAO Documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../../index.html">OpenMDAO Documentation v0.13.0</a> &raquo;</li>

          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for openmdao.main.vecwrapper</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">zeros</span>

<span class="kn">from</span> <span class="nn">openmdao.main.mpiwrap</span> <span class="kn">import</span> <span class="n">MPI</span><span class="p">,</span> <span class="n">create_petsc_vec</span><span class="p">,</span> <span class="n">PETSc</span><span class="p">,</span> <span class="n">make_idx_array</span><span class="p">,</span> <span class="n">to_idx_array</span>
<span class="kn">from</span> <span class="nn">openmdao.main.array_helpers</span> <span class="kn">import</span> <span class="n">offset_flat_index</span><span class="p">,</span> \
                                        <span class="n">get_flat_index_start</span><span class="p">,</span> <span class="n">get_val_and_index</span><span class="p">,</span> <span class="n">get_shape</span><span class="p">,</span> \
                                        <span class="n">get_flattened_index</span><span class="p">,</span> <span class="n">to_slice</span><span class="p">,</span> <span class="n">to_indices</span>
<span class="kn">from</span> <span class="nn">openmdao.main.interfaces</span> <span class="kn">import</span> <span class="n">IImplicitComponent</span>
<span class="kn">from</span> <span class="nn">openmdao.main.datatypes.file</span> <span class="kn">import</span> <span class="n">FileRef</span>

<span class="kn">from</span> <span class="nn">openmdao.util.typegroups</span> <span class="kn">import</span> <span class="n">int_types</span>
<span class="kn">from</span> <span class="nn">openmdao.util.graph</span> <span class="kn">import</span> <span class="n">base_var</span>

<span class="n">ViewInfo</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s">&#39;ViewInfo&#39;</span><span class="p">,</span> <span class="s">&#39;view, start, idxs, size, hide&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="VecWrapperBase"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.VecWrapperBase">[docs]</a><span class="k">class</span> <span class="nc">VecWrapperBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A wrapper object for a local vector, a distributed PETSc vector,</span>
<span class="sd">    and info about what var maps to what range within the distributed</span>
<span class="sd">    vector.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span> <span class="c"># dict of ViewInfos</span>

        <span class="c"># create the PETSc vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">petsc_vec</span> <span class="o">=</span> <span class="n">create_petsc_vec</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_map_resids_to_states</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_tuple_members</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_resid</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_resid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_add_tuple_members</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">tups</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add all srcs and dests from var tuples so that views for</span>
<span class="sd">        particular openmdao variables can be accessed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">tups</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c"># src + dests</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_aliasview</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tup</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_aliasview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a view that just points to an existing view using a different</span>
<span class="sd">        name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="n">base</span><span class="p">]</span>
        <span class="n">newinfo</span> <span class="o">=</span> <span class="n">ViewInfo</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">view</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">idxs</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">newinfo</span>

    <span class="k">def</span> <span class="nf">_add_subview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">_var_meta</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">name2collapsed</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">name2collapsed</span>

        <span class="n">sz</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sz</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;noflat&#39;</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s">&#39;flat_idx&#39;</span><span class="p">]</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="n">name2collapsed</span><span class="p">[</span><span class="n">var</span><span class="p">[</span><span class="s">&#39;basevar&#39;</span><span class="p">]]]</span>
            <span class="n">sub_idx</span> <span class="o">=</span> <span class="n">offset_flat_index</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
            <span class="n">substart</span> <span class="o">=</span> <span class="n">get_flat_index_start</span><span class="p">(</span><span class="n">sub_idx</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ViewInfo</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">view</span><span class="p">,</span> <span class="n">substart</span><span class="p">,</span> <span class="n">to_slice</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span>
                                        <span class="nb">len</span><span class="p">(</span><span class="n">to_indices</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">view</span><span class="p">)),</span> <span class="bp">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">sub_idx</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">sz</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;size mismatch: in system </span><span class="si">%s</span><span class="s">, view for </span><span class="si">%s</span><span class="s"> is </span><span class="si">%s</span><span class="s">, idx=</span><span class="si">%s</span><span class="s">, size=</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span>
                                     <span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                                     <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">(</span><span class="n">name</span><span class="p">)),</span>
                                     <span class="n">sub_idx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">sub_idx</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">view</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">view</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">view</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">view</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">flat</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">view</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Array size mis-match in &#39;</span><span class="si">%s</span><span class="s">&#39;. &quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;Initial shape was </span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s">&quot;but found size </span><span class="si">%s</span><span class="s"> at runtime&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;cannot set array </span><span class="si">%s</span><span class="s"> to value:</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
                                    <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">view</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span>

<div class="viewcode-block" id="VecWrapperBase.keys"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.VecWrapperBase.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of names of views.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">hide</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="VecWrapperBase.items"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.VecWrapperBase.items">[docs]</a>    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of (name, view) for each view.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">view</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">hide</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="VecWrapperBase.start"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.VecWrapperBase.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the starting index for the array view belonging</span>
<span class="sd">        to the given name. name may contain array indexing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">start</span>
</div>
<div class="viewcode-block" id="VecWrapperBase.bounds"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.VecWrapperBase.bounds">[docs]</a>    <span class="k">def</span> <span class="nf">bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the bounds corresponding to the slice occupied</span>
<span class="sd">        by the named variable(s) within the flattened array.</span>
<span class="sd">        name may contain array indexing.  Note that if all of the</span>
<span class="sd">        names given are not contiguous, the bounds will encompass</span>
<span class="sd">        the named variables AND any variables between them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="n">names</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">info</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="n">infos</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
        <span class="n">bnds</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="o">+</span><span class="n">i</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">infos</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">bnds</span><span class="p">]),</span> <span class="nb">max</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">bnds</span><span class="p">]))</span>
</div>
<div class="viewcode-block" id="VecWrapperBase.indices"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.VecWrapperBase.indices">[docs]</a>    <span class="k">def</span> <span class="nf">indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the index array corresponding to a single name.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">:</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">scope</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">name2collapsed</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_subview</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_tuple_members</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">make_idx_array</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">start</span><span class="o">+</span><span class="n">size</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="VecWrapperBase.set_to_array"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.VecWrapperBase.set_to_array">[docs]</a>    <span class="k">def</span> <span class="nf">set_to_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">vnames</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pull values for the given set of names out of our array</span>
<span class="sd">        and set them into the given array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">vnames</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">vnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="n">asize</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">size</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">vnames</span><span class="p">:</span>
            <span class="n">array_val</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">end</span> <span class="o">+=</span> <span class="n">array_val</span><span class="o">.</span><span class="n">size</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">asize</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;end index </span><span class="si">%d</span><span class="s"> exceeds size of target array&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">arr</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="n">array_val</span>
            <span class="n">start</span> <span class="o">+=</span> <span class="n">array_val</span><span class="o">.</span><span class="n">size</span>
</div>
<div class="viewcode-block" id="VecWrapperBase.set_from_array"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.VecWrapperBase.set_from_array">[docs]</a>    <span class="k">def</span> <span class="nf">set_from_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">vnames</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pull values for the given set of names out of the array</span>
<span class="sd">        and set them into our array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">asize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">size</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">vnames</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
            <span class="n">end</span> <span class="o">+=</span> <span class="n">size</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">asize</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;end index </span><span class="si">%d</span><span class="s"> exceeds size of target array&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
            <span class="n">start</span> <span class="o">+=</span> <span class="n">size</span>
</div>
    <span class="k">def</span> <span class="nf">_is_var_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">idxs</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">idxs</span><span class="o">.</span><span class="n">step</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">info</span><span class="o">.</span><span class="n">idxs</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">.</span><span class="n">idxs</span><span class="o">.</span><span class="n">start</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">.</span><span class="n">idxs</span><span class="o">.</span><span class="n">stop</span>
            <span class="k">return</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">to_indices</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">idxs</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">idxs</span>

<div class="viewcode-block" id="VecWrapperBase.find_var"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.VecWrapperBase.find_var">[docs]</a>    <span class="k">def</span> <span class="nf">find_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">info</span><span class="o">.</span><span class="n">hide</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_var_idx</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">name</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">hide</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_var_idx</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">name</span>
</div>
<div class="viewcode-block" id="VecWrapperBase.dump"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.VecWrapperBase.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">info</span><span class="o">.</span><span class="n">hide</span><span class="p">:</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s">: (</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">) </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">view</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">idxs</span><span class="p">],</span> <span class="n">info</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                            <span class="n">info</span><span class="o">.</span><span class="n">start</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">view</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">idxs</span><span class="p">]),</span> <span class="n">name</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">petsc_vec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> - petsc sizes: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">petsc_vec</span><span class="o">.</span><span class="n">sizes</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="VecWrapper"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.VecWrapper">[docs]</a><span class="k">class</span> <span class="nc">VecWrapper</span><span class="p">(</span><span class="n">VecWrapperBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">):</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">scope</span>
        <span class="n">name2collapsed</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">name2collapsed</span>
        <span class="n">flat_vars</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">flat_vars</span>
        <span class="n">vector_vars</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">vector_vars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_ordering</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">app_ordering</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span>

        <span class="n">vec_srcs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">vector_vars</span><span class="p">])</span>

        <span class="c"># to detect overlapping index sets, we need all of the subvar bases</span>
        <span class="c"># that are NOT included in the vectors.  If a base IS included in the vectors,</span>
        <span class="c"># then all of its subvars are just subviews of the base view, so no chance</span>
        <span class="c"># of overlapping causing redundant data in the vectors</span>
        <span class="n">bases</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">vec_srcs</span>
                                    <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vec_srcs</span><span class="p">])</span>

        <span class="c"># first, add views for vars whose sizes are added to the total,</span>
        <span class="c"># i.e., either they are basevars or their basevars are not included</span>
        <span class="c"># in the vector.</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ivar</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vector_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">sz</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">local_var_sizes</span><span class="p">[</span><span class="n">rank</span><span class="p">,</span> <span class="n">ivar</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">+=</span> <span class="n">sz</span>
                <span class="c"># store the view, local start idx, and distributed start idx</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ViewInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">start</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">),</span>
                                            <span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

                <span class="n">base</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">bases</span> <span class="ow">and</span> <span class="n">base</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vec_srcs</span><span class="p">:</span>
                    <span class="n">bases</span><span class="p">[</span><span class="n">base</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bases</span><span class="p">[</span><span class="n">base</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c"># check for overlaping subvars</span>
                        <span class="n">idxset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                        <span class="n">bval</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">subname</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">[</span><span class="n">base</span><span class="p">]:</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">get_val_and_index</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">subname</span><span class="p">)</span>
                            <span class="n">idxs</span> <span class="o">=</span> <span class="n">get_flattened_index</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">get_shape</span><span class="p">(</span><span class="n">bval</span><span class="p">),</span> <span class="n">cvt_to_slice</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">idxset</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">idxs</span><span class="p">)):</span>
                                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Subvars </span><span class="si">%s</span><span class="s"> share overlapping indices. Try reformulating the problem to prevent this.&quot;</span> <span class="o">%</span>
                                                   <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">[</span><span class="n">base</span><span class="p">]])</span>
                            <span class="n">idxset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;size mismatch: in system </span><span class="si">%s</span><span class="s"> view for </span><span class="si">%s</span><span class="s"> is </span><span class="si">%s</span><span class="s">, size=</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">],</span><span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
                <span class="n">start</span> <span class="o">+=</span> <span class="n">sz</span>

        <span class="c"># now add views for subvars that are subviews of their</span>
        <span class="c"># basevars</span>
        <span class="k">if</span> <span class="n">vector_vars</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">flat_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vector_vars</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_subview</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c"># TODO: handle cases where we have overlapping subvars but no basevar</span>

    <span class="k">def</span> <span class="nf">_add_resid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">):</span>
        <span class="n">nodemap</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">name2collapsed</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="s">&#39;_comp&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">IImplicitComponent</span><span class="o">.</span><span class="n">providedBy</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">_comp</span><span class="p">):</span>
            <span class="n">cname</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">_comp</span><span class="o">.</span><span class="n">name</span>
            <span class="n">states</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">cname</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">_comp</span><span class="o">.</span><span class="n">list_states</span><span class="p">()]</span>
            <span class="n">resids</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">cname</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">_comp</span><span class="o">.</span><span class="n">list_residuals</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">states</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">resids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">states</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">states</span> <span class="k">if</span> <span class="n">nodemap</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">variables</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>

            <span class="c"># verify contiguous states</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">states</span><span class="p">])</span>

            <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>

            <span class="k">assert</span><span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="n">view</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="n">resids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ViewInfo</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">),</span>
                                             <span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_map_resids_to_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">):</span>
        <span class="c"># add any mappings of residuals to states</span>
        <span class="k">for</span> <span class="n">resid</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">_mapped_resids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">resid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_aliasview</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

<div class="viewcode-block" id="VecWrapper.set_from_scope"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.VecWrapper.set_from_scope">[docs]</a>    <span class="k">def</span> <span class="nf">set_from_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">vnames</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the named values from the given scope and set flattened</span>
<span class="sd">        versions of them in our array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">vnames</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">vnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">vnames</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">vnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">get_flattened_value</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">real</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">get_flattened_value</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">real</span>
</div>
<div class="viewcode-block" id="VecWrapper.set_from_scope_complex"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.VecWrapper.set_from_scope_complex">[docs]</a>    <span class="k">def</span> <span class="nf">set_from_scope_complex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">vnames</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the named values from the given scope and set flattened</span>
<span class="sd">        versions of just the complex portion into our array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">vnames</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">vnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">vnames</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">vnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">get_flattened_value</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">imag</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">get_flattened_value</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">imag</span>
</div>
<div class="viewcode-block" id="VecWrapper.set_to_scope"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.VecWrapper.set_to_scope">[docs]</a>    <span class="k">def</span> <span class="nf">set_to_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">vnames</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pull values for the given set of names out of our array</span>
<span class="sd">        and set them into the given scope.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">vnames</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">vnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">vnames</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">vnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">array_val</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">scope</span><span class="o">.</span><span class="n">set_flattened_value</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">array_val</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">dest</span> <span class="ow">in</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">dest</span> <span class="o">!=</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">scope</span><span class="o">.</span><span class="n">set_flattened_value</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">array_val</span><span class="p">)</span>
                        <span class="c">#print &quot;scope set&quot;, dest, array_val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scope</span><span class="o">.</span><span class="n">set_flattened_value</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
                <span class="c">#print &quot;scope set&quot;, name, self[name]</span>

</div></div>
<div class="viewcode-block" id="InputVecWrapper"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.InputVecWrapper">[docs]</a><span class="k">class</span> <span class="nc">InputVecWrapper</span><span class="p">(</span><span class="n">VecWrapperBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">):</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">scope</span>
        <span class="n">varmeta</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">_var_meta</span>
        <span class="n">name2collapsed</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">name2collapsed</span>
        <span class="n">flat_ins</span> <span class="o">=</span> <span class="n">_filter_flat</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">system</span><span class="o">.</span><span class="n">_owned_args</span><span class="p">)</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

        <span class="c">#print &quot;%s: %s: %s&quot; % (system.name, type(system), flat_ins)</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">simple_subsystems</span><span class="p">():</span>
            <span class="c">#print &quot;SUB %s: %s  _in_nodes = %s&quot; % (sub.name, type(sub),sub._in_nodes)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">vector_vars</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">_in_nodes</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">flat_ins</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">:</span>
                    <span class="n">arg_idx</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">get_distrib_idxs</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">arg_idx</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">sz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg_idx</span><span class="p">)</span> <span class="c">#arg_idx[name])</span>
                    <span class="n">end</span> <span class="o">+=</span> <span class="n">sz</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ViewInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">start</span><span class="p">,</span>
                                                <span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">),</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;size mismatch: in system </span><span class="si">%s</span><span class="s"> view for </span><span class="si">%s</span><span class="s"> is </span><span class="si">%s</span><span class="s">, size=</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span>
                                     <span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">],</span><span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
                    <span class="n">start</span> <span class="o">+=</span> <span class="n">sz</span>

        <span class="n">all_ins</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">simple_subsystems</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sub</span><span class="o">.</span><span class="n">_in_nodes</span><span class="p">:</span>
                <span class="n">all_ins</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

        <span class="c"># now add views for subvars that are subviews of their</span>
        <span class="c"># basevars</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">all_ins</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">varmeta</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">vector_vars</span> <span class="ow">or</span> <span class="n">name2collapsed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;basevar&#39;</span><span class="p">))</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_add_subview</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_map_resids_to_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="InputVecWrapper.get_dests_by_comp"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.InputVecWrapper.get_dests_by_comp">[docs]</a>    <span class="k">def</span> <span class="nf">get_dests_by_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a dict of comp name keyed to a list of input nodes, with</span>
<span class="sd">        any subvars removed that have basevars in the vector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">src</span><span class="p">,</span> <span class="n">dests</span> <span class="o">=</span> <span class="n">node</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dests</span><span class="p">:</span>
                    <span class="n">cname</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">vname</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">cname</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cname</span><span class="p">,</span> <span class="n">in_nodes</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">bases</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">in_nodes</span> <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">ret</span><span class="p">[</span><span class="n">cname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">in_nodes</span>
                             <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">bases</span> <span class="ow">or</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">ret</span>
</div>
<div class="viewcode-block" id="InputVecWrapper.set_to_scope"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.InputVecWrapper.set_to_scope">[docs]</a>    <span class="k">def</span> <span class="nf">set_to_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">vnames</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pull values for the given set of names out of our array</span>
<span class="sd">        and set them into the given scope.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">vnames</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">vnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">vnames</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">vnames</span><span class="p">:</span>
            <span class="n">array_val</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">dest</span> <span class="ow">in</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">scope</span><span class="o">.</span><span class="n">set_flattened_value</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">array_val</span><span class="p">)</span>
                    <span class="c">#print &quot;scope set&quot;, dest, array_val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scope</span><span class="o">.</span><span class="n">set_flattened_value</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">array_val</span><span class="p">)</span>
                <span class="c">#print &quot;scope set&quot;, name, array_val</span>
</div>
<div class="viewcode-block" id="InputVecWrapper.set_to_scope_complex"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.InputVecWrapper.set_to_scope_complex">[docs]</a>    <span class="k">def</span> <span class="nf">set_to_scope_complex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">vnames</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pull values for the given set of names out of our array</span>
<span class="sd">        and set them into the given scope as the complex part of the value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">vnames</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">vnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">vnames</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">vnames</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">dest</span> <span class="ow">in</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s">&#39;[&#39;</span> <span class="ow">in</span> <span class="n">dest</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dest</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">):</span>
                            <span class="n">scope</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">dest</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                      <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">complex128</span><span class="p">))</span>
                    <span class="n">array_val</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">get_flattened_value</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
                    <span class="c"># FIXME: the following is a workaround to prevent double</span>
                    <span class="c">#        perturbations in subassemblies with passthroughs, but</span>
                    <span class="c">#        we need to fix the actual underlying problem at some point.</span>
                    <span class="n">scope</span><span class="o">.</span><span class="n">set_flattened_value</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">array_val</span><span class="o">.</span><span class="n">real</span> <span class="o">+</span> <span class="n">step</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;[&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">):</span>
                        <span class="n">scope</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                  <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">complex128</span><span class="p">))</span>
                <span class="n">array_val</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">get_flattened_value</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="c"># FIXME: the following is a workaround to prevent double</span>
                <span class="c">#        perturbations in subassemblies with passthroughs, but</span>
                <span class="c">#        we need to fix the actual underlying problem at some point.</span>
                <span class="n">scope</span><span class="o">.</span><span class="n">set_flattened_value</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">array_val</span><span class="o">.</span><span class="n">real</span> <span class="o">+</span> <span class="n">step</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="DataTransfer"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.DataTransfer">[docs]</a><span class="k">class</span> <span class="nc">DataTransfer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A wrapper object that manages data transfer between</span>
<span class="sd">    systems via scatters (and possibly send/receive for</span>
<span class="sd">    non-array values)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">var_idxs</span><span class="p">,</span> <span class="n">input_idxs</span><span class="p">,</span>
                 <span class="n">scatter_conns</span><span class="p">,</span> <span class="n">noflat_vars</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scatter</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scatter_conns</span> <span class="o">=</span> <span class="n">scatter_conns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noflat_vars</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">noflat_vars</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">MPI</span> <span class="ow">or</span> <span class="n">scatter_conns</span> <span class="ow">or</span> <span class="n">noflat_vars</span><span class="p">):</span>
            <span class="k">return</span>  <span class="c"># no data to xfer</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">var_idxs</span><span class="p">,</span> <span class="n">input_idxs</span> <span class="o">=</span> <span class="n">merge_idxs</span><span class="p">(</span><span class="n">var_idxs</span><span class="p">,</span> <span class="n">input_idxs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;ERROR creating scatter for system </span><span class="si">%s</span><span class="s"> in scope </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">scope</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">var_idxs</span> <span class="o">=</span> <span class="n">to_slice</span><span class="p">(</span><span class="n">var_idxs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_idxs</span> <span class="o">=</span> <span class="n">to_slice</span><span class="p">(</span><span class="n">input_idxs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_idxs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_idxs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;ERROR: creating scatter (index size mismatch): (</span><span class="si">%d</span><span class="s"> != </span><span class="si">%d</span><span class="s">) srcs: </span><span class="si">%s</span><span class="s">,  dest: </span><span class="si">%s</span><span class="s"> in </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">var_idxs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_idxs</span><span class="p">),</span>
                                  <span class="n">var_idxs</span><span class="p">,</span> <span class="n">input_idxs</span><span class="p">,</span> <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">MPI</span><span class="p">:</span>
            <span class="n">var_idx_set</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">IS</span><span class="p">()</span><span class="o">.</span><span class="n">createGeneral</span><span class="p">(</span><span class="n">var_idxs</span><span class="p">,</span>
                                                   <span class="n">comm</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">comm</span><span class="p">)</span>
            <span class="n">input_idx_set</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">IS</span><span class="p">()</span><span class="o">.</span><span class="n">createGeneral</span><span class="p">(</span><span class="n">input_idxs</span><span class="p">,</span>
                                                     <span class="n">comm</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">comm</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">system</span><span class="o">.</span><span class="n">app_ordering</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">var_idx_set</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">app_ordering</span><span class="o">.</span><span class="n">app2petsc</span><span class="p">(</span><span class="n">var_idx_set</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c"># note that scatter created here can be reused for other vectors as long</span>
                <span class="c"># as their sizes are the same as &#39;u&#39; and &#39;p&#39;</span>
                <span class="c"># print &quot;PETSC srcs: %s&quot; % var_idx_set.indices</span>
                <span class="c"># print &quot;PETSC dests: %s&quot; % input_idx_set.indices</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scatter</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Scatter</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">vec</span><span class="p">[</span><span class="s">&#39;u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">petsc_vec</span><span class="p">,</span> <span class="n">var_idx_set</span><span class="p">,</span>
                                                      <span class="n">system</span><span class="o">.</span><span class="n">vec</span><span class="p">[</span><span class="s">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">petsc_vec</span><span class="p">,</span> <span class="n">input_idx_set</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;ERROR in </span><span class="si">%s</span><span class="s"> (var_idxs=</span><span class="si">%s</span><span class="s">, input_idxs=</span><span class="si">%s</span><span class="s">, usize=</span><span class="si">%d</span><span class="s">, psize=</span><span class="si">%d</span><span class="s">): </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                                      <span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">var_idxs</span><span class="p">,</span> <span class="n">input_idxs</span><span class="p">,</span> <span class="n">system</span><span class="o">.</span><span class="n">vec</span><span class="p">[</span><span class="s">&#39;u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                       <span class="n">system</span><span class="o">.</span><span class="n">vec</span><span class="p">[</span><span class="s">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c"># serial execution</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_idxs</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_idxs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scatter</span> <span class="o">=</span> <span class="n">SerialScatter</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">vec</span><span class="p">[</span><span class="s">&#39;u&#39;</span><span class="p">],</span> <span class="n">var_idxs</span><span class="p">,</span>
                                             <span class="n">system</span><span class="o">.</span><span class="n">vec</span><span class="p">[</span><span class="s">&#39;p&#39;</span><span class="p">],</span> <span class="n">input_idxs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">srcvec</span><span class="p">,</span> <span class="n">destvec</span><span class="p">,</span> <span class="n">complex_step</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This performs the data transfer via petsc scatter, local get/set,</span>
<span class="sd">        or MPI object send/recv.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scatter</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">noflat_vars</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">MPI</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">srcvec</span><span class="o">.</span><span class="n">petsc_vec</span>
            <span class="n">dest</span> <span class="o">=</span> <span class="n">destvec</span><span class="o">.</span><span class="n">petsc_vec</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">srcvec</span><span class="o">.</span><span class="n">array</span>
            <span class="n">dest</span> <span class="o">=</span> <span class="n">destvec</span><span class="o">.</span><span class="n">array</span>

        <span class="n">addv</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">complex_step</span> <span class="ow">and</span> <span class="n">system</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;adjoint&#39;</span> <span class="ow">and</span> <span class="n">srcvec</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;du&#39;</span><span class="p">):</span>
            <span class="n">addv</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">destvec</span><span class="p">,</span> <span class="n">srcvec</span> <span class="o">=</span> <span class="n">srcvec</span><span class="p">,</span> <span class="n">destvec</span>
            <span class="n">dest</span><span class="p">,</span> <span class="n">src</span> <span class="o">=</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scatter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scatter</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">addv</span><span class="o">=</span><span class="n">addv</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">destvec</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.p&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">noflat_vars</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">MPI</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">isrc</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">noflat_vars</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">noflat_vars</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">src</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">actives</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
                                         <span class="k">if</span> <span class="n">system</span><span class="o">.</span><span class="n">noflat_isactive</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">isrc</span><span class="p">]]</span>
                    <span class="n">inactives</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">actives</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">inactives</span><span class="p">:</span>
                        <span class="c"># if there are some inactive procs and we are the</span>
                        <span class="c"># lowest rank active proc, send our value to each</span>
                        <span class="c"># inactive proc</span>
                        <span class="k">if</span> <span class="n">system</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">actives</span><span class="p">):</span>
                            <span class="c"># grab local scope value</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_attr_w_copy</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                            <span class="c"># FIXME: FileRef handling in MPI still doesn&#39;t work</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">FileRef</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">owner</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                                    <span class="n">val</span><span class="o">.</span><span class="n">set_owner_by_name</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">system</span><span class="o">.</span><span class="n">scope</span><span class="p">)</span>
                                <span class="n">val</span><span class="o">.</span><span class="n">_abspath</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">abspath</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">inactive</span> <span class="ow">in</span> <span class="n">inactives</span><span class="p">:</span>
                                <span class="n">system</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">inactive</span><span class="p">,</span>
                                                     <span class="n">tag</span><span class="o">=</span><span class="n">isrc</span><span class="p">)</span>
                        <span class="c"># if we&#39;re one of the inactives, pull value across using MPI</span>
                        <span class="k">elif</span> <span class="n">system</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">rank</span> <span class="ow">in</span> <span class="n">inactives</span><span class="p">:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">mpi</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">actives</span><span class="p">),</span> <span class="n">tag</span><span class="o">=</span><span class="n">isrc</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">FileRef</span><span class="p">):</span>
                                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">_abspath</span>
                        <span class="c"># otherwise just use our local scope value</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_attr_w_copy</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_attr_w_copy</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

                    <span class="c"># do the local set</span>
                    <span class="k">for</span> <span class="n">dest</span> <span class="ow">in</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">dest</span> <span class="o">!=</span> <span class="n">src</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">system</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="n">system</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">reraise_exception</span><span class="p">(</span><span class="s">&quot;cannot set &#39;</span><span class="si">%s</span><span class="s">&#39; from &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span>
                                                               <span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">),</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dests</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">noflat_vars</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">dest</span> <span class="ow">in</span> <span class="n">dests</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">src</span> <span class="o">!=</span> <span class="n">dest</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">system</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span>
                                                 <span class="n">system</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">get_attr_w_copy</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="n">system</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">reraise_exception</span><span class="p">(</span><span class="s">&quot;cannot set &#39;</span><span class="si">%s</span><span class="s">&#39; from &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span>
                                                               <span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">),</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>

<div class="viewcode-block" id="DataTransfer.dump"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.DataTransfer.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">srcvec</span><span class="p">,</span> <span class="n">destvec</span><span class="p">,</span> <span class="n">nest</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">scatter_conns</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="o">*</span><span class="n">nest</span><span class="p">)</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Scatters for </span><span class="si">%s</span><span class="s">:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">system</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="o">*</span><span class="n">nest</span><span class="p">)</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;scatter vars: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scatter_conns</span><span class="p">))</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="o">*</span><span class="n">nest</span><span class="p">)</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> --&gt; </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_idxs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_idxs</span><span class="p">))</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="o">*</span><span class="n">nest</span><span class="p">)</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;local array = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">srcvec</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
        <span class="n">var_idxs</span> <span class="o">=</span> <span class="n">to_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_idxs</span><span class="p">,</span> <span class="n">zeros</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">local_var_sizes</span><span class="p">)))</span>
        <span class="n">input_idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_idxs</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="o">*</span><span class="n">nest</span><span class="p">)</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> --&gt; </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var_idxs</span><span class="p">,</span> <span class="n">input_idxs</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">MPI</span> <span class="ow">and</span> <span class="n">system</span><span class="o">.</span><span class="n">app_ordering</span><span class="p">:</span>
            <span class="n">var_idx_set</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">app_ordering</span><span class="o">.</span><span class="n">app2petsc</span><span class="p">(</span><span class="n">var_idxs</span><span class="p">)</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="o">*</span><span class="n">nest</span><span class="p">)</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;(petsc): </span><span class="si">%s</span><span class="s"> --&gt; </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var_idx_set</span><span class="p">,</span> <span class="n">input_idxs</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noflat_vars</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="o">*</span><span class="n">nest</span><span class="p">)</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;no-flats: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">noflat_vars</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="SerialScatter"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.SerialScatter">[docs]</a><span class="k">class</span> <span class="nc">SerialScatter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srcvec</span><span class="p">,</span> <span class="n">src_idxs</span><span class="p">,</span> <span class="n">destvec</span><span class="p">,</span> <span class="n">dest_idxs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_idxs</span> <span class="o">=</span> <span class="n">to_slice</span><span class="p">(</span><span class="n">src_idxs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dest_idxs</span> <span class="o">=</span> <span class="n">to_slice</span><span class="p">(</span><span class="n">dest_idxs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">svec</span> <span class="o">=</span> <span class="n">srcvec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dvec</span> <span class="o">=</span> <span class="n">destvec</span>

<div class="viewcode-block" id="SerialScatter.scatter"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.SerialScatter.scatter">[docs]</a>    <span class="k">def</span> <span class="nf">scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srcvec</span><span class="p">,</span> <span class="n">destvec</span><span class="p">,</span> <span class="n">addv</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">addv</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">destvec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">src_idxs</span><span class="p">]</span> <span class="o">+=</span> <span class="n">srcvec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_idxs</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">destvec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_idxs</span><span class="p">]</span> <span class="o">=</span> <span class="n">srcvec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">src_idxs</span><span class="p">]</span>
</div></div>
<div class="viewcode-block" id="merge_idxs"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.merge_idxs">[docs]</a><span class="k">def</span> <span class="nf">merge_idxs</span><span class="p">(</span><span class="n">src_idxs</span><span class="p">,</span> <span class="n">dest_idxs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return source and destination index arrays, built up from</span>
<span class="sd">    smaller index arrays and combined in order of ascending source</span>
<span class="sd">    index (to allow us to convert src indices to a slice in some cases).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">src_idxs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dest_idxs</span><span class="p">))</span>

    <span class="c"># filter out any zero length idx array entries</span>
    <span class="n">src_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">src_idxs</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
    <span class="n">dest_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dest_idxs</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">src_idxs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_idx_array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">make_idx_array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">src_tups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">src_idxs</span><span class="p">))</span>

    <span class="n">src_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">src_tups</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

    <span class="n">new_src</span> <span class="o">=</span> <span class="p">[</span><span class="n">idxs</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="n">src_sorted</span><span class="p">]</span>
    <span class="n">new_dest</span> <span class="o">=</span> <span class="p">[</span><span class="n">dest_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="n">src_sorted</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">idx_merge</span><span class="p">(</span><span class="n">new_src</span><span class="p">),</span> <span class="n">idx_merge</span><span class="p">(</span><span class="n">new_dest</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="idx_merge"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.idx_merge">[docs]</a><span class="k">def</span> <span class="nf">idx_merge</span><span class="p">(</span><span class="n">idxs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Combines a mixed iterator of int and iterator indices into an</span>
<span class="sd">    array of int indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">int_types</span><span class="p">)</span> <span class="ow">or</span>
                           <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">int_types</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">idxs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">idxs</span>
</div>
<span class="k">def</span> <span class="nf">_filter</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">lst</span><span class="p">):</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">_filter_subs</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">_filter_flat</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">filtered</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_filter_ignored</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">filtered</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_filter_subs</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a copy of the list with any subvars of basevars in the list</span>
<span class="sd">    removed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bases</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
               <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">lst</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">!=</span> <span class="n">bases</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>

<span class="k">def</span> <span class="nf">_filter_ignored</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">lst</span><span class="p">):</span>
    <span class="c"># Remove any vars that the user designates as &#39;deriv_ignore&#39;</span>
    <span class="n">unignored</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">topvars</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">_system</span><span class="o">.</span><span class="n">vector_vars</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
        <span class="n">collapsed_name</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">name2collapsed</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">collapsed_name</span> <span class="ow">in</span> <span class="n">topvars</span> <span class="ow">and</span> <span class="n">topvars</span><span class="p">[</span><span class="n">collapsed_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;deriv_ignore&#39;</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c"># The user sets &#39;deriv_ignore&#39; in the basevar, so we have to check that for</span>
        <span class="c"># subvars.</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">base_var</span><span class="p">(</span><span class="n">scope</span><span class="o">.</span><span class="n">_depgraph</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">base</span> <span class="o">!=</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">collname</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">name2collapsed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">collname</span> <span class="ow">and</span> <span class="n">collname</span> <span class="ow">in</span> <span class="n">topvars</span> <span class="ow">and</span> \
               <span class="n">topvars</span><span class="p">[</span><span class="n">collname</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;deriv_ignore&#39;</span><span class="p">):</span>
                <span class="k">continue</span>

        <span class="n">unignored</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">unignored</span>

<span class="k">def</span> <span class="nf">_filter_flat</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">lst</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">lst</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">scope</span><span class="o">.</span><span class="n">_var_meta</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;noflat&#39;</span><span class="p">)]</span>

<div class="viewcode-block" id="dedup"><a class="viewcode-back" href="../../../srcdocs/packages/openmdao.main.html#openmdao.main.vecwrapper.dedup">[docs]</a><span class="k">def</span> <span class="nf">dedup</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove duplicates from the list while maintaining original order&quot;&quot;&quot;</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lst</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<a href="http://openmdao.org">
 <img src="../../../_static/OpenMDAO_Logo_200w_padded.png"
border="0" alt="OpenMDAO Home"/>
</a>

<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
  <li><a href="http://openmdao.org">OpenMDAO Home</a> &raquo;</li>
  
        <li><a href="../../../index.html">OpenMDAO Documentation v0.13.0</a> &raquo;</li>

          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright none.
      Last updated on Apr 23, 2015.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>