from Simulator import WindGym
from agent.AgentWrapper import AgentWrapper
from support.GraphComputation import GraphComputation
from support.RewardComputation import RewardWrapper
from datetime import datetime

# todo read exp runner setting from config file
episode = 1
# the data we're going to use is hourly
simTime = 5 * 24
turbineNum = 11

# simm = WindGym(turbineNum=turbineNum)
simm = WindGym(turbineNum=turbineNum, greedy="greedy")

agentWrapper = AgentWrapper()
# agentWrapper.makeAgents(agentNum=turbineNum, type="random")
agentWrapper.makeAgents(agentNum=turbineNum, type="greedy")

# how to make these names?
graphComputer = GraphComputation()
rewardComputer = RewardWrapper()
rewardComputer.makeExpPools(agentNum=turbineNum)

starttime = datetime.now()

for eps in range(0, episode):
    for timeI in range(0, simTime):
        simm.step()

        # Q: where is the filter for state, in simulator or in AgentWrapper?
        # A: query to the simmulator
        # state = simm.makeState()

        # envInfo includes wind and turbine position
        envInfo = simm.makeEnvInfo()

        # a turbine list in a generated by wind-topo order
        instantTopoGraph = graphComputer.getTopoGraph(envInfo)

        for turbineId in instantTopoGraph:
            state = simm.makeState(turbineId)
            action = agentWrapper.doForward(turbineId, state)
            # Q: where to build reward and s'?
            # A: the S_ is the S next time
            reward = simm.miniStep(turbineId, action)
            # state_ = simm.makeState()
            # rewardComputer.store(turbineId, state, action, reward, state_)

    simm.reset()

endtime = datetime.now()


print('total time', (endtime-starttime).seconds)
print(simm.epsTotalPowerRecord)
print(sum(simm.epsTotalPowerRecord)/5)
print(simm.epsEachCount)
